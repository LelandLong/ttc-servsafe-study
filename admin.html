<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | Chef's Kitchen Question Manager</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #F3F4F6;
      --bg-secondary: #FFFFFF;
      --bg-card: #FFFFFF;
      --text-primary: #1F2937;
      --text-secondary: #4B5563;
      --text-muted: #6B7280;
      --border-color: #E5E7EB;
      --shadow-color: rgba(0,0,0,0.1);
      --bg-hover: #f8fafc;
      --bg-input: #FFFFFF;
      --header-from: #1f2937;
      --header-to: #111827;
      --tab-bg: #FFFFFF;
      --tab-active-text: #EA580C;
      --tab-active-border: #F97316;
      --tab-text: #6B7280;
      --tab-hover-text: #374151;
      --stats-bg: #FFFFFF;
    }
    [data-theme="dark"] {
      --bg-primary: #111827;
      --bg-secondary: #1F2937;
      --bg-card: #1F2937;
      --text-primary: #F3F4F6;
      --text-secondary: #D1D5DB;
      --text-muted: #9CA3AF;
      --border-color: #374151;
      --shadow-color: rgba(0,0,0,0.4);
      --bg-hover: #374151;
      --bg-input: #374151;
      --header-from: #0f172a;
      --header-to: #020617;
      --tab-bg: #1F2937;
      --tab-active-text: #FB923C;
      --tab-active-border: #FB923C;
      --tab-text: #9CA3AF;
      --tab-hover-text: #D1D5DB;
      --stats-bg: #1F2937;
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg-primary: #111827;
        --bg-secondary: #1F2937;
        --bg-card: #1F2937;
        --text-primary: #F3F4F6;
        --text-secondary: #D1D5DB;
        --text-muted: #9CA3AF;
        --border-color: #374151;
        --shadow-color: rgba(0,0,0,0.4);
        --bg-hover: #374151;
        --bg-input: #374151;
        --header-from: #0f172a;
        --header-to: #020617;
        --tab-bg: #1F2937;
        --tab-active-text: #FB923C;
        --tab-active-border: #FB923C;
        --tab-text: #9CA3AF;
        --tab-hover-text: #D1D5DB;
        --stats-bg: #1F2937;
      }
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    .question-row:hover { background-color: var(--bg-hover); }
    .category-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    /* Dark mode overrides for Tailwind utility classes */
    [data-theme="dark"] .bg-white,
    [data-theme="dark"] .bg-gray-100 {
      background-color: var(--bg-card) !important;
    }
    [data-theme="dark"] .bg-gray-50 {
      background-color: var(--bg-hover) !important;
    }
    [data-theme="dark"] .text-gray-900,
    [data-theme="dark"] .text-gray-800,
    [data-theme="dark"] .text-gray-700 {
      color: var(--text-primary) !important;
    }
    [data-theme="dark"] .text-gray-600,
    [data-theme="dark"] .text-gray-500 {
      color: var(--text-secondary) !important;
    }
    [data-theme="dark"] .text-gray-400 {
      color: var(--text-muted) !important;
    }
    [data-theme="dark"] .border-gray-300,
    [data-theme="dark"] .border-gray-200,
    [data-theme="dark"] .border-b,
    [data-theme="dark"] .border {
      border-color: var(--border-color) !important;
    }
    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background-color: var(--bg-input) !important;
      color: var(--text-primary) !important;
      border-color: var(--border-color) !important;
    }
    [data-theme="dark"] .shadow-sm,
    [data-theme="dark"] .shadow-2xl {
      box-shadow: 0 1px 3px var(--shadow-color) !important;
    }
    [data-theme="dark"] .hover\:bg-gray-50:hover {
      background-color: var(--bg-hover) !important;
    }
    [data-theme="dark"] .question-row:hover {
      background-color: var(--bg-hover) !important;
    }
    /* Dark mode: colored backgrounds & gradients */
    [data-theme="dark"] .from-blue-50,
    [data-theme="dark"] .to-green-50,
    [data-theme="dark"] .bg-blue-50,
    [data-theme="dark"] .bg-green-50,
    [data-theme="dark"] .bg-red-50 {
      background: var(--bg-hover) !important;
    }
    [data-theme="dark"] .bg-gradient-to-r.from-blue-50.to-green-50 {
      background: var(--bg-hover) !important;
    }
    [data-theme="dark"] .bg-green-100 {
      background-color: rgba(34, 197, 94, 0.15) !important;
    }
    [data-theme="dark"] .text-green-800 {
      color: #4ade80 !important;
    }
    [data-theme="dark"] .border-red-300 {
      border-color: #f87171 !important;
    }
    [data-theme="dark"] .text-red-600 {
      color: #f87171 !important;
    }
    [data-theme="dark"] .hover\:bg-red-50:hover {
      background-color: rgba(239, 68, 68, 0.1) !important;
    }
    /* Dark mode: modal stat cards & badges */
    [data-theme="dark"] .bg-orange-50 {
      background-color: rgba(249, 115, 22, 0.1) !important;
    }
    [data-theme="dark"] .bg-purple-50 {
      background-color: rgba(168, 85, 247, 0.1) !important;
    }
    [data-theme="dark"] .bg-yellow-50 {
      background-color: rgba(234, 179, 8, 0.12) !important;
    }
    [data-theme="dark"] .border-yellow-200 {
      border-color: rgba(234, 179, 8, 0.3) !important;
    }
    [data-theme="dark"] .bg-gray-200 {
      background-color: #374151 !important;
    }
    [data-theme="dark"] .modal-overlay {
      background-color: rgba(0, 0, 0, 0.7) !important;
    }
    /* System dark preference fallback */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .bg-white,
      :root:not([data-theme="light"]) .bg-gray-100 {
        background-color: var(--bg-card) !important;
      }
      :root:not([data-theme="light"]) .bg-gray-50 {
        background-color: var(--bg-hover) !important;
      }
      :root:not([data-theme="light"]) .text-gray-900,
      :root:not([data-theme="light"]) .text-gray-800,
      :root:not([data-theme="light"]) .text-gray-700 {
        color: var(--text-primary) !important;
      }
      :root:not([data-theme="light"]) .text-gray-600,
      :root:not([data-theme="light"]) .text-gray-500 {
        color: var(--text-secondary) !important;
      }
      :root:not([data-theme="light"]) .text-gray-400 {
        color: var(--text-muted) !important;
      }
      :root:not([data-theme="light"]) .border-gray-300,
      :root:not([data-theme="light"]) .border-gray-200,
      :root:not([data-theme="light"]) .border-b,
      :root:not([data-theme="light"]) .border {
        border-color: var(--border-color) !important;
      }
      :root:not([data-theme="light"]) input,
      :root:not([data-theme="light"]) select,
      :root:not([data-theme="light"]) textarea {
        background-color: var(--bg-input) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      :root:not([data-theme="light"]) .shadow-sm,
      :root:not([data-theme="light"]) .shadow-2xl {
        box-shadow: 0 1px 3px var(--shadow-color) !important;
      }
      :root:not([data-theme="light"]) .hover\:bg-gray-50:hover {
        background-color: var(--bg-hover) !important;
      }
      :root:not([data-theme="light"]) .question-row:hover {
        background-color: var(--bg-hover) !important;
      }
      :root:not([data-theme="light"]) .from-blue-50,
      :root:not([data-theme="light"]) .to-green-50,
      :root:not([data-theme="light"]) .bg-blue-50,
      :root:not([data-theme="light"]) .bg-green-50,
      :root:not([data-theme="light"]) .bg-red-50 {
        background: var(--bg-hover) !important;
      }
      :root:not([data-theme="light"]) .bg-gradient-to-r.from-blue-50.to-green-50 {
        background: var(--bg-hover) !important;
      }
      :root:not([data-theme="light"]) .bg-green-100 {
        background-color: rgba(34, 197, 94, 0.15) !important;
      }
      :root:not([data-theme="light"]) .text-green-800 {
        color: #4ade80 !important;
      }
      :root:not([data-theme="light"]) .border-red-300 {
        border-color: #f87171 !important;
      }
      :root:not([data-theme="light"]) .text-red-600 {
        color: #f87171 !important;
      }
      :root:not([data-theme="light"]) .hover\:bg-red-50:hover {
        background-color: rgba(239, 68, 68, 0.1) !important;
      }
      :root:not([data-theme="light"]) .bg-orange-50 {
        background-color: rgba(249, 115, 22, 0.1) !important;
      }
      :root:not([data-theme="light"]) .bg-purple-50 {
        background-color: rgba(168, 85, 247, 0.1) !important;
      }
      :root:not([data-theme="light"]) .bg-yellow-50 {
        background-color: rgba(234, 179, 8, 0.12) !important;
      }
      :root:not([data-theme="light"]) .border-yellow-200 {
        border-color: rgba(234, 179, 8, 0.3) !important;
      }
      :root:not([data-theme="light"]) .bg-gray-200 {
        background-color: #374151 !important;
      }
      :root:not([data-theme="light"]) .modal-overlay {
        background-color: rgba(0, 0, 0, 0.7) !important;
      }
    }
  </style>
</head>
<body class="min-h-screen" style="background-color: var(--bg-primary); color: var(--text-primary)">
  <div id="root"></div>

  <!-- Load questions database and original backup for reset functionality -->
  <script src="questions.js"></script>
  <script src="questions-original.js"></script>
  <script src="version.js"></script>

  <script>
    (function() {
      const useState = React.useState;
      const useEffect = React.useEffect;
      const createElement = React.createElement;
      const e = createElement;

      // ============ THEME MANAGEMENT ============
      const ADMIN_THEME_KEY = 'chefKitchenAdminTheme';
      function getInitialTheme() {
        try {
          var saved = localStorage.getItem(ADMIN_THEME_KEY);
          if (saved) return saved;
        } catch (e) {}
        return 'system';
      }
      function applyTheme(theme) {
        var root = document.documentElement;
        if (theme === 'system') {
          root.removeAttribute('data-theme');
        } else {
          root.setAttribute('data-theme', theme);
        }
      }
      // Apply theme immediately to prevent flash
      applyTheme(getInitialTheme());

      // ============ CONVEX CLOUD DATABASE CONFIGURATION ============
      // Leland's Convex PRODUCTION deployment - DO NOT CHANGE
      const CONVEX_URL = "https://cautious-monitor-526.convex.cloud";

      // Use Convex if URL is configured
      var useConvex = !!CONVEX_URL;

      // Direct HTTP API calls to Convex (no SDK needed)
      function convexQuery(functionName, args) {
        return fetch(CONVEX_URL + '/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: functionName, args: args || {} })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.status === 'success') return data.value;
          throw new Error(data.errorMessage || 'Query failed');
        });
      }

      function convexMutation(functionName, args) {
        return fetch(CONVEX_URL + '/api/mutation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: functionName, args: args || {} })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.status === 'success') return data.value;
          throw new Error(data.errorMessage || 'Mutation failed');
        });
      }

      console.log('Convex configured - using cloud database at', CONVEX_URL);

      // Local storage key for admin changes - shared with index.html for LIVE updates
      const ADMIN_STORAGE_KEY = 'chefKitchenAdminQuestions';
      const ADMIN_CATEGORIES_KEY = 'chefKitchenAdminCategories';

      // Check if user has made any edits (localStorage has data)
      function hasLocalEdits() {
        try {
          return localStorage.getItem(ADMIN_STORAGE_KEY) !== null;
        } catch (e) {
          return false;
        }
      }

      // Load questions - check localStorage first for admin edits, fall back to questions.js
      function loadQuestions() {
        try {
          const saved = localStorage.getItem(ADMIN_STORAGE_KEY);
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (err) {
          console.log('Could not load saved questions:', err);
        }
        // Fall back to questions.js data
        return typeof questionsDB !== 'undefined' ? [...questionsDB] : [];
      }

      // Load original questions from backup file (for reset functionality)
      function loadOriginalQuestions() {
        return typeof originalQuestionsDB !== 'undefined' ? [...originalQuestionsDB] : [];
      }

      function loadOriginalCategories() {
        return typeof originalCategories !== 'undefined' ? [...originalCategories] : [];
      }

      // Load categories
      function loadCategories() {
        try {
          const saved = localStorage.getItem(ADMIN_CATEGORIES_KEY);
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (err) {
          console.log('Could not load saved categories:', err);
        }
        // Fall back to questions.js categories
        return typeof categories !== 'undefined' ? [...categories] : [];
      }

      // Save questions to localStorage (and sync to Convex if configured)
      function saveQuestions(questions) {
        try {
          localStorage.setItem(ADMIN_STORAGE_KEY, JSON.stringify(questions));
        } catch (err) {
          console.log('Could not save questions to localStorage:', err);
        }

        // Sync to Convex if configured
        if (useConvex) {
          syncToConvex(questions);
        }
      }

      // Save categories to localStorage
      function saveCategories(cats) {
        try {
          localStorage.setItem(ADMIN_CATEGORIES_KEY, JSON.stringify(cats));
        } catch (err) {
          console.log('Could not save categories:', err);
        }
      }

      // Sync all questions to Convex (bulk update)
      function syncToConvex(questions) {
        if (!useConvex) return;

        // Convert app format to Convex format
        var convexQuestions = questions.map(function(q) {
          return {
            questionId: q.id,
            question: q.question,
            options: q.options,
            correct: q.correct,
            hint: q.hint,
            explanation: q.explanation,
            category: q.category,
            examFocus: q.examFocus,
            chapter: q.chapter || 1
          };
        });

        convexMutation("questions:bulkImport", { questions: convexQuestions })
          .then(function(count) {
            console.log('Synced ' + count + ' questions to Convex cloud');
          })
          .catch(function(err) {
            console.log('Convex sync failed (will retry on next save):', err.message);
          });
      }

      // Load questions from Convex (async)
      function loadFromConvex(callback, errorCallback) {
        if (!useConvex) {
          callback(null);
          return;
        }

        convexQuery("questions:getAll")
          .then(function(convexQuestions) {
            if (convexQuestions && convexQuestions.length > 0) {
              var formatted = convexQuestions.map(function(q) {
                return {
                  id: q.questionId,
                  question: q.question,
                  options: q.options,
                  correct: q.correct,
                  hint: q.hint,
                  explanation: q.explanation,
                  category: q.category,
                  examFocus: q.examFocus,
                  chapter: q.chapter || 1
                };
              });
              callback(formatted);
            } else {
              callback(null);
            }
          })
          .catch(function(err) {
            console.log('Could not load from Convex:', err.message);
            if (errorCallback) {
              errorCallback(err);
            } else {
              callback(null);
            }
          });
      }

      // Category colors for visual distinction
      const categoryColors = {
        'Cooking Temperatures': 'bg-red-100 text-red-800',
        'Temperature Control': 'bg-orange-100 text-orange-800',
        'Time-Temperature Control': 'bg-amber-100 text-amber-800',
        'Food Storage': 'bg-blue-100 text-blue-800',
        'Cooling': 'bg-cyan-100 text-cyan-800',
        'Definitions': 'bg-purple-100 text-purple-800',
        'Sanitation': 'bg-teal-100 text-teal-800',
        'Foodborne Illness': 'bg-rose-100 text-rose-800',
        'FAT TOM': 'bg-yellow-100 text-yellow-800',
        'Chemical Contamination': 'bg-lime-100 text-lime-800',
        'Food Safety': 'bg-green-100 text-green-800',
        'Personal Hygiene': 'bg-indigo-100 text-indigo-800',
        'Seafood Toxins': 'bg-sky-100 text-sky-800',
        'TCS Foods': 'bg-pink-100 text-pink-800',
        'Allergens': 'bg-fuchsia-100 text-fuchsia-800',
        'Food Defense': 'bg-violet-100 text-violet-800'
      };

      function getCategoryColor(category) {
        return categoryColors[category] || 'bg-gray-100 text-gray-800';
      }

      // ============ COMPONENTS ============

      // Header Component
      function Header(props) {
        var convexStatus = props.convexStatus || 'not-configured';
        var theme = props.theme || 'system';
        var themeIcon = theme === 'system' ? '\uD83D\uDDA5\uFE0F' : theme === 'light' ? '\u2600\uFE0F' : '\uD83C\uDF19';
        var themeLabel = theme === 'system' ? 'System' : theme === 'light' ? 'Light' : 'Dark';
        var statusBanner;

        if (convexStatus === 'connected') {
          statusBanner = e('div', { className: 'bg-green-600 text-white text-center py-2 px-4' },
            e('p', { className: 'text-sm font-medium flex items-center justify-center gap-2' },
              e('span', null, '‚òÅÔ∏è'),
              'CLOUD SYNC: Connected to Convex - changes sync across all devices!',
              e('span', { className: 'animate-pulse' }, 'üü¢')
            )
          );
        } else if (convexStatus === 'connecting') {
          statusBanner = e('div', { className: 'bg-yellow-500 text-white text-center py-2 px-4' },
            e('p', { className: 'text-sm font-medium flex items-center justify-center gap-2' },
              e('span', { className: 'animate-spin' }, '‚è≥'),
              'Connecting to Convex cloud database...'
            )
          );
        } else if (convexStatus === 'error') {
          statusBanner = e('div', { className: 'bg-red-500 text-white text-center py-2 px-4' },
            e('p', { className: 'text-sm font-medium flex items-center justify-center gap-2' },
              e('span', null, '‚ö†Ô∏è'),
              'Cloud sync unavailable - changes saved locally only'
            )
          );
        } else {
          // not-configured - using localStorage
          statusBanner = e('div', { className: 'bg-blue-600 text-white text-center py-2 px-4' },
            e('p', { className: 'text-sm font-medium flex items-center justify-center gap-2' },
              e('span', { className: 'animate-pulse' }, 'üü¢'),
              'LOCAL MODE: Changes saved to this browser. Set up Convex for cross-device sync!',
              e('span', { className: 'animate-pulse' }, 'üü¢')
            )
          );
        }

        return e('div', null,
          // Status Banner (dynamic based on Convex connection)
          statusBanner,
          e('header', { className: 'text-white shadow-lg', style: { background: 'linear-gradient(to right, var(--header-from), var(--header-to))' } },
            e('div', { className: 'max-w-7xl mx-auto px-4 py-4' },
              e('div', { className: 'flex flex-col md:flex-row md:items-center md:justify-between gap-4' },
                e('div', null,
                  e('h1', { className: 'text-2xl font-bold flex items-center gap-2' },
                    e('span', null, 'üîß'),
                    'Question Manager'
                  ),
                  e('p', { className: 'text-gray-400 text-sm' }, "Chef's Kitchen | CUL 104 Admin Panel")
                ),
                e('div', { className: 'flex items-center gap-3' },
                  e('span', { className: 'text-sm text-gray-400' },
                    props.questionCount + ' questions'
                  ),
                  e('span', { className: 'text-xs text-gray-500' }, 'v' + APP_VERSION),
                  e('button', {
                    onClick: props.onCycleTheme,
                    className: 'px-3 py-2 rounded-lg text-sm transition-colors hover:bg-white/10',
                    style: { border: '1px solid rgba(255,255,255,0.2)', cursor: 'pointer', background: 'transparent', color: 'white' },
                    title: 'Theme: ' + themeLabel
                  }, themeIcon + ' ' + themeLabel),
                  e('a', {
                    href: 'index.html',
                    target: '_blank',
                    className: 'px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm transition-colors'
                  }, 'üëÄ Preview Study App')
                )
              )
            )
          )
        );
      }

      // Stats Bar Component
      function StatsBar(props) {
        const questions = props.questions;
        const examFocusCount = questions.filter(function(q) { return q.examFocus; }).length;
        const basicCount = questions.length - examFocusCount;
        const categoryCount = props.categories.length;

        return e('div', { className: 'bg-white border-b shadow-sm' },
          e('div', { className: 'max-w-7xl mx-auto px-4 py-3' },
            e('div', { className: 'flex flex-wrap gap-6 text-sm' },
              e('div', { className: 'flex items-center gap-2' },
                e('span', { className: 'text-2xl' }, 'üìä'),
                e('span', { className: 'text-gray-600' }, 'Total: '),
                e('span', { className: 'font-semibold' }, questions.length)
              ),
              e('div', { className: 'flex items-center gap-2' },
                e('span', { className: 'text-2xl' }, '‚≠ê'),
                e('span', { className: 'text-gray-600' }, 'Exam Focus: '),
                e('span', { className: 'font-semibold text-red-600' }, examFocusCount)
              ),
              e('div', { className: 'flex items-center gap-2' },
                e('span', { className: 'text-2xl' }, 'üìñ'),
                e('span', { className: 'text-gray-600' }, 'Basic: '),
                e('span', { className: 'font-semibold text-gray-600' }, basicCount)
              ),
              e('div', { className: 'flex items-center gap-2' },
                e('span', { className: 'text-2xl' }, 'üìÇ'),
                e('span', { className: 'text-gray-600' }, 'Categories: '),
                e('span', { className: 'font-semibold' }, categoryCount)
              ),
              e('div', { className: 'flex items-center gap-2' },
                e('span', { className: 'text-2xl' }, 'üìó'),
                e('span', { className: 'text-gray-600' }, 'Chapters: '),
                e('span', { className: 'font-semibold text-green-600' }, '1-15')
              )
            )
          )
        );
      }

      // Filter Bar Component
      function FilterBar(props) {
        return e('div', { className: 'bg-white border-b shadow-sm sticky top-0 z-10' },
          e('div', { className: 'max-w-7xl mx-auto px-4 py-4' },
            e('div', { className: 'flex flex-col md:flex-row gap-4' },
              // Search
              e('div', { className: 'flex-1' },
                e('input', {
                  type: 'text',
                  placeholder: 'Search questions, hints, explanations...',
                  value: props.searchTerm,
                  onChange: function(ev) { props.onSearchChange(ev.target.value); },
                  className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
                })
              ),
              // Category Filter
              e('select', {
                value: props.categoryFilter,
                onChange: function(ev) { props.onCategoryChange(ev.target.value); },
                className: 'px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
              },
                e('option', { value: '' }, 'All Categories'),
                props.categories.map(function(cat) {
                  return e('option', { key: cat, value: cat }, cat);
                })
              ),
              // Chapter Filter
              e('select', {
                value: props.chapterFilter,
                onChange: function(ev) { props.onChapterChange(ev.target.value); },
                className: 'px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
              },
                e('option', { value: '' }, 'All Chapters'),
                [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].map(function(ch) {
                  return e('option', { key: ch, value: ch }, 'Ch ' + ch);
                })
              ),
              // Exam Focus Filter
              e('select', {
                value: props.examFocusFilter,
                onChange: function(ev) { props.onExamFocusChange(ev.target.value); },
                className: 'px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
              },
                e('option', { value: '' }, 'All Questions'),
                e('option', { value: 'true' }, '‚≠ê Exam Focus'),
                e('option', { value: 'false' }, 'üìñ Basic Knowledge')
              ),
              // Add Question Button
              e('button', {
                onClick: props.onAddQuestion,
                className: 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2'
              },
                e('span', null, '+'),
                'Add Question'
              )
            )
          )
        );
      }

      // Question Row Component
      function QuestionRow(props) {
        const q = props.question;
        const correctLetter = String.fromCharCode(65 + q.correct);

        return e('div', {
          className: 'question-row bg-white border-b px-4 py-4 hover:bg-gray-50 transition-colors'
        },
          e('div', { className: 'flex gap-4' },
            // ID Column
            e('div', { className: 'w-16 flex-shrink-0 text-center' },
              e('span', { className: 'text-gray-400 text-sm' }, '#' + q.id),
              e('div', { className: 'text-xs text-green-600 font-medium' }, 'Ch ' + (q.chapter || 1)),
              q.examFocus && e('div', { className: 'text-yellow-500 text-lg' }, '‚≠ê')
            ),
            // Main Content
            e('div', { className: 'flex-1 min-w-0' },
              // Question text
              e('p', { className: 'font-medium text-gray-900 mb-2' }, q.question),
              // Options
              e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-1 mb-2' },
                q.options.map(function(opt, i) {
                  const letter = String.fromCharCode(65 + i);
                  const isCorrect = i === q.correct;
                  return e('div', {
                    key: i,
                    className: 'text-sm ' + (isCorrect ? 'text-green-700 font-medium' : 'text-gray-600')
                  },
                    e('span', { className: 'font-mono mr-2' }, letter + ')'),
                    opt,
                    isCorrect && e('span', { className: 'ml-2 text-green-600' }, '‚úì')
                  );
                })
              ),
              // Metadata row
              e('div', { className: 'flex flex-wrap items-center gap-2 text-xs' },
                e('span', { className: 'category-tag ' + getCategoryColor(q.category) }, q.category),
                e('span', { className: 'text-gray-400' }, '|'),
                e('span', { className: 'text-gray-500' }, 'Hint: ' + (q.hint.length > 50 ? q.hint.substring(0, 50) + '...' : q.hint))
              )
            ),
            // Actions
            e('div', { className: 'flex-shrink-0 flex gap-2' },
              e('button', {
                onClick: function() { props.onEdit(q); },
                className: 'px-3 py-1.5 text-blue-600 hover:bg-blue-50 rounded-lg text-sm font-medium transition-colors',
                title: 'Edit question'
              }, '‚úèÔ∏è Edit'),
              e('button', {
                onClick: function() { props.onDelete(q.id); },
                className: 'px-3 py-1.5 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors',
                title: 'Delete question'
              }, 'üóëÔ∏è')
            )
          )
        );
      }

      // Question Editor Modal
      function QuestionEditor(props) {
        const question = props.question;
        const isNew = props.isNew;
        const categories = props.categories;

        const [formData, setFormData] = useState(question || {
          id: 0,
          question: '',
          options: ['', '', '', ''],
          correct: 0,
          hint: '',
          explanation: '',
          category: categories[0] || '',
          examFocus: false,
          chapter: 1
        });

        function updateField(field, value) {
          setFormData(function(prev) {
            return Object.assign({}, prev, { [field]: value });
          });
        }

        function updateOption(index, value) {
          setFormData(function(prev) {
            var newOptions = prev.options.slice();
            newOptions[index] = value;
            return Object.assign({}, prev, { options: newOptions });
          });
        }

        function handleSave() {
          // Validation
          if (!formData.question.trim()) {
            alert('Question text is required');
            return;
          }
          if (formData.options.some(function(o) { return !o.trim(); })) {
            alert('All four options are required');
            return;
          }
          if (!formData.hint.trim()) {
            alert('Hint is required');
            return;
          }
          if (!formData.explanation.trim()) {
            alert('Explanation is required');
            return;
          }
          if (!formData.category) {
            alert('Category is required');
            return;
          }

          props.onSave(formData);
        }

        return e('div', { className: 'modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4' },
          e('div', { className: 'bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto' },
            // Header
            e('div', { className: 'sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between' },
              e('h2', { className: 'text-xl font-bold' },
                isNew ? '‚ûï Add New Question' : '‚úèÔ∏è Edit Question #' + formData.id
              ),
              e('button', {
                onClick: props.onCancel,
                className: 'text-gray-400 hover:text-gray-600 text-2xl'
              }, '√ó')
            ),
            // Form
            e('div', { className: 'p-6 space-y-6' },
              // Question Text
              e('div', null,
                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Question *'),
                e('textarea', {
                  value: formData.question,
                  onChange: function(ev) { updateField('question', ev.target.value); },
                  rows: 3,
                  className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                })
              ),
              // Options
              e('div', null,
                e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Answer Options *'),
                e('div', { className: 'space-y-3' },
                  [0, 1, 2, 3].map(function(i) {
                    var letter = String.fromCharCode(65 + i);
                    var isCorrect = formData.correct === i;
                    return e('div', { key: i, className: 'flex items-center gap-3' },
                      e('button', {
                        type: 'button',
                        onClick: function() { updateField('correct', i); },
                        className: 'w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold ' +
                          (isCorrect ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-500 hover:border-green-400')
                      }, letter),
                      e('input', {
                        type: 'text',
                        value: formData.options[i],
                        onChange: function(ev) { updateOption(i, ev.target.value); },
                        placeholder: 'Option ' + letter,
                        className: 'flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ' +
                          (isCorrect ? 'border-green-400 bg-green-50' : '')
                      }),
                      isCorrect && e('span', { className: 'text-green-600 text-sm font-medium' }, '‚úì Correct')
                    );
                  })
                ),
                e('p', { className: 'text-xs text-gray-500 mt-2' }, 'Click a letter button to mark it as the correct answer')
              ),
              // Category, Chapter, and Exam Focus
              e('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
                e('div', null,
                  e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Category *'),
                  e('select', {
                    value: formData.category,
                    onChange: function(ev) { updateField('category', ev.target.value); },
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                  },
                    e('option', { value: '' }, 'Select a category...'),
                    categories.map(function(cat) {
                      return e('option', { key: cat, value: cat }, cat);
                    })
                  )
                ),
                e('div', null,
                  e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'üìó Chapter *'),
                  e('select', {
                    value: formData.chapter || 1,
                    onChange: function(ev) { updateField('chapter', parseInt(ev.target.value)); },
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500'
                  },
                    [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].map(function(ch) {
                      return e('option', { key: ch, value: ch }, 'Chapter ' + ch);
                    })
                  )
                ),
                e('div', { className: 'flex items-center' },
                  e('label', { className: 'flex items-center gap-3 cursor-pointer' },
                    e('input', {
                      type: 'checkbox',
                      checked: formData.examFocus,
                      onChange: function(ev) { updateField('examFocus', ev.target.checked); },
                      className: 'w-5 h-5 text-yellow-500 rounded focus:ring-yellow-500'
                    }),
                    e('span', { className: 'text-sm font-medium text-gray-700' },
                      '‚≠ê Exam Focus'
                    )
                  )
                )
              ),
              // Hint
              e('div', null,
                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' },
                  'Hint * ',
                  e('span', { className: 'font-normal text-gray-500' }, '(should NOT give away the answer)')
                ),
                e('textarea', {
                  value: formData.hint,
                  onChange: function(ev) { updateField('hint', ev.target.value); },
                  rows: 2,
                  placeholder: 'Provide a helpful hint that guides thinking without revealing the answer...',
                  className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                })
              ),
              // Explanation
              e('div', null,
                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' },
                  'Explanation * ',
                  e('span', { className: 'font-normal text-gray-500' }, '(shown after answering)')
                ),
                e('textarea', {
                  value: formData.explanation,
                  onChange: function(ev) { updateField('explanation', ev.target.value); },
                  rows: 2,
                  placeholder: 'Explain why the correct answer is correct...',
                  className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                })
              )
            ),
            // Footer
            e('div', { className: 'sticky bottom-0 bg-gray-50 border-t px-6 py-4 flex justify-end gap-3' },
              e('button', {
                onClick: props.onCancel,
                className: 'px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors'
              }, 'Cancel'),
              e('button', {
                onClick: handleSave,
                className: 'px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors'
              }, isNew ? 'Add Question' : 'Save Changes')
            )
          )
        );
      }

      // Category Manager Modal
      function CategoryManager(props) {
        const categories = props.categories;
        const [newCategory, setNewCategory] = useState('');

        function handleAddCategory() {
          var trimmed = newCategory.trim();
          if (!trimmed) {
            alert('Category name is required');
            return;
          }
          if (categories.indexOf(trimmed) !== -1) {
            alert('Category already exists');
            return;
          }
          props.onAddCategory(trimmed);
          setNewCategory('');
        }

        return e('div', { className: 'modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4' },
          e('div', { className: 'bg-white rounded-xl shadow-2xl max-w-md w-full' },
            // Header
            e('div', { className: 'border-b px-6 py-4 flex items-center justify-between' },
              e('h2', { className: 'text-xl font-bold' }, 'üìÇ Manage Categories'),
              e('button', {
                onClick: props.onClose,
                className: 'text-gray-400 hover:text-gray-600 text-2xl'
              }, '√ó')
            ),
            // Content
            e('div', { className: 'p-6' },
              // Add new category
              e('div', { className: 'flex gap-2 mb-6' },
                e('input', {
                  type: 'text',
                  value: newCategory,
                  onChange: function(ev) { setNewCategory(ev.target.value); },
                  placeholder: 'New category name...',
                  className: 'flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500',
                  onKeyPress: function(ev) { if (ev.key === 'Enter') handleAddCategory(); }
                }),
                e('button', {
                  onClick: handleAddCategory,
                  className: 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors'
                }, 'Add')
              ),
              // Existing categories
              e('div', { className: 'space-y-2 max-h-64 overflow-y-auto' },
                categories.map(function(cat) {
                  var count = props.getQuestionCount(cat);
                  return e('div', {
                    key: cat,
                    className: 'flex items-center justify-between py-2 px-3 bg-gray-50 rounded-lg'
                  },
                    e('div', { className: 'flex items-center gap-2' },
                      e('span', { className: 'category-tag ' + getCategoryColor(cat) }, cat),
                      e('span', { className: 'text-xs text-gray-500' }, count + ' questions')
                    ),
                    count === 0 && e('button', {
                      onClick: function() { props.onDeleteCategory(cat); },
                      className: 'text-red-500 hover:text-red-700 text-sm',
                      title: 'Delete category (only empty categories can be deleted)'
                    }, 'üóëÔ∏è')
                  );
                })
              ),
              e('p', { className: 'text-xs text-gray-500 mt-4' },
                'Note: Only empty categories (0 questions) can be deleted.'
              )
            ),
            // Footer
            e('div', { className: 'border-t px-6 py-4' },
              e('button', {
                onClick: props.onClose,
                className: 'w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors'
              }, 'Done')
            )
          )
        );
      }

      // Export/Import Panel
      function ExportImportPanel(props) {
        const [importText, setImportText] = useState('');
        const [showImport, setShowImport] = useState(false);
        const [showAdvanced, setShowAdvanced] = useState(false);

        // Create timestamped backup filename
        function getTimestamp() {
          var now = new Date();
          return now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + '_' +
            String(now.getHours()).padStart(2, '0') + '-' +
            String(now.getMinutes()).padStart(2, '0');
        }

        function handleCreateBackup() {
          var dataStr = JSON.stringify(props.questions, null, 2);
          var blob = new Blob([dataStr], { type: 'application/json' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'questions-backup-' + getTimestamp() + '.json';
          a.click();
          URL.revokeObjectURL(url);
          alert('Backup saved! Keep this file safe - you can restore from it anytime using the Import feature.');
        }

        function handleExportJSON() {
          var dataStr = JSON.stringify(props.questions, null, 2);
          var blob = new Blob([dataStr], { type: 'application/json' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'servsafe-questions.json';
          a.click();
          URL.revokeObjectURL(url);
        }

        function handleExportJS() {
          var header = '// ============ CUL 104 SERVSAFE QUESTIONS DATABASE ============\n';
          header += '// Generated from Admin Panel on ' + new Date().toLocaleDateString() + '\n';
          header += '// Total questions: ' + props.questions.length + '\n\n';
          header += 'var questionsDB = ';

          var dataStr = JSON.stringify(props.questions, null, 2);

          var footer = ';\n\n// Get unique categories from questions\n';
          footer += 'var categories = [];\n';
          footer += 'questionsDB.forEach(function(q) {\n';
          footer += '  if (categories.indexOf(q.category) === -1) {\n';
          footer += '    categories.push(q.category);\n';
          footer += '  }\n';
          footer += '});\n';
          footer += 'categories.sort();\n';

          var fullContent = header + dataStr + footer;
          var blob = new Blob([fullContent], { type: 'application/javascript' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'questions.js';
          a.click();
          URL.revokeObjectURL(url);
        }

        function handleImport() {
          try {
            var parsed = JSON.parse(importText);
            if (!Array.isArray(parsed)) {
              throw new Error('Data must be an array of questions');
            }
            // Validate structure
            parsed.forEach(function(q, i) {
              if (!q.question || !q.options || !q.hint || !q.explanation || !q.category) {
                throw new Error('Question ' + (i + 1) + ' is missing required fields');
              }
              if (!Array.isArray(q.options) || q.options.length !== 4) {
                throw new Error('Question ' + (i + 1) + ' must have exactly 4 options');
              }
            });
            if (confirm('Import ' + parsed.length + ' questions? This will REPLACE all current questions.\n\nTip: Create a backup first if you haven\'t already!')) {
              props.onImport(parsed);
              setShowImport(false);
              setImportText('');
            }
          } catch (err) {
            alert('Import Error: ' + err.message);
          }
        }

        function handleFileUpload(ev) {
          var file = ev.target.files[0];
          if (!file) return;
          var reader = new FileReader();
          reader.onload = function(e) {
            var content = e.target.result;
            // Try to extract JSON from .js file
            if (file.name.endsWith('.js')) {
              var match = content.match(/var\s+questionsDB\s*=\s*(\[[\s\S]*?\]);/);
              if (match) {
                content = match[1];
              }
            }
            setImportText(content);
          };
          reader.readAsText(file);
        }

        function handleResetToOriginal() {
          var originalCount = loadOriginalQuestions().length;
          if (confirm('‚ö†Ô∏è RESET TO ORIGINAL ‚ö†Ô∏è\n\nThis will restore the original ' + originalCount + ' questions from when the app was first set up.\n\nALL your changes will be lost!\n\nAre you absolutely sure?')) {
            if (confirm('Last chance! Create a backup first?\n\nClick OK to create a backup before resetting.\nClick Cancel to reset without backup.')) {
              handleCreateBackup();
            }
            props.onResetToOriginal();
          }
        }

        return e('div', { className: 'bg-white border rounded-xl shadow-sm' },
          e('div', { className: 'p-4 border-b bg-gradient-to-r from-blue-50 to-green-50' },
            e('h3', { className: 'font-bold text-gray-800 flex items-center gap-2' },
              'üíæ Backup & Recovery',
              e('span', { className: 'text-xs font-normal bg-green-100 text-green-800 px-2 py-0.5 rounded-full' }, 'Recommended')
            ),
            e('p', { className: 'text-sm text-gray-600 mt-1' },
              'Create backups before making big changes. You can always restore from a backup!'
            )
          ),
          e('div', { className: 'p-4 space-y-4' },
            // Primary action - Create Backup
            e('div', { className: 'flex flex-wrap gap-3' },
              e('button', {
                onClick: handleCreateBackup,
                className: 'px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors text-sm font-medium flex items-center gap-2'
              },
                e('span', null, 'üì¶'),
                'Create Backup'
              ),
              e('button', {
                onClick: function() { setShowImport(!showImport); },
                className: 'px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm font-medium flex items-center gap-2'
              },
                e('span', null, showImport ? '‚úï' : 'üì•'),
                showImport ? 'Cancel' : 'Restore from Backup'
              ),
              e('button', {
                onClick: handleResetToOriginal,
                className: 'px-5 py-2.5 border-2 border-red-300 text-red-600 hover:bg-red-50 rounded-lg transition-colors text-sm font-medium flex items-center gap-2'
              },
                e('span', null, '‚Ü©Ô∏è'),
                'Reset to Original (' + (typeof questionsDB !== 'undefined' ? questionsDB.length : '?') + ' questions)'
              )
            ),

            // Import/Restore section
            showImport && e('div', { className: 'border-t pt-4 space-y-3 bg-blue-50 -mx-4 px-4 pb-4 mt-4' },
              e('h4', { className: 'font-medium text-gray-800' }, 'üì• Restore from a Backup File'),
              e('div', null,
                e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' },
                  'Upload a backup file (.json):'
                ),
                e('input', {
                  type: 'file',
                  accept: '.json,.js',
                  onChange: handleFileUpload,
                  className: 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-white file:text-gray-700 hover:file:bg-gray-100 file:cursor-pointer cursor-pointer'
                })
              ),
              e('div', null,
                e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' },
                  'Or paste JSON content directly:'
                ),
                e('textarea', {
                  value: importText,
                  onChange: function(ev) { setImportText(ev.target.value); },
                  rows: 4,
                  placeholder: 'Paste JSON content here...',
                  className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm bg-white'
                })
              ),
              importText && e('button', {
                onClick: handleImport,
                className: 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium'
              }, '‚úì Restore from This Backup')
            ),

            // Advanced options toggle
            e('div', { className: 'border-t pt-4' },
              e('button', {
                onClick: function() { setShowAdvanced(!showAdvanced); },
                className: 'text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1'
              },
                e('span', null, showAdvanced ? '‚ñº' : '‚ñ∂'),
                'Advanced Export Options (for archiving)'
              )
            ),

            // Advanced export options
            showAdvanced && e('div', { className: 'flex flex-wrap gap-3 pl-4' },
              e('button', {
                onClick: handleExportJSON,
                className: 'px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm'
              }, 'üìÑ Export JSON'),
              e('button', {
                onClick: handleExportJS,
                className: 'px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm'
              }, 'üìú Export as questions.js')
            ),

            // Info box
            e('div', { className: 'bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm' },
              e('p', { className: 'font-medium text-amber-800 mb-1' }, 'üí° How Backups Work:'),
              e('ul', { className: 'text-amber-700 space-y-1 ml-4 list-disc' },
                e('li', null, 'Changes you make are saved automatically and appear in the study app immediately'),
                e('li', null, 'Create backups before making major changes - they download to your computer'),
                e('li', null, 'If something goes wrong, use "Restore from Backup" to undo changes'),
                e('li', null, '"Reset to Original" restores the questions from the questions.js file')
              )
            )
          )
        );
      }

      // ============ STUDENT DASHBOARD ============
      function StudentDashboard() {
        var studentsState = useState([]);
        var students = studentsState[0];
        var setStudents = studentsState[1];
        var loadingState = useState(true);
        var loading = loadingState[0];
        var setLoading = loadingState[1];
        var selectedStudentState = useState(null);
        var selectedStudent = selectedStudentState[0];
        var setSelectedStudent = selectedStudentState[1];
        var studentDetailState = useState(null);
        var studentDetail = studentDetailState[0];
        var setStudentDetail = studentDetailState[1];
        var sortByState = useState('lastActiveAt');
        var sortBy = sortByState[0];
        var setSortBy = sortByState[1];
        var sortDirState = useState('desc');
        var sortDir = sortDirState[0];
        var setSortDir = sortDirState[1];
        var searchState = useState('');
        var search = searchState[0];
        var setSearch = searchState[1];

        // Load students on mount and poll every 3 seconds
        useEffect(function() {
          function fetchStudents() {
            convexQuery("users:getAllStudents").then(function(data) {
              setStudents(data || []);
              setLoading(false);
            }).catch(function() { setLoading(false); });
          }
          fetchStudents();
          var interval = setInterval(fetchStudents, 3000);
          return function() { clearInterval(interval); };
        }, []);

        useEffect(function() {
          if (!selectedStudent) { setStudentDetail(null); return; }
          convexQuery("users:getStudentDetail", { userId: selectedStudent })
            .then(function(data) { setStudentDetail(data); })
            .catch(function() {});
        }, [selectedStudent]);

        function handleSort(field) {
          if (sortBy === field) {
            setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
          } else {
            setSortBy(field);
            setSortDir('desc');
          }
        }

        function timeAgo(ts) {
          if (!ts) return 'Never';
          var diff = Date.now() - ts;
          var mins = Math.floor(diff / 60000);
          if (mins < 1) return 'Just now';
          if (mins < 60) return mins + 'm ago';
          var hours = Math.floor(mins / 60);
          if (hours < 24) return hours + 'h ago';
          var days = Math.floor(hours / 24);
          return days + 'd ago';
        }

        var filtered = students.filter(function(s) {
          if (!search) return true;
          var term = search.toLowerCase();
          return (s.displayName || '').toLowerCase().indexOf(term) !== -1 ||
                 (s.firstName || '').toLowerCase().indexOf(term) !== -1;
        });

        filtered.sort(function(a, b) {
          var va = a[sortBy] || 0;
          var vb = b[sortBy] || 0;
          if (typeof va === 'string') va = va.toLowerCase();
          if (typeof vb === 'string') vb = vb.toLowerCase();
          if (sortDir === 'asc') return va > vb ? 1 : -1;
          return va < vb ? 1 : -1;
        });

        var totalStudents = students.length;
        var totalAnswered = students.reduce(function(s, st) { return s + st.totalAnswered; }, 0);
        var avgAcc = totalStudents > 0
          ? Math.round(students.reduce(function(s, st) {
              return s + (st.totalAnswered > 0 ? st.totalCorrect / st.totalAnswered : 0);
            }, 0) / totalStudents * 100)
          : 0;

        function exportCSV() {
          var rows = [['Gamer Name', 'First Name', 'Questions Answered', 'Accuracy %', 'Badges Earned', 'Last Active']];
          students.forEach(function(s) {
            var acc = s.totalAnswered > 0 ? Math.round((s.totalCorrect / s.totalAnswered) * 100) : 0;
            rows.push([s.displayName, s.firstName, s.totalAnswered, acc, s.badgeCount, new Date(s.lastActiveAt).toLocaleString()]);
          });
          var csv = rows.map(function(r) { return r.join(','); }).join('\n');
          var blob = new Blob([csv], { type: 'text/csv' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'chef-kitchen-students-' + new Date().toISOString().split('T')[0] + '.csv';
          a.click();
          URL.revokeObjectURL(url);
        }

        if (loading) {
          return e('div', { className: 'max-w-7xl mx-auto p-8 text-center text-gray-500' }, 'Loading students...');
        }

        return e('div', { className: 'max-w-7xl mx-auto p-4 space-y-4' },
          // Summary bar
          e('div', { className: 'grid grid-cols-3 gap-4' },
            e('div', { className: 'bg-white rounded-xl shadow-sm p-4 text-center' },
              e('div', { className: 'text-2xl font-bold text-blue-600' }, totalStudents),
              e('div', { className: 'text-xs text-gray-500' }, 'Students')
            ),
            e('div', { className: 'bg-white rounded-xl shadow-sm p-4 text-center' },
              e('div', { className: 'text-2xl font-bold text-green-600' }, avgAcc + '%'),
              e('div', { className: 'text-xs text-gray-500' }, 'Avg Accuracy')
            ),
            e('div', { className: 'bg-white rounded-xl shadow-sm p-4 text-center' },
              e('div', { className: 'text-2xl font-bold text-orange-600' }, totalAnswered),
              e('div', { className: 'text-xs text-gray-500' }, 'Total Answers')
            )
          ),

          // Search and export
          e('div', { className: 'flex gap-3 items-center' },
            e('input', {
              type: 'text',
              placeholder: 'Search students...',
              value: search,
              onChange: function(ev) { setSearch(ev.target.value); },
              className: 'flex-1 px-4 py-2 border rounded-lg text-sm'
            }),
            e('button', {
              onClick: exportCSV,
              className: 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium'
            }, 'Export CSV')
          ),

          // Student table
          e('div', { className: 'bg-white rounded-xl shadow-sm overflow-hidden' },
            e('table', { className: 'w-full text-sm' },
              e('thead', null,
                e('tr', { className: 'bg-gray-50 border-b' },
                  [
                    { key: 'displayName', label: 'Gamer Name' },
                    { key: 'firstName', label: 'First Name' },
                    { key: 'totalAnswered', label: 'Answered' },
                    { key: 'accuracy', label: 'Accuracy' },
                    { key: 'badgeCount', label: 'Badges' },
                    { key: 'lastActiveAt', label: 'Last Active' }
                  ].map(function(col) {
                    return e('th', {
                      key: col.key,
                      onClick: function() { handleSort(col.key); },
                      className: 'px-4 py-3 text-left font-medium text-gray-600 cursor-pointer hover:text-gray-900'
                    }, col.label + (sortBy === col.key ? (sortDir === 'asc' ? ' \u25B2' : ' \u25BC') : ''));
                  }),
                  e('th', { className: 'px-4 py-3' })
                )
              ),
              e('tbody', null,
                filtered.length === 0
                  ? e('tr', null, e('td', { colSpan: 7, className: 'px-4 py-8 text-center text-gray-400' }, 'No students found'))
                  : filtered.map(function(s) {
                    var acc = s.totalAnswered > 0 ? Math.round((s.totalCorrect / s.totalAnswered) * 100) : 0;
                    return e('tr', {
                      key: s.userId,
                      className: 'border-b hover:bg-gray-50'
                    },
                      e('td', { className: 'px-4 py-3 font-medium text-orange-600' }, s.displayName),
                      e('td', { className: 'px-4 py-3 text-gray-600' }, s.firstName),
                      e('td', { className: 'px-4 py-3' }, s.totalAnswered),
                      e('td', { className: 'px-4 py-3' },
                        e('span', {
                          className: 'px-2 py-1 rounded-full text-xs font-medium',
                          style: { backgroundColor: acc >= 80 ? '#DCFCE7' : acc >= 60 ? '#FEF3C7' : '#FEE2E2', color: acc >= 80 ? '#166534' : acc >= 60 ? '#92400E' : '#991B1B' }
                        }, acc + '%')
                      ),
                      e('td', { className: 'px-4 py-3' }, s.badgeCount),
                      e('td', { className: 'px-4 py-3 text-gray-500 text-xs' }, timeAgo(s.lastActiveAt)),
                      e('td', { className: 'px-4 py-3' },
                        e('button', {
                          onClick: function() { setSelectedStudent(s.userId); },
                          className: 'text-blue-600 hover:text-blue-800 text-xs font-medium'
                        }, 'Details')
                      )
                    );
                  })
              )
            )
          ),

          // Student Detail Modal
          selectedStudent && studentDetail && e('div', {
            className: 'modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4',
            onClick: function() { setSelectedStudent(null); }
          },
            e('div', {
              className: 'bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto p-6',
              onClick: function(ev) { ev.stopPropagation(); }
            },
              // Header
              e('div', { className: 'flex items-center justify-between mb-4' },
                e('div', null,
                  e('h2', { className: 'text-xl font-bold text-gray-800' }, studentDetail.user.displayName),
                  e('p', { className: 'text-sm text-gray-500' }, 'First name: ' + studentDetail.user.firstName + ' \u2022 Joined: ' + new Date(studentDetail.user.createdAt).toLocaleDateString())
                ),
                e('button', {
                  onClick: function() { setSelectedStudent(null); },
                  className: 'text-gray-400 hover:text-gray-600 text-2xl'
                }, '\u00D7')
              ),

              // Overall stats
              studentDetail.progress && e('div', { className: 'grid grid-cols-4 gap-3 mb-4' },
                e('div', { className: 'bg-blue-50 rounded-lg p-3 text-center' },
                  e('div', { className: 'text-lg font-bold text-blue-600' }, studentDetail.progress.totalAnswered || 0),
                  e('div', { className: 'text-xs text-gray-500' }, 'Answered')
                ),
                e('div', { className: 'bg-green-50 rounded-lg p-3 text-center' },
                  e('div', { className: 'text-lg font-bold text-green-600' },
                    studentDetail.progress.totalAnswered > 0
                      ? Math.round((studentDetail.progress.totalCorrect / studentDetail.progress.totalAnswered) * 100) + '%'
                      : '0%'
                  ),
                  e('div', { className: 'text-xs text-gray-500' }, 'Accuracy')
                ),
                e('div', { className: 'bg-orange-50 rounded-lg p-3 text-center' },
                  e('div', { className: 'text-lg font-bold text-orange-600' }, studentDetail.progress.bestStreak || 0),
                  e('div', { className: 'text-xs text-gray-500' }, 'Best Streak')
                ),
                e('div', { className: 'bg-purple-50 rounded-lg p-3 text-center' },
                  e('div', { className: 'text-lg font-bold text-purple-600' }, studentDetail.badges.length),
                  e('div', { className: 'text-xs text-gray-500' }, 'Badges')
                )
              ),

              // Per-chapter stats
              studentDetail.progress && studentDetail.progress.chapterStats && e('div', { className: 'mb-4' },
                e('h3', { className: 'font-bold text-gray-700 mb-2 text-sm' }, 'Chapter Performance'),
                e('div', { className: 'grid grid-cols-5 gap-2' },
                  [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].map(function(ch) {
                    var cs = studentDetail.progress.chapterStats[ch];
                    var acc = cs && cs.answered > 0 ? Math.round((cs.correct / cs.answered) * 100) : null;
                    return e('div', { key: ch, className: 'text-center p-2 rounded-lg bg-gray-50' },
                      e('div', { className: 'text-xs text-gray-500' }, 'Ch ' + ch),
                      e('div', {
                        className: 'text-sm font-bold',
                        style: { color: acc === null ? '#9CA3AF' : acc >= 80 ? '#16A34A' : acc >= 60 ? '#D97706' : '#DC2626' }
                      }, acc !== null ? acc + '%' : '-')
                    );
                  })
                )
              ),

              // Per-category stats
              studentDetail.progress && studentDetail.progress.categoryStats && e('div', { className: 'mb-4' },
                e('h3', { className: 'font-bold text-gray-700 mb-2 text-sm' }, 'Category Performance'),
                e('div', { className: 'space-y-1' },
                  Object.keys(studentDetail.progress.categoryStats).sort().map(function(cat) {
                    var cs = studentDetail.progress.categoryStats[cat];
                    var acc = cs.total > 0 ? Math.round((cs.correct / cs.total) * 100) : 0;
                    return e('div', { key: cat, className: 'flex items-center gap-2 text-xs' },
                      e('span', { className: 'w-32 truncate text-gray-600' }, cat),
                      e('div', { className: 'flex-1 h-2 bg-gray-200 rounded-full overflow-hidden' },
                        e('div', { style: { width: acc + '%', backgroundColor: acc >= 80 ? '#22C55E' : acc >= 60 ? '#F59E0B' : '#EF4444', height: '100%', borderRadius: '9999px' } })
                      ),
                      e('span', { className: 'w-12 text-right font-medium', style: { color: acc >= 80 ? '#16A34A' : acc >= 60 ? '#D97706' : '#DC2626' } }, acc + '%')
                    );
                  })
                )
              ),

              // Badges
              studentDetail.badges.length > 0 && e('div', { className: 'mb-4' },
                e('h3', { className: 'font-bold text-gray-700 mb-2 text-sm' }, 'Earned Badges'),
                e('div', { className: 'flex flex-wrap gap-1' },
                  studentDetail.badges.map(function(b) {
                    return e('span', { key: b, className: 'px-2 py-1 bg-yellow-50 border border-yellow-200 rounded-full text-xs' }, b);
                  })
                )
              ),

              // Archives
              studentDetail.archives && studentDetail.archives.length > 0 && e('div', null,
                e('h3', { className: 'font-bold text-gray-700 mb-2 text-sm' }, 'Progress History (Resets)'),
                e('div', { className: 'space-y-2' },
                  studentDetail.archives.map(function(arch, idx) {
                    var archAcc = arch.progress.totalAnswered > 0
                      ? Math.round((arch.progress.totalCorrect / arch.progress.totalAnswered) * 100)
                      : 0;
                    return e('div', {
                      key: idx,
                      className: 'bg-gray-50 rounded-lg p-3 text-xs'
                    },
                      e('div', { className: 'flex justify-between' },
                        e('span', { className: 'font-medium text-gray-700' }, 'Reset #' + arch.resetNumber),
                        e('span', { className: 'text-gray-400' }, new Date(arch.archivedAt).toLocaleDateString())
                      ),
                      e('div', { className: 'text-gray-500 mt-1' },
                        arch.progress.totalAnswered + ' answered, ' + archAcc + '% accuracy, ' + arch.badges.length + ' badges'
                      )
                    );
                  })
                )
              )
            )
          )
        );
      }

      // ============ LIVE TEST PANEL ============
      function LiveTestPanel() {
        var testNameState = useState('');
        var testName = testNameState[0];
        var setTestName = testNameState[1];
        var testModeState = useState('examFocus');
        var testMode = testModeState[0];
        var setTestMode = testModeState[1];
        var testModeValueState = useState('');
        var testModeValue = testModeValueState[0];
        var setTestModeValue = testModeValueState[1];
        var timerState = useState(15);
        var timer = timerState[0];
        var setTimer = timerState[1];
        var activeTestState = useState(null);
        var currentTest = activeTestState[0];
        var setCurrentTest = activeTestState[1];
        var leaderboardState = useState([]);
        var leaderboard = leaderboardState[0];
        var setLeaderboard = leaderboardState[1];
        var testHistoryState = useState([]);
        var testHistory = testHistoryState[0];
        var setTestHistory = testHistoryState[1];
        var timeLeftState = useState(0);
        var timeLeft = timeLeftState[0];
        var setTimeLeft = timeLeftState[1];
        var creatingState = useState(false);
        var creating = creatingState[0];
        var setCreating = creatingState[1];

        // Load test history on mount and poll for active test
        useEffect(function() {
          convexQuery("tests:getTestHistory").then(function(h) { setTestHistory(h || []); }).catch(function() {});
          convexQuery("tests:getActiveTest").then(function(t) {
            if (t) setCurrentTest(t);
          }).catch(function() {});
        }, []);

        // Poll leaderboard when test is active
        useEffect(function() {
          if (!currentTest || currentTest.status === 'finished') return;
          var interval = setInterval(function() {
            convexQuery("tests:getActiveTest").then(function(t) {
              if (t) setCurrentTest(t);
              else if (currentTest.status !== 'finished') {
                // Test was externally ended
                setCurrentTest(Object.assign({}, currentTest, { status: 'finished' }));
              }
            }).catch(function() {});
            if (currentTest.testId) {
              convexQuery("tests:getTestLeaderboard", { testId: currentTest.testId })
                .then(function(lb) { setLeaderboard(lb || []); })
                .catch(function() {});
            }
          }, 3000);
          return function() { clearInterval(interval); };
        }, [currentTest ? currentTest.testId : null, currentTest ? currentTest.status : null]);

        // Timer countdown
        useEffect(function() {
          if (!currentTest || currentTest.status !== 'active' || !currentTest.endedAt) return;
          var interval = setInterval(function() {
            var remaining = Math.max(0, currentTest.endedAt - Date.now());
            setTimeLeft(remaining);
            if (remaining <= 0) {
              convexMutation("tests:endTest", { testId: currentTest.testId })
                .then(function() {
                  setCurrentTest(Object.assign({}, currentTest, { status: 'finished' }));
                })
                .catch(function() {});
              clearInterval(interval);
            }
          }, 1000);
          return function() { clearInterval(interval); };
        }, [currentTest ? currentTest.testId : null, currentTest ? currentTest.status : null]);

        function getQuestionIdsForMode(mode, modeValue) {
          var questions = typeof questionsDB !== 'undefined' ? questionsDB : [];
          var filtered = questions;
          if (mode === 'examFocus') {
            filtered = questions.filter(function(q) { return q.examFocus; });
          } else if (mode === 'chapter' && modeValue) {
            filtered = questions.filter(function(q) { return q.chapter === parseInt(modeValue); });
          } else if (mode === 'quizGroup' && modeValue) {
            var ranges = { '1-4': [1,2,3,4], '5-7': [5,6,7], '8-10': [8,9,10], '11-14': [11,12,13,14], '15': [15] };
            var chList = ranges[modeValue] || [];
            filtered = questions.filter(function(q) { return chList.indexOf(q.chapter) !== -1; });
          }
          return filtered.map(function(q) { return q.id; });
        }

        function handleCreateTest() {
          if (!testName.trim()) { alert('Please enter a test name'); return; }
          var qIds = getQuestionIdsForMode(testMode, testModeValue);
          if (qIds.length === 0) { alert('No questions found for this mode'); return; }
          setCreating(true);
          convexMutation("tests:createTest", {
            name: testName.trim(),
            mode: testMode,
            modeValue: testModeValue || undefined,
            questionIds: qIds,
            timerMinutes: timer
          }).then(function(result) {
            convexQuery("tests:getActiveTest").then(function(t) {
              setCurrentTest(t);
              setCreating(false);
            });
          }).catch(function(err) {
            alert('Failed to create test: ' + err.message);
            setCreating(false);
          });
        }

        function handleStartTest() {
          if (!currentTest) return;
          convexMutation("tests:startTest", { testId: currentTest.testId })
            .then(function() {
              convexQuery("tests:getActiveTest").then(function(t) { setCurrentTest(t); });
            })
            .catch(function(err) { alert('Failed to start: ' + err.message); });
        }

        function handleEndTest() {
          if (!currentTest) return;
          convexMutation("tests:endTest", { testId: currentTest.testId })
            .then(function() {
              setCurrentTest(Object.assign({}, currentTest, { status: 'finished' }));
              convexQuery("tests:getTestHistory").then(function(h) { setTestHistory(h || []); }).catch(function() {});
            })
            .catch(function(err) { alert('Failed to end: ' + err.message); });
        }

        function handleDeleteTest(testId) {
          if (!confirm('Delete this test and all results?')) return;
          convexMutation("tests:deleteTest", { testId: testId })
            .then(function() {
              if (currentTest && currentTest.testId === testId) { setCurrentTest(null); setLeaderboard([]); }
              convexQuery("tests:getTestHistory").then(function(h) { setTestHistory(h || []); }).catch(function() {});
            })
            .catch(function(err) { alert('Failed: ' + err.message); });
        }

        function handleNewTest() {
          setCurrentTest(null);
          setLeaderboard([]);
          setTestName('');
        }

        var timeSec = Math.ceil(timeLeft / 1000);
        var tMin = Math.floor(timeSec / 60);
        var tSec = timeSec % 60;

        // If no active test, show creation form
        if (!currentTest) {
          return e('div', { className: 'max-w-4xl mx-auto p-4 space-y-4' },
            e('div', { className: 'bg-white rounded-xl shadow-sm p-6' },
              e('h2', { className: 'text-lg font-bold text-gray-800 mb-4' }, 'Create Live Test'),
              e('div', { className: 'space-y-4' },
                e('div', null,
                  e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Test Name'),
                  e('input', {
                    type: 'text', value: testName,
                    onChange: function(ev) { setTestName(ev.target.value); },
                    placeholder: 'e.g. "Chapter 1-4 Quiz"',
                    className: 'w-full px-4 py-2 border rounded-lg text-sm'
                  })
                ),
                e('div', { className: 'grid grid-cols-2 gap-4' },
                  e('div', null,
                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Study Mode'),
                    e('select', {
                      value: testMode,
                      onChange: function(ev) { setTestMode(ev.target.value); setTestModeValue(''); },
                      className: 'w-full px-4 py-2 border rounded-lg text-sm'
                    },
                      e('option', { value: 'examFocus' }, 'Exam Focus'),
                      e('option', { value: 'all' }, 'All Questions'),
                      e('option', { value: 'chapter' }, 'Single Chapter'),
                      e('option', { value: 'quizGroup' }, 'Quiz Group')
                    )
                  ),
                  (testMode === 'chapter') && e('div', null,
                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Chapter'),
                    e('select', {
                      value: testModeValue,
                      onChange: function(ev) { setTestModeValue(ev.target.value); },
                      className: 'w-full px-4 py-2 border rounded-lg text-sm'
                    },
                      e('option', { value: '' }, 'Select...'),
                      [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].map(function(ch) {
                        return e('option', { key: ch, value: ch }, 'Chapter ' + ch);
                      })
                    )
                  ),
                  (testMode === 'quizGroup') && e('div', null,
                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Quiz Group'),
                    e('select', {
                      value: testModeValue,
                      onChange: function(ev) { setTestModeValue(ev.target.value); },
                      className: 'w-full px-4 py-2 border rounded-lg text-sm'
                    },
                      e('option', { value: '' }, 'Select...'),
                      e('option', { value: '1-4' }, 'Quiz 1 (Ch 1-4)'),
                      e('option', { value: '5-7' }, 'Quiz 2 (Ch 5-7)'),
                      e('option', { value: '8-10' }, 'Quiz 3 (Ch 8-10)'),
                      e('option', { value: '11-14' }, 'Quiz 4 (Ch 11-14)'),
                      e('option', { value: '15' }, 'Final (Ch 15)')
                    )
                  )
                ),
                e('div', null,
                  e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Timer (minutes)'),
                  e('div', { className: 'flex gap-2 flex-wrap' },
                    [5, 10, 15, 20, 30, 45, 60].map(function(m) {
                      return e('button', {
                        key: m,
                        onClick: function() { setTimer(m); },
                        className: 'px-4 py-2 rounded-lg text-sm font-medium transition-colors ' + (timer === m ? 'bg-orange-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')
                      }, m + ' min');
                    })
                  )
                ),
                e('div', { className: 'text-sm text-gray-500' },
                  getQuestionIdsForMode(testMode, testModeValue).length + ' questions will be included'
                ),
                e('button', {
                  onClick: handleCreateTest,
                  disabled: creating,
                  className: 'w-full py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold text-lg transition-colors'
                }, creating ? 'Creating...' : 'Create Test')
              )
            ),

            // Test History
            testHistory.length > 0 && e('div', { className: 'bg-white rounded-xl shadow-sm p-6' },
              e('h3', { className: 'font-bold text-gray-800 mb-3' }, 'Past Tests'),
              e('div', { className: 'space-y-2' },
                testHistory.map(function(t) {
                  return e('div', {
                    key: t.testId,
                    className: 'flex items-center justify-between py-2 px-3 rounded-lg bg-gray-50'
                  },
                    e('div', null,
                      e('span', { className: 'font-medium text-gray-800 text-sm' }, t.name),
                      e('span', { className: 'text-xs text-gray-400 ml-2' },
                        new Date(t.createdAt).toLocaleDateString() + ' \u2022 ' + t.participantCount + ' participants'
                      )
                    ),
                    e('div', { className: 'flex gap-2' },
                      e('button', {
                        onClick: function() {
                          setCurrentTest(t);
                          convexQuery("tests:getTestLeaderboard", { testId: t.testId })
                            .then(function(lb) { setLeaderboard(lb || []); })
                            .catch(function() {});
                        },
                        className: 'text-blue-600 hover:text-blue-800 text-xs font-medium'
                      }, 'View'),
                      e('button', {
                        onClick: function() { handleDeleteTest(t.testId); },
                        className: 'text-red-500 hover:text-red-700 text-xs'
                      }, 'Delete')
                    )
                  );
                })
              )
            )
          );
        }

        // Waiting state
        if (currentTest.status === 'waiting') {
          return e('div', { className: 'max-w-2xl mx-auto p-4' },
            e('div', { className: 'bg-white rounded-xl shadow-sm p-8 text-center' },
              e('div', { className: 'text-5xl mb-4' }, '\uD83D\uDCDD'),
              e('h2', { className: 'text-2xl font-bold text-gray-800 mb-2' }, currentTest.name),
              e('p', { className: 'text-gray-500 mb-1' }, currentTest.questionIds.length + ' questions \u2022 ' + currentTest.timerMinutes + ' minutes'),
              e('p', { className: 'text-sm text-gray-400 mb-6' }, 'Students will see "Prepare for Test" on their screens'),
              e('button', {
                onClick: handleStartTest,
                className: 'px-8 py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold text-xl transition-colors'
              }, 'START TEST'),
              e('button', {
                onClick: function() { handleDeleteTest(currentTest.testId); },
                className: 'block mx-auto mt-4 text-red-500 hover:text-red-700 text-sm'
              }, 'Cancel Test')
            )
          );
        }

        // Active or Finished state - show leaderboard
        return e('div', { className: 'max-w-2xl mx-auto p-4 space-y-4' },
          // Timer/status bar
          currentTest.status === 'active' && e('div', {
            className: 'text-center py-3 rounded-xl font-bold text-white text-xl',
            style: { backgroundColor: timeSec < 60 ? '#DC2626' : '#F97316' }
          }, '\u23F0 ' + tMin + ':' + (tSec < 10 ? '0' : '') + tSec + ' remaining'),

          currentTest.status === 'finished' && e('div', {
            className: 'text-center py-3 rounded-xl font-bold text-white text-xl bg-gray-600'
          }, 'Test Finished'),

          // Leaderboard
          e('div', { className: 'bg-white rounded-xl shadow-sm p-6' },
            e('h2', { className: 'text-lg font-bold text-gray-800 mb-4' },
              currentTest.name + ' - Leaderboard'
            ),
            leaderboard.length === 0
              ? e('p', { className: 'text-center text-gray-400 py-8' }, 'Waiting for answers...')
              : e('table', { className: 'w-full text-sm' },
                e('thead', null,
                  e('tr', { className: 'bg-gray-50 border-b' },
                    e('th', { className: 'px-4 py-2 text-left' }, 'Rank'),
                    e('th', { className: 'px-4 py-2 text-left' }, 'Student'),
                    e('th', { className: 'px-4 py-2 text-center' }, 'Score'),
                    e('th', { className: 'px-4 py-2 text-center' }, 'Accuracy')
                  )
                ),
                e('tbody', null,
                  leaderboard.map(function(entry, idx) {
                    var medals = ['\uD83E\uDD47', '\uD83E\uDD48', '\uD83E\uDD49'];
                    var acc = entry.totalAnswered > 0 ? Math.round(entry.accuracy * 100) : 0;
                    return e('tr', {
                      key: idx,
                      className: 'border-b',
                      style: { backgroundColor: idx < 3 ? ['#FEFCE8', '#F0F9FF', '#FFF7ED'][idx] : 'transparent' }
                    },
                      e('td', { className: 'px-4 py-2 font-bold' }, idx < 3 ? medals[idx] : (idx + 1)),
                      e('td', { className: 'px-4 py-2 font-medium' }, entry.displayName),
                      e('td', { className: 'px-4 py-2 text-center font-bold' }, entry.score + '/' + entry.totalAnswered),
                      e('td', { className: 'px-4 py-2 text-center' }, acc + '%')
                    );
                  })
                )
              )
          ),

          // Action buttons
          e('div', { className: 'flex justify-center gap-3' },
            currentTest.status === 'active' && e('button', {
              onClick: handleEndTest,
              className: 'px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium'
            }, 'End Test Early'),
            currentTest.status === 'finished' && e('button', {
              onClick: handleNewTest,
              className: 'px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium'
            }, 'New Test')
          )
        );
      }

      // ============ MAIN APP ============
      function AdminApp() {
        const [theme, setTheme] = useState(getInitialTheme);
        const [activeTab, setActiveTab] = useState('questions');
        const [questions, setQuestions] = useState(loadQuestions);
        const [allCategories, setAllCategories] = useState(loadCategories);
        const [searchTerm, setSearchTerm] = useState('');
        const [categoryFilter, setCategoryFilter] = useState('');
        const [chapterFilter, setChapterFilter] = useState('');
        const [examFocusFilter, setExamFocusFilter] = useState('');
        const [editingQuestion, setEditingQuestion] = useState(null);
        const [isAddingQuestion, setIsAddingQuestion] = useState(false);
        const [showCategoryManager, setShowCategoryManager] = useState(false);
        const [convexStatus, setConvexStatus] = useState(useConvex ? 'connecting' : 'not-configured');

        // Load from Convex on startup (if configured)
        useEffect(function() {
          if (!useConvex) return;

          loadFromConvex(
            function(convexQuestions) {
              if (convexQuestions && convexQuestions.length > 0) {
                // Convex has data - use it
                setQuestions(convexQuestions);
                // Also update localStorage as cache
                try {
                  localStorage.setItem(ADMIN_STORAGE_KEY, JSON.stringify(convexQuestions));
                } catch (err) {}
                // Extract categories
                var cats = [];
                convexQuestions.forEach(function(q) {
                  if (cats.indexOf(q.category) === -1) cats.push(q.category);
                });
                cats.sort();
                setAllCategories(cats);
                try {
                  localStorage.setItem(ADMIN_CATEGORIES_KEY, JSON.stringify(cats));
                } catch (err) {}
                setConvexStatus('connected');
                console.log('Loaded ' + convexQuestions.length + ' questions from Convex');
              } else {
                // Convex is empty - offer to seed it
                setConvexStatus('connected');
                var localQuestions = loadQuestions();
                if (localQuestions.length > 0) {
                  if (confirm('Convex database is empty. Would you like to upload your current ' + localQuestions.length + ' questions to the cloud?\n\nThis will enable cross-device sync.')) {
                    syncToConvex(localQuestions);
                  }
                }
              }
            },
            function(err) {
              // Error connecting to Convex
              console.log('Convex connection error:', err.message);
              setConvexStatus('error');
            }
          );
        }, []);

        // Filter questions
        var filteredQuestions = questions.filter(function(q) {
          // Search filter
          if (searchTerm) {
            var term = searchTerm.toLowerCase();
            var matches = (
              q.question.toLowerCase().indexOf(term) !== -1 ||
              q.hint.toLowerCase().indexOf(term) !== -1 ||
              q.explanation.toLowerCase().indexOf(term) !== -1 ||
              q.options.some(function(o) { return o.toLowerCase().indexOf(term) !== -1; })
            );
            if (!matches) return false;
          }
          // Category filter
          if (categoryFilter && q.category !== categoryFilter) return false;
          // Chapter filter
          if (chapterFilter && (q.chapter || 1) !== parseInt(chapterFilter)) return false;
          // Exam focus filter
          if (examFocusFilter === 'true' && !q.examFocus) return false;
          if (examFocusFilter === 'false' && q.examFocus) return false;
          return true;
        });

        // Sort by ID
        filteredQuestions.sort(function(a, b) { return a.id - b.id; });

        function handleSaveQuestion(formData) {
          var updated;
          if (isAddingQuestion) {
            // Generate new ID
            var maxId = questions.reduce(function(max, q) { return Math.max(max, q.id); }, 0);
            formData.id = maxId + 1;
            updated = questions.concat([formData]);
          } else {
            updated = questions.map(function(q) {
              return q.id === formData.id ? formData : q;
            });
          }
          setQuestions(updated);
          saveQuestions(updated);
          setEditingQuestion(null);
          setIsAddingQuestion(false);
        }

        function handleDeleteQuestion(id) {
          if (!confirm('Are you sure you want to delete question #' + id + '?')) return;
          var updated = questions.filter(function(q) { return q.id !== id; });
          setQuestions(updated);
          saveQuestions(updated);
        }

        function handleAddCategory(name) {
          var updated = allCategories.concat([name]).sort();
          setAllCategories(updated);
          saveCategories(updated);
        }

        function handleDeleteCategory(name) {
          var updated = allCategories.filter(function(c) { return c !== name; });
          setAllCategories(updated);
          saveCategories(updated);
        }

        function getQuestionCountForCategory(cat) {
          return questions.filter(function(q) { return q.category === cat; }).length;
        }

        function handleImport(importedQuestions) {
          // Re-assign IDs to be sequential
          var withIds = importedQuestions.map(function(q, i) {
            return Object.assign({}, q, { id: i + 1 });
          });
          setQuestions(withIds);
          saveQuestions(withIds);
          // Update categories
          var newCats = [];
          withIds.forEach(function(q) {
            if (newCats.indexOf(q.category) === -1) {
              newCats.push(q.category);
            }
          });
          newCats.sort();
          setAllCategories(newCats);
          saveCategories(newCats);
          alert('Successfully imported ' + withIds.length + ' questions!');
        }

        function handleResetToOriginal() {
          // Load from the original backup file (questions-original.js)
          var originalQuestions = loadOriginalQuestions();
          var originalCats = loadOriginalCategories();

          setQuestions(originalQuestions);
          setAllCategories(originalCats);
          saveQuestions(originalQuestions);
          saveCategories(originalCats);

          alert('Successfully reset to original ' + originalQuestions.length + ' questions!\n\nThe study app will now show the original questions.');
        }

        function cycleTheme() {
          var next = theme === 'system' ? 'light' : theme === 'light' ? 'dark' : 'system';
          setTheme(next);
          applyTheme(next);
          try { localStorage.setItem(ADMIN_THEME_KEY, next); } catch (e) {}
        }

        return e('div', { className: 'min-h-screen', style: { backgroundColor: 'var(--bg-primary)', color: 'var(--text-primary)' } },
          // Header
          e(Header, { questionCount: questions.length, convexStatus: convexStatus, theme: theme, onCycleTheme: cycleTheme }),

          // Tab Navigation
          e('div', { style: { backgroundColor: 'var(--bg-card)', borderBottom: '1px solid var(--border-color)' } },
            e('div', { className: 'max-w-7xl mx-auto flex' },
              [
                { key: 'questions', label: 'Questions', icon: '\uD83D\uDCDD' },
                { key: 'students', label: 'Students', icon: '\uD83D\uDC65' },
                { key: 'livetest', label: 'Live Test', icon: '\u23F1\uFE0F' }
              ].map(function(tab) {
                var isActive = activeTab === tab.key;
                return e('button', {
                  key: tab.key,
                  onClick: function() { setActiveTab(tab.key); },
                  className: 'px-6 py-3 text-sm font-medium transition-colors border-b-2',
                  style: isActive
                    ? { borderColor: 'var(--tab-active-border)', color: 'var(--tab-active-text)' }
                    : { borderColor: 'transparent', color: 'var(--tab-text)' }
                }, tab.icon + ' ' + tab.label);
              })
            )
          ),

          // Tab Content
          activeTab === 'questions' && e('div', null,
            // Stats
            e(StatsBar, { questions: questions, categories: allCategories }),
            // Main content
            e('div', { className: 'max-w-7xl mx-auto p-4 space-y-4' },
              // Tools row
              e('div', { className: 'flex flex-col md:flex-row gap-4' },
                e('div', { className: 'flex-1' },
                  e(ExportImportPanel, {
                    questions: questions,
                    onImport: handleImport,
                    onResetToOriginal: handleResetToOriginal
                  })
                ),
                e('div', { className: 'md:w-64' },
                  e('div', { className: 'bg-white border rounded-xl shadow-sm p-4' },
                    e('h3', { className: 'font-bold text-gray-800 mb-3' }, '\uD83D\uDCC2 Categories'),
                    e('button', {
                      onClick: function() { setShowCategoryManager(true); },
                      className: 'w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors text-sm'
                    }, 'Manage Categories'),
                    e('p', { className: 'text-xs text-gray-500 mt-2' },
                      allCategories.length + ' categories'
                    )
                  )
                )
              ),
              e(FilterBar, {
                searchTerm: searchTerm,
                categoryFilter: categoryFilter,
                chapterFilter: chapterFilter,
                examFocusFilter: examFocusFilter,
                categories: allCategories,
                onSearchChange: setSearchTerm,
                onCategoryChange: setCategoryFilter,
                onChapterChange: setChapterFilter,
                onExamFocusChange: setExamFocusFilter,
                onAddQuestion: function() { setIsAddingQuestion(true); }
              }),
              e('div', { className: 'text-sm text-gray-600' },
                'Showing ' + filteredQuestions.length + ' of ' + questions.length + ' questions'
              ),
              e('div', { className: 'bg-white rounded-xl shadow-sm overflow-hidden' },
                filteredQuestions.length === 0 ?
                  e('div', { className: 'p-12 text-center text-gray-500' },
                    e('div', { className: 'text-4xl mb-4' }, '\uD83D\uDD0D'),
                    e('p', null, 'No questions found matching your filters')
                  ) :
                  filteredQuestions.map(function(q) {
                    return e(QuestionRow, {
                      key: q.id,
                      question: q,
                      onEdit: function(q) { setEditingQuestion(q); },
                      onDelete: handleDeleteQuestion
                    });
                  })
              )
            )
          ),

          activeTab === 'students' && e(StudentDashboard, null),

          activeTab === 'livetest' && e(LiveTestPanel, null),

          // Modals (always available)
          editingQuestion && e(QuestionEditor, {
            question: editingQuestion,
            isNew: false,
            categories: allCategories,
            onSave: handleSaveQuestion,
            onCancel: function() { setEditingQuestion(null); }
          }),
          isAddingQuestion && e(QuestionEditor, {
            question: null,
            isNew: true,
            categories: allCategories,
            onSave: handleSaveQuestion,
            onCancel: function() { setIsAddingQuestion(false); }
          }),
          showCategoryManager && e(CategoryManager, {
            categories: allCategories,
            getQuestionCount: getQuestionCountForCategory,
            onAddCategory: handleAddCategory,
            onDeleteCategory: handleDeleteCategory,
            onClose: function() { setShowCategoryManager(false); }
          })
        );
      }

      // Render
      ReactDOM.createRoot(document.getElementById('root')).render(e(AdminApp));
    })();
  </script>
</body>
</html>
