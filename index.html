<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#B91C1C">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Chef's Kitchen | CUL 104 Study Aid</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --warm-cream: #FFF8F0;
      --warm-orange: #F97316;
      --warm-red: #B91C1C;
      --copper: #B87333;
      --brown: #5D4037;
      /* Light mode (default) */
      --bg-primary: #FFF8F0;
      --bg-secondary: #FFFFFF;
      --bg-card: #FFFFFF;
      --text-primary: #1F2937;
      --text-secondary: #4B5563;
      --text-muted: #6B7280;
      --border-color: #E5E7EB;
      --shadow-color: rgba(0,0,0,0.1);
    }
    [data-theme="dark"] {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #1f2937;
      --text-primary: #F3F4F6;
      --text-secondary: #D1D5DB;
      --text-muted: #9CA3AF;
      --border-color: #374151;
      --shadow-color: rgba(0,0,0,0.4);
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg-primary: #1a1a2e;
        --bg-secondary: #16213e;
        --bg-card: #1f2937;
        --text-primary: #F3F4F6;
        --text-secondary: #D1D5DB;
        --text-muted: #9CA3AF;
        --border-color: #374151;
        --shadow-color: rgba(0,0,0,0.4);
      }
    }
    body {
      font-family: 'Nunito', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    h1, h2, h3, .brand { font-family: 'Fredoka', sans-serif; }

    @keyframes gentleFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    @keyframes gentlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    @keyframes celebrate {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-12px) rotate(-3deg); }
      75% { transform: translateY(-12px) rotate(3deg); }
    }
    /* === CONFETTI EXPLOSION FOR BADGE UNLOCK === */
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg) scale(0); opacity: 1; }
      5% { transform: translateY(5vh) rotate(45deg) scale(1); opacity: 1; }
      100% { transform: translateY(115vh) rotate(1080deg) scale(0.5); opacity: 0; }
    }
    @keyframes confettiSway {
      0%, 100% { margin-left: 0; }
      25% { margin-left: 30px; }
      75% { margin-left: -30px; }
    }
    @keyframes badgePop {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      50% { transform: scale(1.4) rotate(15deg); }
      70% { transform: scale(0.85) rotate(-8deg); }
      85% { transform: scale(1.1) rotate(3deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes badgeGlow {
      0%, 100% { box-shadow: 0 0 30px 10px rgba(251, 191, 36, 0.5), 0 0 60px 20px rgba(249, 115, 22, 0.3); }
      50% { box-shadow: 0 0 50px 20px rgba(251, 191, 36, 0.8), 0 0 100px 40px rgba(249, 115, 22, 0.5); }
    }
    @keyframes starBurst {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      50% { transform: scale(1.5) rotate(180deg); opacity: 0.8; }
      100% { transform: scale(2) rotate(360deg); opacity: 0; }
    }
    .confetti-piece {
      position: fixed;
      top: -5%;
      z-index: 55;
      pointer-events: none;
      animation: confettiFall linear forwards, confettiSway ease-in-out infinite;
    }
    .badge-pop-anim { animation: badgePop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
    .badge-glow-anim { animation: badgeGlow 1.5s ease-in-out infinite; }
    .star-burst { animation: starBurst 1s ease-out forwards; }
    @keyframes wobble {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-5deg); }
      75% { transform: rotate(5deg); }
    }
    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
      50% { opacity: 1; transform: scale(1) rotate(180deg); }
    }
    @keyframes steam {
      0% { opacity: 0; transform: translateY(0) scale(0.5); }
      50% { opacity: 0.6; }
      100% { opacity: 0; transform: translateY(-30px) scale(1.2); }
    }

    /* === FANCY HOME SCREEN ANIMATIONS === */
    @keyframes heroFloat {
      0%, 100% { transform: translateY(0) rotate(-1deg); }
      25% { transform: translateY(-12px) rotate(0.5deg); }
      50% { transform: translateY(-6px) rotate(1deg); }
      75% { transform: translateY(-14px) rotate(0deg); }
    }
    @keyframes glowPulse {
      0%, 100% {
        box-shadow: 0 0 15px 5px rgba(249, 115, 22, 0.5), 0 0 30px 10px rgba(249, 115, 22, 0.25);
      }
      50% {
        box-shadow: 0 0 25px 8px rgba(249, 115, 22, 0.7), 0 0 50px 15px rgba(249, 115, 22, 0.35);
      }
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0; transform: scale(0.3); }
      50% { opacity: 1; transform: scale(1.3); }
    }
    @keyframes floatUp {
      0% { transform: translateY(10px) scale(0.7); opacity: 0; }
      20% { opacity: 1; transform: translateY(0) scale(1); }
      80% { opacity: 1; }
      100% { transform: translateY(-100px) scale(0.9); opacity: 0; }
    }
    @keyframes shadowBob {
      0%, 100% { transform: translateX(-50%) scaleX(1) scaleY(1); opacity: 0.6; }
      25% { transform: translateX(-50%) scaleX(0.92) scaleY(0.9); opacity: 0.45; }
      50% { transform: translateX(-50%) scaleX(0.85) scaleY(0.8); opacity: 0.3; }
      75% { transform: translateX(-50%) scaleX(0.9) scaleY(0.85); opacity: 0.4; }
    }

    .chef-hero {
      /* animation now applied via .chef-hero-glow img */
    }
    .chef-hero-container {
      position: relative;
      padding: 30px 20px 40px 20px;
      overflow: visible;
    }
    .chef-hero-glow {
      display: inline-block;
      position: relative;
      z-index: 2;
    }
    .chef-hero-glow img {
      animation: heroFloat 4s ease-in-out infinite, glowPulse 3s ease-in-out infinite;
    }
    .chef-hero-shadow {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 25px;
      background: radial-gradient(ellipse, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.3) 40%, transparent 70%);
      animation: shadowBob 4s ease-in-out infinite;
      border-radius: 50%;
      z-index: 1;
    }
    .sparkle-particle {
      position: absolute;
      pointer-events: none;
      animation: twinkle 2s ease-in-out infinite;
      z-index: 10;
      font-size: 1.5rem;
    }
    .float-icon {
      position: absolute;
      pointer-events: none;
      animation: floatUp 5s ease-out infinite;
      z-index: 3;
      font-size: 1.75rem;
    }

    .chef-idle { animation: gentleFloat 4s ease-in-out infinite; }
    .chef-celebrate { animation: celebrate 0.6s ease-in-out infinite; }
    .chef-encourage { animation: gentlePulse 2s ease-in-out infinite; }
    .chef-sick { animation: wobble 0.5s ease-in-out infinite; }
    .sparkle { animation: sparkle 0.8s ease-out forwards; }
    .steam-particle { animation: steam 2s ease-out infinite; }

    .answer-btn { transition: all 0.2s ease; }
    .answer-btn:hover:not(:disabled) {
      transform: translateX(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .mode-card { transition: all 0.2s ease; }
    .mode-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }

    .kitchen-bg {
      background-color: var(--bg-primary);
      background-image:
        linear-gradient(rgba(255, 248, 240, 0.4), rgba(255, 248, 240, 0.5)),
        url('assets/kitchen-bg.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      transition: background-color 0.3s ease;
    }
    [data-theme="dark"] .kitchen-bg,
    .kitchen-bg.dark-mode {
      background-image:
        linear-gradient(rgba(26, 26, 46, 0.85), rgba(22, 33, 62, 0.9)),
        url('assets/kitchen-bg.jpg');
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .kitchen-bg {
        background-image:
          linear-gradient(rgba(26, 26, 46, 0.85), rgba(22, 33, 62, 0.9)),
          url('assets/kitchen-bg.jpg');
      }
    }

    .progress-ring {
      transition: stroke-dashoffset 0.5s ease;
    }

    /* === DARK MODE UTILITY CLASSES === */
    .card-bg {
      background-color: var(--bg-card);
      transition: background-color 0.3s ease;
    }
    .text-primary {
      color: var(--text-primary);
    }
    .text-secondary {
      color: var(--text-secondary);
    }
    .text-muted {
      color: var(--text-muted);
    }
    .border-themed {
      border-color: var(--border-color);
    }
    /* Special card styles for answer buttons */
    .answer-card-default {
      background-color: #FFFBEB;
      border-color: #FDE68A;
    }
    [data-theme="dark"] .answer-card-default {
      background-color: #292524;
      border-color: #57534e;
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .answer-card-default {
        background-color: #292524;
        border-color: #57534e;
      }
    }
    .answer-card-default:hover:not(:disabled) {
      background-color: #FFF7ED;
      border-color: #FB923C;
    }
    [data-theme="dark"] .answer-card-default:hover:not(:disabled) {
      background-color: #44403c;
      border-color: #F97316;
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .answer-card-default:hover:not(:disabled) {
        background-color: #44403c;
        border-color: #F97316;
      }
    }
    /* Hint section dark mode */
    .hint-section {
      background-color: #FDF4FF;
      border-color: #FDE047;
    }
    [data-theme="dark"] .hint-section {
      background-color: #422006;
      border-color: #854d0e;
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .hint-section {
        background-color: #422006;
        border-color: #854d0e;
      }
    }
    /* Hint tracker dark mode */
    .hint-tracker {
      background: linear-gradient(to right, #FEFCE8, #FEF3C7);
    }
    [data-theme="dark"] .hint-tracker {
      background: linear-gradient(to right, #1c1917, #292524);
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .hint-tracker {
        background: linear-gradient(to right, #1c1917, #292524);
      }
    }
    /* Gray bg for disabled answers */
    .answer-disabled {
      background-color: #F9FAFB;
      border-color: #E5E7EB;
      color: #9CA3AF;
    }
    [data-theme="dark"] .answer-disabled {
      background-color: #1f2937;
      border-color: #374151;
      color: #6B7280;
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) .answer-disabled {
        background-color: #1f2937;
        border-color: #374151;
        color: #6B7280;
      }
    }
  </style>
</head>
<body class="kitchen-bg min-h-screen">
  <div id="root"></div>

  <!-- Questions Database - Default file and original backup for reset functionality -->
  <script src="questions.js"></script>
  <script src="questions-original.js"></script>
  <script src="version.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const useState = React.useState;
      const useEffect = React.useEffect;
      const createElement = React.createElement;

      // ============ CONVEX CLOUD DATABASE CONFIGURATION ============
      // Leland's Convex PRODUCTION deployment - DO NOT CHANGE
      const CONVEX_URL = "https://cautious-monitor-526.convex.cloud";

      // Global connection status - updated by Convex sync
      var convexConnectionStatus = CONVEX_URL ? 'connecting' : 'offline';

      // ============ QUESTIONS LOADING STRATEGY ============
      // Priority: 1. Convex (if configured) -> 2. localStorage -> 3. questions.js file

      const ADMIN_STORAGE_KEY = 'chefKitchenAdminQuestions';
      const ADMIN_CATEGORIES_KEY = 'chefKitchenAdminCategories';

      // Start with questions.js as immediate default (no loading delay)
      var liveQuestionsDB = questionsDB;
      var liveCategories = categories;

      // Check localStorage for any cached data (from admin or previous Convex sync)
      try {
        var savedQuestions = localStorage.getItem(ADMIN_STORAGE_KEY);
        var savedCategories = localStorage.getItem(ADMIN_CATEGORIES_KEY);
        if (savedQuestions) {
          liveQuestionsDB = JSON.parse(savedQuestions);
          liveCategories = savedCategories ? JSON.parse(savedCategories) : categories;
        }
      } catch (e) {
        console.log('Could not load from localStorage, using file defaults');
      }

      // Replace the global references so the rest of the app uses live data
      questionsDB = liveQuestionsDB;
      categories = liveCategories;

      // ============ CONVEX SYNC (if configured) ============
      // This will update questions in the background once Convex responds
      var convexStatusListeners = []; // Listeners for status changes

      function updateConvexStatus(status) {
        convexConnectionStatus = status;
        convexStatusListeners.forEach(function(listener) {
          listener(status);
        });
      }

      function onConvexStatusChange(listener) {
        convexStatusListeners.push(listener);
        return function() {
          convexStatusListeners = convexStatusListeners.filter(function(l) { return l !== listener; });
        };
      }

      // Direct HTTP API calls to Convex (no SDK needed)
      function convexQuery(functionName, args) {
        return fetch(CONVEX_URL + '/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: functionName, args: args || {} })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.status === 'success') return data.value;
          throw new Error(data.errorMessage || 'Query failed');
        });
      }

      function convexMutation(functionName, args) {
        return fetch(CONVEX_URL + '/api/mutation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: functionName, args: args || {} })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.status === 'success') return data.value;
          throw new Error(data.errorMessage || 'Mutation failed');
        });
      }

      // ============ USER SESSION MANAGEMENT ============
      var USER_KEY = 'chefKitchenUser';
      var USER_LAST_ACTIVE = 'chefKitchenLastActive';
      var PERSONAL_DEVICE = 'chefKitchenPersonalDevice';
      var IDLE_TIMEOUT = 30 * 60 * 1000; // 30 minutes

      function loadUser() {
        try {
          var saved = localStorage.getItem(USER_KEY);
          if (saved) return JSON.parse(saved);
        } catch (e) {}
        return null;
      }

      function saveUser(user) {
        try {
          localStorage.setItem(USER_KEY, JSON.stringify(user));
          localStorage.setItem(USER_LAST_ACTIVE, Date.now().toString());
        } catch (e) {}
      }

      function clearUser() {
        try {
          localStorage.removeItem(USER_KEY);
          localStorage.removeItem(USER_LAST_ACTIVE);
        } catch (e) {}
      }

      function updateLastActive() {
        try {
          localStorage.setItem(USER_LAST_ACTIVE, Date.now().toString());
        } catch (e) {}
      }

      function isPersonalDevice() {
        try {
          return localStorage.getItem(PERSONAL_DEVICE) === 'true';
        } catch (e) {}
        return false;
      }

      function setPersonalDevice(val) {
        try {
          localStorage.setItem(PERSONAL_DEVICE, val ? 'true' : 'false');
        } catch (e) {}
      }

      function needsIdentityCheck() {
        if (isPersonalDevice()) return false;
        try {
          var lastActive = parseInt(localStorage.getItem(USER_LAST_ACTIVE) || '0');
          return (Date.now() - lastActive) > IDLE_TIMEOUT;
        } catch (e) {}
        return true;
      }

      // ============ CLOUD SYNC (DEBOUNCED) ============
      var syncTimeout = null;

      function syncProgressToCloud(userId, progress, badges) {
        if (!userId || !CONVEX_URL) return;
        clearTimeout(syncTimeout);
        syncTimeout = setTimeout(function() {
          convexMutation("users:syncProgress", {
            userId: userId,
            progress: progress,
            badges: badges
          }).then(function() {
            console.log('Progress synced to cloud');
          }).catch(function(err) {
            console.log('Cloud sync failed (saved locally):', err.message);
          });
        }, 2000);
      }

      function mergeProgressFromCloud(localProgress, cloudData, localBadges) {
        if (!cloudData || !cloudData.progress || cloudData.progress.totalAnswered === 0) {
          // Cloud is empty — use local
          return { progress: localProgress, badges: localBadges };
        }
        var cloud = cloudData.progress;
        var cloudBadges = cloudData.badges || [];

        // Use whichever has more answers (more recent data)
        var merged;
        if (localProgress.totalAnswered > cloud.totalAnswered) {
          merged = JSON.parse(JSON.stringify(localProgress));
        } else {
          merged = JSON.parse(JSON.stringify(cloud));
        }

        // Always take the max of best-of fields
        merged.bestStreak = Math.max(merged.bestStreak || 0, localProgress.bestStreak || 0, cloud.bestStreak || 0);
        merged.bestNoHintStreak = Math.max(merged.bestNoHintStreak || 0, localProgress.bestNoHintStreak || 0, cloud.bestNoHintStreak || 0);

        // Boolean OR for time-based flags
        merged.studiedEarly = (localProgress.studiedEarly || cloud.studiedEarly) || false;
        merged.studiedLate = (localProgress.studiedLate || cloud.studiedLate) || false;
        merged.studiedWeekend = (localProgress.studiedWeekend || cloud.studiedWeekend) || false;

        // Union badges (never lose a badge)
        var badgeSet = {};
        (localBadges.earned || []).forEach(function(b) { badgeSet[b] = true; });
        cloudBadges.forEach(function(b) { badgeSet[b] = true; });
        var mergedBadges = { earned: Object.keys(badgeSet), newlyEarned: [] };

        return { progress: merged, badges: mergedBadges };
      }

      if (CONVEX_URL) {
        // Fetch questions from Convex and update localStorage cache
        convexQuery("questions:getAll").then(function(convexQuestions) {
          if (convexQuestions && convexQuestions.length > 0) {
            // Convert Convex format to app format
            var formatted = convexQuestions.map(function(q) {
              return {
                id: q.questionId,
                question: q.question,
                options: q.options,
                correct: q.correct,
                hint: q.hint,
                explanation: q.explanation,
                category: q.category,
                examFocus: q.examFocus,
                chapter: q.chapter || 1
              };
            });
            // Cache in localStorage for offline/fast reload
            localStorage.setItem(ADMIN_STORAGE_KEY, JSON.stringify(formatted));
            // Update global questions
            questionsDB = formatted;
            liveQuestionsDB = formatted;
            console.log('Synced ' + formatted.length + ' questions from Convex cloud');
            updateConvexStatus('connected');
          } else {
            // Connected but empty - still counts as connected
            updateConvexStatus('connected');
          }
        }).catch(function(err) {
          console.log('Convex sync failed (using local data):', err.message);
          updateConvexStatus('offline');
        });

        convexQuery("questions:getCategories").then(function(convexCategories) {
          if (convexCategories && convexCategories.length > 0) {
            localStorage.setItem(ADMIN_CATEGORIES_KEY, JSON.stringify(convexCategories));
            categories = convexCategories;
            liveCategories = convexCategories;
          }
        }).catch(function() {});
      } else {
        updateConvexStatus('offline');
      }

      /* QUESTIONS DATABASE REMOVED - Now loaded from questions.js with localStorage override
      const questionsDB_original = [
        // ========== QUIZ #1 ACTUAL QUESTIONS ==========
        {
          id: 1,
          question: "A foodhandler should be excluded from a foodservice establishment if diagnosed with which of the following?",
          options: ["Hepatitis B", "Tuberculosis", "Cancer", "Staphylococcal gastroenteritis"],
          correct: 3,
          hint: "Think about the Big Six pathogens. Which of these conditions can be transmitted through food handling?",
          explanation: "Staphylococcal gastroenteritis is caused by Staph aureus, a Big Six pathogen requiring exclusion.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 2,
          question: "What does the 'A' in FAT TOM stand for?",
          options: ["Additives", "Alkalinity", "Acidity", "Activity"],
          correct: 2,
          hint: "This factor relates to the pH scale and how it affects bacterial growth.",
          explanation: "A = Acidity. Bacteria grow best in foods with pH between 4.6 and 7.5.",
          category: "FAT TOM",
          examFocus: true
        },
        {
          id: 3,
          question: "FAT TOM is an acronym that stands for the...",
          options: [
            "conditions that favor the growth of most foodborne microorganisms",
            "cooking methods that can be used to make food more healthful",
            "process of reducing hazards in the flow of food",
            "six most common foodborne diseases"
          ],
          correct: 0,
          hint: "FAT TOM describes what bacteria NEED. Think: what makes microorganisms multiply?",
          explanation: "FAT TOM describes the six conditions bacteria need to grow: Food, Acidity, Time, Temperature, Oxygen, Moisture.",
          category: "FAT TOM",
          examFocus: true
        },
        {
          id: 4,
          question: "Which one of the following is true of bacteria?",
          options: [
            "Bacteria always live in oxygen-poor environments",
            "Bacteria cannot survive in low temperatures",
            "Bacteria thrive in highly acidic food",
            "Bacteria are the microorganisms that pose the greatest threat to food safety"
          ],
          correct: 3,
          hint: "Consider: Can bacteria survive in freezers? Do all need oxygen? What's the BIGGEST concern in food safety?",
          explanation: "Bacteria pose the greatest threat to food safety. They CAN survive low temps and some thrive without oxygen.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 5,
          question: "All of the following may cause chemical contamination of food, EXCEPT...",
          options: ["a zinc-coated pitcher", "an enamelware food-storage container", "a pewter soup bowl", "a stainless-steel mixing bowl"],
          correct: 3,
          hint: "Think about which metals can react with acidic foods. What material is considered food-safe in commercial kitchens?",
          explanation: "Stainless steel is safe. Zinc, enamelware, and pewter can leach chemicals into acidic foods.",
          category: "Chemical Contamination",
          examFocus: true
        },
        {
          id: 6,
          question: "All of the following are methods to help prevent foodborne illness from seafood, EXCEPT...",
          options: [
            "using only a reputable supplier",
            "using the supplier that is closest to your establishment",
            "receiving fish at 41°F (5°C) or lower",
            "rejecting fish that has thawed and refrozen"
          ],
          correct: 1,
          hint: "What truly matters when choosing suppliers - location or certification/reputation?",
          explanation: "Proximity doesn't ensure safety. Use approved, reputable suppliers regardless of distance.",
          category: "Food Safety",
          examFocus: false
        },
        {
          id: 7,
          question: "Foodhandlers should wash their hands after which activities? 1. Smoking, 2. Chewing gum, 3. Touching hair",
          options: ["3 only", "1 and 2", "1 and 3", "1, 2, and 3"],
          correct: 3,
          hint: "Think about contamination sources. Does touching your face, mouth, or having things near your mouth spread germs?",
          explanation: "Wash hands after ALL these activities. Smoking, chewing gum, and touching hair all contaminate hands.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 8,
          question: "What is the most important reason for foodhandlers to wear clean clothes?",
          options: [
            "Other foodhandlers will enjoy working with them",
            "Dried stains are harder to get clean",
            "Dirty clothes may carry pathogens",
            "Clothes that are washed often last longer"
          ],
          correct: 2,
          hint: "This is a food safety course. What's the safety-related reason for clean uniforms?",
          explanation: "Dirty clothes can harbor and transfer pathogens to food, causing contamination.",
          category: "Personal Hygiene",
          examFocus: false
        },
        {
          id: 9,
          question: "The acidity or alkalinity of food is measured by its...",
          options: ["water activity", "level of aerobic microorganisms", "pH level", "temperature"],
          correct: 2,
          hint: "The 'A' in FAT TOM refers to this measurement on a scale from 0 to 14.",
          explanation: "pH measures acidity/alkalinity. Bacteria grow best between pH 4.6 and 7.5.",
          category: "FAT TOM",
          examFocus: true
        },
        {
          id: 10,
          question: "Which statement about bacteria is INCORRECT?",
          options: [
            "They can be carried by food",
            "They can be carried by people",
            "They are one-celled organisms",
            "They always need oxygen to grow"
          ],
          correct: 3,
          hint: "Think about C. botulinum - does it need air? Consider what 'anaerobic' means.",
          explanation: "NOT all bacteria need oxygen. Anaerobic bacteria (like C. botulinum) grow without it.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 11,
          question: "When must a foodhandler remove their apron?",
          options: ["Before the end of the shift", "When leaving food-preparation areas", "When returning from the washroom", "After cutting meat"],
          correct: 1,
          hint: "Aprons can carry contaminants. When would wearing one outside the kitchen be a problem?",
          explanation: "Remove aprons when leaving prep areas to prevent cross-contamination.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 12,
          question: "The 'flow of food' refers to the...",
          options: [
            "amount of time food is left in storage",
            "proper food-storage methods",
            "path that food travels through an establishment",
            "amount of time it takes to prepare a dish"
          ],
          correct: 2,
          hint: "Think about the word 'flow' - what does it suggest about movement and journey through the kitchen?",
          explanation: "Flow of food is the path food takes from receiving through serving and disposal.",
          category: "Definitions",
          examFocus: false
        },
        {
          id: 13,
          question: "Which toxin is found in predatory tropical reef fish and is NOT destroyed by cooking?",
          options: ["Anisakis simplex", "Ciguatera toxin", "Vibrio parahaemolyticus", "Rotavirus"],
          correct: 1,
          hint: "This is a seafood toxin associated with tropical reef predators. Is it a parasite, bacteria, virus, or toxin?",
          explanation: "Ciguatera toxin from reef fish CANNOT be destroyed by cooking or freezing.",
          category: "Seafood Toxins",
          examFocus: false
        },
        {
          id: 14,
          question: "Which describes toxoplasmosis?",
          options: [
            "Caused by a parasite in contaminated water; linked to raw milk and marine fish",
            "Caused by a parasite that lives in cat feces; linked to undercooked or raw meat",
            "Caused by a virus in contaminated water; linked to shellfish, salads, cold cuts",
            "Caused by a virus in the intestinal tract; linked to raw and ready-to-eat food"
          ],
          correct: 1,
          hint: "The name 'toxoplasma' is associated with a common household pet. Think about what's risky for pregnant women.",
          explanation: "Toxoplasmosis is a parasite from cat feces, commonly linked to undercooked meat.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 15,
          question: "Which type of food would be MOST likely to cause a foodborne illness?",
          options: ["Frozen corn", "Baked potatoes", "Sliced cucumbers", "Instant soup mixes"],
          correct: 1,
          hint: "Think about TCS foods and which of these requires careful temperature control. Which could harbor anaerobic bacteria?",
          explanation: "Baked potatoes are TCS foods that can harbor C. botulinum if temperature-abused.",
          category: "TCS Foods",
          examFocus: true
        },
        {
          id: 16,
          question: "Which disease can be transmitted through food?",
          options: ["AIDS", "Tuberculosis", "Hepatitis A", "Hepatitis C"],
          correct: 2,
          hint: "Review the Big Six pathogens. Which type of Hepatitis is foodborne vs. bloodborne?",
          explanation: "Hepatitis A is foodborne (Big Six). AIDS, TB, and Hep C are NOT transmitted through food.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 17,
          question: "Foodhandlers should wash their hands after which activities? Clearing tables, Taking out trash, Handling chemicals",
          options: ["Clearing tables only", "Taking out trash only", "Handling chemicals only", "All of the above"],
          correct: 3,
          hint: "Consider each activity - do any of them NOT involve touching potentially contaminated surfaces?",
          explanation: "Wash hands after ALL these activities - each involves potential contamination.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 18,
          question: "Pathogens are...",
          options: ["a thick-walled form of bacteria", "microorganisms that cause food to spoil", "microorganisms that cause disease", "a type of fungus"],
          correct: 2,
          hint: "Break down the word: 'patho-' relates to illness/suffering. What do pathogens cause?",
          explanation: "Pathogens are microorganisms that cause disease. Spoilage organisms are different.",
          category: "Definitions",
          examFocus: false
        },
        {
          id: 19,
          question: "Toxins are a natural part of all of the following plants, EXCEPT...",
          options: ["rhubarb leaves", "apricot kernels", "parsley", "fava beans"],
          correct: 2,
          hint: "Think about which of these is commonly used as a garnish with no safety concerns.",
          explanation: "Parsley is safe. Rhubarb leaves (oxalic acid), apricot kernels (cyanide), fava beans contain natural toxins.",
          category: "Chemical Contamination",
          examFocus: false
        },
        {
          id: 20,
          question: "Food with mold that is not a natural part of the food should be...",
          options: ["frozen", "irradiated", "discarded", "used immediately"],
          correct: 2,
          hint: "Mold can spread beyond what's visible and produce toxins. What's the safest action?",
          explanation: "Discard food with unnatural mold. Mold roots and toxins spread beyond visible areas.",
          category: "Food Safety",
          examFocus: false
        },
        {
          id: 21,
          question: "Which statement about hand sanitizers is CORRECT?",
          options: [
            "Hand sanitizers can be used in place of handwashing",
            "Disposable gloves can be used in place of handwashing",
            "Foodhandlers must wait for hand sanitizer to dry before touching food",
            "Foodhandlers can reuse gloves if they wash hands between tasks"
          ],
          correct: 2,
          hint: "Chef Carmel emphasized: sanitizers never replace handwashing. But when used, what's important about application?",
          explanation: "Sanitizer must dry before touching food. NEVER replaces handwashing or allows glove reuse.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 22,
          question: "All of the following are types of food commonly associated with allergies, EXCEPT...",
          options: ["eggs and egg products", "soy and soy products", "melons", "peanuts"],
          correct: 2,
          hint: "Think about the Big 8 allergens. Which of these choices is NOT on that list?",
          explanation: "Melons are NOT a Big 8 allergen. The Big 8 are: milk, eggs, fish, shellfish, wheat, soy, peanuts, tree nuts.",
          category: "Allergens",
          examFocus: true
        },
        {
          id: 23,
          question: "A foodborne illness often caused by contaminated chicken and eggs is...",
          options: ["Bacillus cereus gastroenteritis", "salmonellosis", "Norovirus gastroenteritis", "cyclosporiasis"],
          correct: 1,
          hint: "Think about which bacteria is strongly associated with poultry and eggs in food safety training.",
          explanation: "Salmonellosis is commonly linked to chicken and eggs. Always cook poultry to 165°F.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 24,
          question: "The temperature danger zone is between...",
          options: ["0°F and 212°F", "32°F and 100°F", "41°F and 135°F", "70°F and 125°F"],
          correct: 2,
          hint: "Chef Carmel emphasized this range repeatedly. What are the upper and lower limits where bacteria thrive?",
          explanation: "Danger Zone: 41°F to 135°F (5°C to 57°C). Bacteria grow rapidly in this range.",
          category: "Temperature Control",
          examFocus: true
        },
        {
          id: 25,
          question: "A different form of bacterial cells that can survive some cooking and freezing temperatures are called...",
          options: ["pathogens", "viruses", "spores", "parasites"],
          correct: 2,
          hint: "What form allows bacteria to survive extreme conditions like high heat and freezing?",
          explanation: "Spores are dormant bacterial cells that can survive cooking and freezing.",
          category: "Foodborne Illness",
          examFocus: true
        },

        // ========== ADDITIONAL STUDY GUIDE QUESTIONS ==========
        {
          id: 26,
          question: "At what internal temperature must poultry be cooked to ensure food safety?",
          options: ["145°F (63°C)", "155°F (68°C)", "165°F (74°C)", "175°F (79°C)"],
          correct: 2,
          hint: "Poultry requires the highest cooking temp. Is it closest to 145, 155, 165, or 175?",
          explanation: "Poultry must reach 165°F (74°C) to kill Salmonella and other harmful bacteria.",
          category: "Cooking Temperatures",
          examFocus: true
        },
        {
          id: 27,
          question: "What is the minimum internal cooking temperature for ground beef?",
          options: ["135°F (57°C)", "145°F (63°C)", "155°F (68°C)", "165°F (74°C)"],
          correct: 2,
          hint: "Ground meats require higher temps than whole cuts because grinding spreads bacteria throughout.",
          explanation: "Ground beef requires 155°F (68°C) because grinding spreads bacteria throughout.",
          category: "Cooking Temperatures",
          examFocus: true
        },
        {
          id: 28,
          question: "What is the minimum internal temperature for cooking fish?",
          options: ["125°F (52°C)", "135°F (57°C)", "145°F (63°C)", "155°F (68°C)"],
          correct: 2,
          hint: "Fish and whole cuts of beef share the same minimum temperature. It's less than ground meat.",
          explanation: "Fish must be cooked to 145°F (63°C) for 15 seconds.",
          category: "Cooking Temperatures",
          examFocus: true
        },
        {
          id: 29,
          question: "How long should you scrub your hands and arms when washing?",
          options: ["5 seconds", "10-15 seconds", "20 seconds", "30 seconds"],
          correct: 1,
          hint: "Chef Carmel mentioned this directly in class. It's NOT the total time (20 sec) but the scrubbing portion.",
          explanation: "Scrub for 10-15 seconds. Total handwashing takes at least 20 seconds.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 30,
          question: "What temperature should water be at a hand sink?",
          options: ["70°F", "90°F", "110°F", "135°F"],
          correct: 2,
          hint: "Chef Carmel asked this directly in class - warm enough to be effective but not scalding hot.",
          explanation: "Hand sink water should be at least 110°F for effective handwashing.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 31,
          question: "How often should single-use gloves be changed during continuous use?",
          options: ["Every hour", "Every 2 hours", "Every 4 hours", "Every 8 hours"],
          correct: 2,
          hint: "This matches the time limit for several other food safety rules. Think about how long is too long.",
          explanation: "Change gloves at least every 4 hours during continuous use, or sooner if contaminated.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 32,
          question: "Which symptom indicates a foodhandler should be EXCLUDED (sent home completely)?",
          options: ["Runny nose", "Sore throat", "Jaundice", "Headache"],
          correct: 2,
          hint: "Chef Carmel called one of these 'THE BIG ONE' for exclusion. Which affects eye/skin color?",
          explanation: "Jaundice (yellowing of skin/eyes) requires immediate exclusion and a doctor's note to return.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 33,
          question: "What does ALERT stand for in food defense?",
          options: [
            "Always Look Every Restaurant Thoroughly",
            "Assure, Look, Employees, Reports, Threat",
            "Avoid Letting Everyone Run Through",
            "All Locations Expect Regular Testing"
          ],
          correct: 1,
          hint: "Each letter represents an action: monitoring sources, security, staff, documentation, and emergency plans.",
          explanation: "ALERT: Assure (safe sources), Look (monitor), Employees (know who), Reports (accessible), Threat (have a plan).",
          category: "Food Defense",
          examFocus: true
        },
        {
          id: 34,
          question: "How long can TCS food be stored in the refrigerator before it must be discarded?",
          options: ["3 days", "5 days", "7 days", "10 days"],
          correct: 2,
          hint: "Think about the TCS storage rule. The day you make it counts as day one.",
          explanation: "TCS food can be stored for 7 days max at 41°F or below. Day made counts as Day 1.",
          category: "Food Storage",
          examFocus: false
        },
        {
          id: 35,
          question: "What is the correct order for storing raw foods in a refrigerator (top to bottom)?",
          options: [
            "Poultry, ground meat, whole cuts, seafood, ready-to-eat",
            "Ready-to-eat, seafood, whole cuts, ground meat, poultry",
            "Ground meat, poultry, seafood, whole cuts, ready-to-eat",
            "Ready-to-eat, whole cuts, seafood, ground meat, poultry"
          ],
          correct: 1,
          hint: "Storage order matches cooking temperatures. Foods with highest cook temps go on the bottom. Why?",
          explanation: "Top to bottom by cooking temp: Ready-to-eat, seafood/whole cuts (145°F), ground meat (155°F), poultry (165°F).",
          category: "Food Storage",
          examFocus: false
        },
        {
          id: 36,
          question: "Within what time frame should hot TCS food be cooled from 135°F to 70°F?",
          options: ["1 hour", "2 hours", "4 hours", "6 hours"],
          correct: 1,
          hint: "Two-stage cooling has different time limits. The first stage is shorter because it's more dangerous.",
          explanation: "Stage 1: 135°F to 70°F within 2 hours. Stage 2: 70°F to 41°F within 4 more hours. Total = 6 hours.",
          category: "Cooling",
          examFocus: false
        },
        {
          id: 37,
          question: "How long must a foodhandler be symptom-free from vomiting or diarrhea before returning to work?",
          options: ["12 hours", "24 hours", "48 hours", "72 hours"],
          correct: 1,
          hint: "How long symptom-free is enough to return? Or what else could authorize return?",
          explanation: "Must be symptom-free for 24 hours minimum, or have a doctor's written release.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 38,
          question: "Which of these is NOT one of the Big Eight allergens?",
          options: ["Peanuts", "Tree nuts", "Corn", "Shellfish"],
          correct: 2,
          hint: "The Big 8 allergens are specific. Which common food item here isn't on that list?",
          explanation: "Corn is NOT a Big 8 allergen. The Big 8 are: milk, eggs, fish, shellfish, wheat, soy, peanuts, tree nuts.",
          category: "Allergens",
          examFocus: true
        },
        {
          id: 39,
          question: "Which pathogen is commonly found in cooked rice that has been time-temperature abused?",
          options: ["Salmonella", "E. coli", "Bacillus cereus", "Listeria"],
          correct: 2,
          hint: "Think about 'fried rice syndrome' - which bacteria is famous for growing in reheated rice?",
          explanation: "Bacillus cereus is commonly found in cooked rice, especially fried rice left at unsafe temps.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 40,
          question: "What jewelry is a foodhandler allowed to wear on hands and arms?",
          options: ["Watch only", "Medical bracelet only", "Plain wedding band only", "No jewelry at all"],
          correct: 2,
          hint: "Think minimal: what's the absolute simplest jewelry that could possibly be allowed?",
          explanation: "Only a plain wedding band is allowed. Remove watches, bracelets (including medical), and rings with stones.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 41,
          question: "Which bacteria produces toxins that CANNOT be destroyed by cooking?",
          options: ["Salmonella", "E. coli", "Staphylococcus aureus", "Listeria"],
          correct: 2,
          hint: "Which bacteria produces toxins that are 'heat-stable' - meaning cooking can't destroy them?",
          explanation: "Staph aureus toxins are heat-stable - they survive cooking. Prevention is key!",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 42,
          question: "How often should food contact surfaces be cleaned and sanitized during continuous use?",
          options: ["Every hour", "Every 2 hours", "Every 4 hours", "Every 8 hours"],
          correct: 2,
          hint: "This matches the time limit for glove changes. What's the maximum time between cleanings?",
          explanation: "Clean and sanitize food contact surfaces every 4 hours during continuous use.",
          category: "Sanitation",
          examFocus: false
        },
        {
          id: 43,
          question: "What type of food does the term 'TCS' describe?",
          options: [
            "Foods that are thermally cooked and served",
            "Foods requiring time/temperature control for safety",
            "Foods that are tested, certified, and sealed",
            "Foods with total calorie standards"
          ],
          correct: 1,
          hint: "The letters TCS stand for something about controlling two factors to prevent bacterial growth.",
          explanation: "TCS foods require time and temperature control to prevent bacterial growth.",
          category: "TCS Foods",
          examFocus: true
        },
        {
          id: 44,
          question: "When must you wash hands BEFORE starting a task?",
          options: [
            "Before handling raw meat",
            "Before putting on single-use gloves",
            "Before using the restroom",
            "Before taking out trash"
          ],
          correct: 1,
          hint: "Think about the sequence: what must happen BEFORE putting on protection?",
          explanation: "Always wash hands before putting on gloves. Gloves are NOT a substitute for handwashing.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 45,
          question: "What is a key symptom of Hepatitis A?",
          options: ["Rash on arms", "Jaundice (yellowing of eyes/skin)", "Muscle spasms", "Hair loss"],
          correct: 1,
          hint: "This virus attacks the liver. What visible symptom indicates liver problems?",
          explanation: "Hepatitis A causes jaundice (yellowing of eyes and skin), along with fever and weakness.",
          category: "Foodborne Illness",
          examFocus: true
        },

        // ========== ADDITIONAL POWERPOINT QUESTIONS ==========
        {
          id: 46,
          question: "When is a foodborne illness considered an OUTBREAK?",
          options: [
            "When one person gets sick from food",
            "When two or more people have the same symptoms after eating the same food",
            "When food is found to be contaminated",
            "When a restaurant fails an inspection"
          ],
          correct: 1,
          hint: "How many people must be affected before it's classified as an outbreak? More than just one.",
          explanation: "An outbreak occurs when two or more people have the same symptoms after eating the same food, confirmed by investigation.",
          category: "Definitions",
          examFocus: true
        },
        {
          id: 47,
          question: "Which of the following is NOT one of the Big Six pathogens?",
          options: ["Norovirus", "Hepatitis A", "Listeria monocytogenes", "Shigella spp."],
          correct: 2,
          hint: "Review the Big Six pathogens. Which of these bacteria is NOT on that high-alert list?",
          explanation: "Listeria is NOT a Big Six pathogen. The Big Six are highly infectious and require employee exclusion.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 48,
          question: "What is the 'O' in FAT TOM?",
          options: ["Odor", "Oxygen", "Organic matter", "Outbreak"],
          correct: 1,
          hint: "This FAT TOM factor relates to whether bacteria need air to survive.",
          explanation: "O = Oxygen. Some bacteria need it to grow, while others (anaerobic) grow without it.",
          category: "FAT TOM",
          examFocus: true
        },
        {
          id: 49,
          question: "What is the 'M' in FAT TOM?",
          options: ["Microorganisms", "Moisture", "Minerals", "Movement"],
          correct: 1,
          hint: "This FAT TOM factor relates to water activity - bacteria need this to survive.",
          explanation: "M = Moisture. Bacteria grow well in food with high water activity (aw of 0.85+).",
          category: "FAT TOM",
          examFocus: true
        },
        {
          id: 50,
          question: "Which populations are at HIGH RISK for foodborne illness?",
          options: [
            "Athletes and teenagers",
            "Preschool children, elderly, and immunocompromised people",
            "Adults aged 25-45",
            "People who eat organic food"
          ],
          correct: 1,
          hint: "Think about who has weaker immune systems - which age groups and conditions?",
          explanation: "High-risk populations: preschool-age children, elderly people, and those with compromised immune systems.",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 51,
          question: "How should a wound on a food handler's FINGER be covered?",
          options: [
            "Just a bandage",
            "An impermeable bandage AND a single-use glove",
            "Nothing - they should not work",
            "Tape only"
          ],
          correct: 1,
          hint: "Wounds in this location need extra protection. What two layers are required?",
          explanation: "Wounds on hand, finger, or wrist must be covered with an impermeable bandage AND a single-use glove.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 52,
          question: "What is cross-contamination?",
          options: [
            "When food is cooked at the wrong temperature",
            "When pathogens transfer from one surface or food to another",
            "When food is stored too long",
            "When chemicals mix with food"
          ],
          correct: 1,
          hint: "This occurs when harmful things move from one food or surface to another. Think drips, hands, cutting boards.",
          explanation: "Cross-contamination occurs when pathogens transfer from one surface or food to another.",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 53,
          question: "What is time-temperature abuse?",
          options: [
            "Cooking food too quickly",
            "When food stays too long at temperatures that allow pathogen growth",
            "Using a broken thermometer",
            "Serving food too hot"
          ],
          correct: 1,
          hint: "This term combines two factors: how long food sits and at what temperature.",
          explanation: "Time-temperature abuse occurs when food is left too long in the temperature danger zone (41°F-135°F).",
          category: "Temperature Control",
          examFocus: true
        },
        {
          id: 54,
          question: "Bacteria grow MOST rapidly between which temperatures?",
          options: ["32°F - 41°F", "41°F - 70°F", "70°F - 125°F", "135°F - 165°F"],
          correct: 2,
          hint: "While bacteria grow in the full danger zone, there's a narrower range where growth is FASTEST.",
          explanation: "While the danger zone is 41-135°F, bacteria grow MOST rapidly between 70°F and 125°F.",
          category: "Temperature Control",
          examFocus: true
        },
        {
          id: 55,
          question: "Which of the following is a TCS food?",
          options: ["Bread", "Dried pasta", "Sliced melons", "Crackers"],
          correct: 2,
          hint: "Which of these has been processed in a way that exposes interior surfaces to bacteria?",
          explanation: "Sliced melons are TCS foods and require time/temperature control for safety.",
          category: "TCS Foods",
          examFocus: true
        },
        {
          id: 56,
          question: "Garlic-and-oil mixtures are dangerous because they can support growth of...",
          options: ["Salmonella", "E. coli", "Clostridium botulinum", "Norovirus"],
          correct: 2,
          hint: "Oil creates an oxygen-free environment. What anaerobic bacteria thrives in such conditions?",
          explanation: "Garlic-and-oil mixtures can support Clostridium botulinum, which grows without oxygen.",
          category: "TCS Foods",
          examFocus: true
        },
        {
          id: 57,
          question: "Food handlers must wash hands in...",
          options: [
            "Any available sink",
            "A sink designated for handwashing only",
            "The dishwashing sink when not in use",
            "The prep sink"
          ],
          correct: 1,
          hint: "There's a specific type of sink that must be used - not dish, prep, or mop sinks.",
          explanation: "Hands must be washed in a sink designated ONLY for handwashing.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 58,
          question: "Foodhandlers diagnosed with a Big Six illness...",
          options: [
            "Can work if they wear gloves",
            "Can work in non-food areas only",
            "Cannot work in a foodservice operation while sick",
            "Can work after taking medication"
          ],
          correct: 2,
          hint: "The Big Six illnesses are highly infectious. Can these workers be in the building at all?",
          explanation: "Food handlers with Big Six illnesses cannot work in foodservice while they are sick.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 59,
          question: "Which virus is the leading cause of foodborne illness?",
          options: ["Hepatitis A", "Norovirus", "Rotavirus", "HIV"],
          correct: 1,
          hint: "This virus is extremely contagious and is part of the Big Six. Which one causes the most outbreaks?",
          explanation: "Norovirus is the leading cause of foodborne illness outbreaks in the US.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 60,
          question: "NEVER handle ready-to-eat food with bare hands when serving...",
          options: [
            "Adults only",
            "Takeout orders",
            "High-risk populations",
            "Catered events"
          ],
          correct: 2,
          hint: "For which group is bare-hand contact with ready-to-eat food absolutely prohibited?",
          explanation: "Never use bare hands on ready-to-eat food when serving high-risk populations.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 61,
          question: "What temperature must reheated food reach?",
          options: ["135°F (57°C)", "145°F (63°C)", "155°F (68°C)", "165°F (74°C)"],
          correct: 3,
          hint: "Reheated food must reach the same temperature as poultry. What is that temp?",
          explanation: "Reheated food must reach 165°F (74°C) within 2 hours.",
          category: "Cooking Temperatures",
          examFocus: true
        },
        {
          id: 62,
          question: "Toxins produced by bacteria...",
          options: [
            "Are always destroyed by cooking",
            "Cannot be destroyed by cooking",
            "Only form in cold temperatures",
            "Are visible to the naked eye"
          ],
          correct: 1,
          hint: "Chef Carmel emphasized that once toxins form, what options do you have? Think about heat resistance.",
          explanation: "Bacterial toxins CANNOT be destroyed by cooking. Prevention is the only solution.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 63,
          question: "The five common risk factors for foodborne illness include all EXCEPT...",
          options: [
            "Purchasing from unsafe sources",
            "Holding food at incorrect temperatures",
            "Using expensive ingredients",
            "Poor personal hygiene"
          ],
          correct: 2,
          hint: "Four of these are actual food safety risks. Which one doesn't affect food safety at all?",
          explanation: "The five risk factors are: unsafe sources, failing to cook properly, incorrect temps, contaminated equipment, poor hygiene.",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 64,
          question: "Which bacteria is commonly found in the nose of 30-50% of healthy adults?",
          options: ["Salmonella", "E. coli", "Staphylococcus aureus", "Listeria"],
          correct: 2,
          hint: "This bacteria lives on skin and can be found in many healthy people's noses.",
          explanation: "Staphylococcus aureus is carried in the nose of 30-50% of healthy adults and on skin of 20-35%.",
          category: "Foodborne Illness",
          examFocus: true
        },
        {
          id: 65,
          question: "AIDS, Tuberculosis, and Hepatitis B...",
          options: [
            "Are foodborne illnesses",
            "Require employee exclusion",
            "Are NOT transmitted through food",
            "Are part of the Big Six"
          ],
          correct: 2,
          hint: "Consider how these diseases actually spread. Are any of them transmitted through food?",
          explanation: "AIDS, TB, and Hep B/C are NOT transmitted through food. Employees with these have ADA protections.",
          category: "Food Safety",
          examFocus: false
        },

        // ========== WEEK 5 - CLASS 6 QUESTIONS ==========
        {
          id: 66,
          question: "How long should shellfish identification tags be kept on file?",
          options: ["30 days", "60 days", "90 days", "120 days"],
          correct: 2,
          hint: "Shellfish tags help trace illness outbreaks. How long must they be retained?",
          explanation: "Shellfish tags must be kept for 90 days to track sources if someone gets sick.",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 67,
          question: "At what temperature should shellfish, milk, and eggs be received?",
          options: ["32°F or below", "41°F or below", "45°F or below", "50°F or below"],
          correct: 2,
          hint: "These items have a slightly higher receiving temperature but must cool down within 4 hours.",
          explanation: "Shellfish, milk, and eggs can be received at 45°F but must reach 41°F within 4 hours.",
          category: "Temperature Control",
          examFocus: true
        },
        {
          id: 68,
          question: "Why should you REJECT frozen food with ice crystals on packaging?",
          options: [
            "The food is too cold",
            "It indicates the food has been thawed and refrozen",
            "Ice crystals are a sign of mold",
            "The packaging is damaged"
          ],
          correct: 1,
          hint: "What do ice crystals on frozen packaging indicate about the temperature history of the food?",
          explanation: "Ice crystals indicate temperature abuse - the food was thawed and refrozen, allowing bacteria to grow.",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 69,
          question: "What is the correct procedure for covering an infected wound on a food handler's finger?",
          options: [
            "Just a bandage",
            "Bandage and tape",
            "Impermeable cover and single-use glove",
            "Nothing - they cannot work"
          ],
          correct: 2,
          hint: "The key term here is 'impermeable' - what does that mean for wound coverage?",
          explanation: "Wounds on hand/finger/wrist need an impermeable (waterproof) cover plus a single-use glove.",
          category: "Personal Hygiene",
          examFocus: true
        },
        {
          id: 70,
          question: "At what temperature is the Ice Point method used to calibrate thermometers?",
          options: ["0°F", "32°F", "41°F", "70°F"],
          correct: 1,
          hint: "This method uses the freezing point of water. What temperature is that?",
          explanation: "Ice Point calibration uses 32°F (ice water). Boiling Point calibration uses 212°F.",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 71,
          question: "Food thermometers must be accurate to within...",
          options: ["±1°F", "±2°F", "±3°F", "±5°F"],
          correct: 1,
          hint: "Food thermometers have stricter accuracy requirements than air thermometers.",
          explanation: "Food thermometers must be accurate within ±2°F (or ±1°C).",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 72,
          question: "What is the minimum height food must be stored off the floor?",
          options: ["2 inches", "4 inches", "6 inches", "12 inches"],
          correct: 2,
          hint: "This allows for cleaning access underneath and visibility for pests.",
          explanation: "Food storage must be at least 6 inches off the floor for cleaning access and pest visibility.",
          category: "Food Storage",
          examFocus: true
        },
        {
          id: 73,
          question: "When receiving a recalled food item, you should...",
          options: [
            "Throw it away immediately",
            "Use it quickly before it spoils",
            "Remove it, label 'Do Not Use,' and wait for vendor instructions",
            "Return it to the delivery driver"
          ],
          correct: 2,
          hint: "What's the proper procedure? Vendor may need the product for testing or credit.",
          explanation: "Remove recalled items, separate and label them 'Do Not Use,' then wait for vendor instructions.",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 74,
          question: "What does ROP stand for?",
          options: [
            "Rapid Oxygen Processing",
            "Reduced Oxygen Packaging",
            "Required Operating Procedure",
            "Restaurant Operations Protocol"
          ],
          correct: 1,
          hint: "This type of packaging removes air to extend shelf life - think vacuum-sealed products.",
          explanation: "ROP (Reduced Oxygen Packaging) removes air to extend shelf life, like vacuum-sealed/cryovac packaging.",
          category: "Definitions",
          examFocus: false
        },
        {
          id: 75,
          question: "Which thermometer should be used to check the temperature of vacuum-packed ground beef?",
          options: ["Bimetallic stem thermometer", "Thermocouple probe", "Infrared thermometer", "Candy thermometer"],
          correct: 2,
          hint: "Which thermometer can read temperature without breaking the seal on packaging?",
          explanation: "Infrared thermometers check surface temperature of packaged items without breaking the seal.",
          category: "Food Safety",
          examFocus: true
        },

        // ========== WEEK 5 - CLASS 7 QUESTIONS ==========
        {
          id: 76,
          question: "TCS foods must be used or discarded within how many days?",
          options: ["3 days", "5 days", "7 days", "10 days"],
          correct: 2,
          hint: "Remember the TCS storage rule - the day made counts as day one.",
          explanation: "TCS foods must be used or thrown out within 7 days. Count the day made as Day 1.",
          category: "TCS Foods",
          examFocus: true
        },
        {
          id: 77,
          question: "When combining foods made on different dates, the discard date should be based on...",
          options: [
            "The newest ingredient",
            "The oldest ingredient",
            "The average of all dates",
            "The date of combining"
          ],
          correct: 1,
          hint: "When mixing ingredients, safety requires using which date for the discard deadline?",
          explanation: "Always use the OLDEST/EARLIEST ingredient date to determine the discard date.",
          category: "TCS Foods",
          examFocus: true
        },
        {
          id: 78,
          question: "What does FIFO stand for?",
          options: ["First In, First Out", "Food Is For Others", "Frozen Items First Ordered", "Final Inspection For Operations"],
          correct: 0,
          hint: "This inventory system ensures older products get used before newer ones.",
          explanation: "FIFO = First In, First Out. Use oldest products first to prevent spoilage.",
          category: "Food Storage",
          examFocus: true
        },
        {
          id: 79,
          question: "In a refrigerator, where should raw chicken be stored?",
          options: ["Top shelf", "Middle shelf", "Second from bottom", "Bottom shelf"],
          correct: 3,
          hint: "Raw poultry requires the highest cooking temperature. Where should it go to prevent drips?",
          explanation: "Raw poultry goes on the bottom shelf because it has the highest cooking temperature (165°F).",
          category: "Food Storage",
          examFocus: true
        },
        {
          id: 80,
          question: "What temperature must running water be when thawing food?",
          options: ["32°F or below", "50°F or below", "70°F or below", "Any temperature"],
          correct: 2,
          hint: "Running water for thawing has a maximum temperature limit to prevent bacterial growth.",
          explanation: "Running water used for thawing must be 70°F or below to prevent bacterial growth.",
          category: "Temperature Control",
          examFocus: true
        },
        {
          id: 81,
          question: "After defrosting food in a microwave, you must...",
          options: [
            "Let it rest for 5 minutes",
            "Cook it immediately",
            "Refrigerate it",
            "Check the temperature"
          ],
          correct: 1,
          hint: "Microwave thawing can cause parts of the food to enter the danger zone. What must happen next?",
          explanation: "Food thawed in a microwave must be cooked immediately because parts may enter the danger zone.",
          category: "Temperature Control",
          examFocus: true
        },
        {
          id: 82,
          question: "Before vacuum-packaging (ROP) fresh fish, you must...",
          options: ["Cook it first", "Freeze it first", "Salt it first", "Wash it first"],
          correct: 1,
          hint: "Fish in ROP packaging can grow anaerobic bacteria. What step prevents this?",
          explanation: "Fish must be frozen before ROP to prevent growth of anaerobic bacteria (which don't need oxygen).",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 83,
          question: "What is the minimum internal cooking temperature for ratites (ostrich, emu)?",
          options: ["145°F", "155°F", "165°F", "175°F"],
          correct: 1,
          hint: "Ratites share a cooking temperature with another category of meat. Which category?",
          explanation: "Ratites (ostrich, emu) must be cooked to 155°F, the same as ground meats.",
          category: "Cooking Temperatures",
          examFocus: true
        },
        {
          id: 84,
          question: "What should NOT be served to high-risk populations like preschool children?",
          options: ["Scrambled eggs", "Hard-boiled eggs", "Over easy eggs", "Egg salad"],
          correct: 2,
          hint: "Which egg preparation leaves the yolk runny and undercooked?",
          explanation: "Over easy eggs (runny yolks) should not be served to high-risk populations.",
          category: "Food Safety",
          examFocus: true
        },
        {
          id: 85,
          question: "In the 2-stage cooling process, food must cool from 135°F to 70°F within...",
          options: ["1 hour", "2 hours", "4 hours", "6 hours"],
          correct: 1,
          hint: "Stage 1 cooling is faster because the higher temperature range is more dangerous.",
          explanation: "Stage 1: 135°F→70°F in 2 hours. Stage 2: 70°F→41°F in 4 more hours.",
          category: "Cooling",
          examFocus: true
        },
        {
          id: 86,
          question: "What is the total time allowed to cool food from 135°F to 41°F?",
          options: ["2 hours", "4 hours", "6 hours", "8 hours"],
          correct: 2,
          hint: "Add up Stage 1 and Stage 2 time limits to get the total cooling time.",
          explanation: "Total cooling time from 135°F to 41°F is 6 hours maximum (2 hours + 4 hours).",
          category: "Cooling",
          examFocus: true
        },
        {
          id: 87,
          question: "How often should food temperatures be checked during service/holding?",
          options: ["Every 30 minutes", "Every hour", "Every 2 hours", "Every 4 hours"],
          correct: 2,
          hint: "How frequently should you verify food is staying at safe temperatures?",
          explanation: "Food temperatures should be checked every 2 hours during holding/service.",
          category: "Temperature Control",
          examFocus: true
        },
        {
          id: 88,
          question: "Where should ice cream scoops be stored between uses?",
          options: ["On a clean towel", "In sanitizer solution", "In running water", "In the freezer"],
          correct: 2,
          hint: "Think about ice cream shops - what keeps the scoops clean between customers?",
          explanation: "Ice cream scoops should be stored in running water between uses to keep them clean.",
          category: "Sanitation",
          examFocus: true
        },
        {
          id: 89,
          question: "At a buffet, can guests reuse their plates?",
          options: ["Yes, always", "Yes, if wiped clean", "No, they must get a new plate", "Only for dessert"],
          correct: 2,
          hint: "Think about cross-contamination. What touches food directly vs. what only touches drinks?",
          explanation: "Guests must get new plates and silverware at buffets. Only cups/glasses may be reused.",
          category: "Sanitation",
          examFocus: true
        },
        {
          id: 90,
          question: "What does HACCP stand for?",
          options: [
            "Health And Cleanliness Control Program",
            "Hazard Analysis Critical Control Point",
            "Hot And Cold Cooking Procedures",
            "Handling And Controlling Contaminated Products"
          ],
          correct: 1,
          hint: "This food safety system focuses on identifying dangers and the points where they can be controlled.",
          explanation: "HACCP = Hazard Analysis Critical Control Point - a systematic approach to food safety.",
          category: "Definitions",
          examFocus: true
        },
        {
          id: 91,
          question: "What is the minimum hot holding temperature for cooked vegetables?",
          options: ["125°F", "135°F", "145°F", "155°F"],
          correct: 1,
          hint: "All hot foods share the same minimum holding temperature - what is it?",
          explanation: "All hot foods, including vegetables, must be held at 135°F or above.",
          category: "Temperature Control",
          examFocus: true
        },
        {
          id: 92,
          question: "Cold food can be held without temperature control for up to...",
          options: ["2 hours", "4 hours", "6 hours", "8 hours"],
          correct: 2,
          hint: "Cold food without temperature control has a maximum time limit with specific temperature requirements.",
          explanation: "Cold food can be held without temp control for 6 hours if it starts at 41°F and stays below 70°F.",
          category: "Temperature Control",
          examFocus: true
        },
        {
          id: 93,
          question: "The proper refrigerator storage order from TOP to BOTTOM is...",
          options: [
            "Poultry, ground meat, fish, ready-to-eat",
            "Ready-to-eat, fish, whole meats, ground meats, poultry",
            "Ground meats, poultry, fish, ready-to-eat",
            "Fish, poultry, ground meats, ready-to-eat"
          ],
          correct: 1,
          hint: "Foods stored by cooking temperature - safest (ready-to-eat) on top, highest cook temp on bottom.",
          explanation: "Top to bottom: Ready-to-eat, seafood (145°F), whole meats, ground meats (155°F), poultry (165°F).",
          category: "Food Storage",
          examFocus: true
        }
      ];
      END OF QUESTIONS DATABASE */

      // questionsDB and categories are now:
      // 1. Loaded from localStorage if admin has made edits (LIVE changes)
      // 2. Fall back to questions.js if no localStorage data
      // Professor can edit questions at /admin.html and changes appear immediately!

      // ============ STORAGE HELPERS ============
      const STORAGE_KEY = 'chefKitchenProgress';

      function loadProgress() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            var parsed = JSON.parse(saved);
            // Ensure hint tracking fields exist for existing users
            if (parsed.hintsUsed === undefined) parsed.hintsUsed = 0;
            if (parsed.correctWithoutHint === undefined) parsed.correctWithoutHint = 0;
            if (parsed.currentNoHintStreak === undefined) parsed.currentNoHintStreak = 0;
            if (parsed.bestNoHintStreak === undefined) parsed.bestNoHintStreak = 0;
            return parsed;
          }
        } catch (e) {
          console.log('Could not load progress');
        }
        return {
          totalAnswered: 0,
          totalCorrect: 0,
          categoryStats: {},
          questionHistory: {},
          hintsUsed: 0,
          correctWithoutHint: 0,
          currentNoHintStreak: 0,
          bestNoHintStreak: 0
        };
      }

      function saveProgress(progress) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
        } catch (e) {
          console.log('Could not save progress');
        }
      }

      // ============ BADGES SYSTEM ============
      const BADGES_KEY = 'chefKitchenBadges';

      // Badge definitions - id, name, icon, description, requirement check function
      const badgeDefinitions = [
        // === STREAK BADGES ===
        { id: 'streak5', name: 'On Fire', icon: '🔥', description: 'Answer 5 in a row correctly', category: 'Streaks',
          check: function(p) { return p.currentStreak >= 5; } },
        { id: 'streak10', name: 'Unstoppable', icon: '⚡', description: 'Answer 10 in a row correctly', category: 'Streaks',
          check: function(p) { return p.currentStreak >= 10; } },
        { id: 'streak20', name: 'Perfect Chef', icon: '👨‍🍳', description: 'Answer 20 in a row correctly', category: 'Streaks',
          check: function(p) { return p.currentStreak >= 20; } },
        { id: 'streak50', name: 'Legendary', icon: '🏆', description: 'Answer 50 in a row correctly', category: 'Streaks',
          check: function(p) { return p.currentStreak >= 50; } },

        // === VOLUME BADGES ===
        { id: 'first', name: 'First Bite', icon: '🍴', description: 'Answer your first question', category: 'Progress',
          check: function(p) { return p.totalAnswered >= 1; } },
        { id: 'q10', name: 'Getting Started', icon: '📚', description: 'Answer 10 questions', category: 'Progress',
          check: function(p) { return p.totalAnswered >= 10; } },
        { id: 'q50', name: 'Dedicated Student', icon: '🎓', description: 'Answer 50 questions', category: 'Progress',
          check: function(p) { return p.totalAnswered >= 50; } },
        { id: 'q100', name: 'Study Master', icon: '📖', description: 'Answer 100 questions', category: 'Progress',
          check: function(p) { return p.totalAnswered >= 100; } },
        { id: 'q250', name: 'Knowledge Seeker', icon: '🧠', description: 'Answer 250 questions', category: 'Progress',
          check: function(p) { return p.totalAnswered >= 250; } },
        { id: 'q500', name: 'Quiz Champion', icon: '🏅', description: 'Answer 500 questions', category: 'Progress',
          check: function(p) { return p.totalAnswered >= 500; } },

        // === NO-HINT BADGES ===
        { id: 'nohint5', name: 'Independent', icon: '💪', description: 'Get 5 correct without hints', category: 'No Hints',
          check: function(p) { return p.correctWithoutHint >= 5; } },
        { id: 'nohint25', name: 'Self-Reliant', icon: '🎯', description: 'Get 25 correct without hints', category: 'No Hints',
          check: function(p) { return p.correctWithoutHint >= 25; } },
        { id: 'nohint50', name: 'No Help Needed', icon: '🦸', description: 'Get 50 correct without hints', category: 'No Hints',
          check: function(p) { return p.correctWithoutHint >= 50; } },
        { id: 'nohintstreak10', name: 'Flying Solo', icon: '✈️', description: '10 in a row without hints', category: 'No Hints',
          check: function(p) { return p.bestNoHintStreak >= 10; } },

        // === ACCURACY BADGES ===
        { id: 'acc70', name: 'Passing Grade', icon: '✓', description: 'Achieve 70% accuracy (min 20 questions)', category: 'Accuracy',
          check: function(p) { return p.totalAnswered >= 20 && (p.totalCorrect / p.totalAnswered) >= 0.70; } },
        { id: 'acc80', name: 'Honor Roll', icon: '⭐', description: 'Achieve 80% accuracy (min 30 questions)', category: 'Accuracy',
          check: function(p) { return p.totalAnswered >= 30 && (p.totalCorrect / p.totalAnswered) >= 0.80; } },
        { id: 'acc90', name: 'Dean\'s List', icon: '🌟', description: 'Achieve 90% accuracy (min 50 questions)', category: 'Accuracy',
          check: function(p) { return p.totalAnswered >= 50 && (p.totalCorrect / p.totalAnswered) >= 0.90; } },
        { id: 'acc95', name: 'Valedictorian', icon: '💎', description: 'Achieve 95% accuracy (min 75 questions)', category: 'Accuracy',
          check: function(p) { return p.totalAnswered >= 75 && (p.totalCorrect / p.totalAnswered) >= 0.95; } },

        // === CATEGORY MASTERY ===
        { id: 'catmaster1', name: 'Specialist', icon: '🔬', description: 'Master 1 category (90%+, min 5 questions)', category: 'Mastery',
          check: function(p) { return countMasteredCategories(p) >= 1; } },
        { id: 'catmaster3', name: 'Multi-talented', icon: '🎭', description: 'Master 3 categories', category: 'Mastery',
          check: function(p) { return countMasteredCategories(p) >= 3; } },
        { id: 'catmaster5', name: 'Renaissance Chef', icon: '👑', description: 'Master 5 categories', category: 'Mastery',
          check: function(p) { return countMasteredCategories(p) >= 5; } },
        { id: 'catmasterall', name: 'Complete Master', icon: '🎖️', description: 'Master ALL categories', category: 'Mastery',
          check: function(p) { var total = Object.keys(p.categoryStats || {}).length; return total > 0 && countMasteredCategories(p) >= total; } },

        // === EXAM FOCUS BADGES ===
        { id: 'examfocus10', name: 'Exam Ready', icon: '📝', description: 'Get 10 Exam Focus questions correct', category: 'Exam',
          check: function(p) { return (p.examFocusCorrect || 0) >= 10; } },
        { id: 'examfocus25', name: 'Test Prep Pro', icon: '📋', description: 'Get 25 Exam Focus questions correct', category: 'Exam',
          check: function(p) { return (p.examFocusCorrect || 0) >= 25; } },
        { id: 'examfocusall', name: 'Exam Champion', icon: '🏆', description: 'Answer ALL Exam Focus questions correctly', category: 'Exam',
          check: function(p) { var total = questionsDB.filter(function(q) { return q.examFocus; }).length; return (p.examFocusCorrect || 0) >= total; } },

        // === TIME-BASED FUN BADGES ===
        { id: 'earlybird', name: 'Early Bird', icon: '🌅', description: 'Study before 7 AM', category: 'Fun',
          check: function(p) { return p.studiedEarly; } },
        { id: 'nightowl', name: 'Night Owl', icon: '🦉', description: 'Study after 10 PM', category: 'Fun',
          check: function(p) { return p.studiedLate; } },
        { id: 'weekend', name: 'Weekend Warrior', icon: '⚔️', description: 'Study on a weekend', category: 'Fun',
          check: function(p) { return p.studiedWeekend; } },

        // === CHAPTER PROGRESS BADGES ===
        { id: 'ch1done', name: 'Chapter 1 Complete', icon: '📗', description: 'Answer all Chapter 1 questions', category: 'Chapters',
          check: function(p) { return getChapterProgress(p, 1).answered >= getChapterQuestionCount(1); } },
        { id: 'ch5done', name: 'Halfway There', icon: '🎯', description: 'Complete Chapters 1-5', category: 'Chapters',
          check: function(p) { return [1,2,3,4,5].every(function(ch) { return getChapterProgress(p, ch).answered >= getChapterQuestionCount(ch); }); } },
        { id: 'ch10done', name: 'Double Digits', icon: '🔟', description: 'Complete Chapters 1-10', category: 'Chapters',
          check: function(p) { return [1,2,3,4,5,6,7,8,9,10].every(function(ch) { return getChapterProgress(p, ch).answered >= getChapterQuestionCount(ch); }); } },
        { id: 'allchapters', name: 'Full Course', icon: '📚', description: 'Answer questions from all 15 chapters', category: 'Chapters',
          check: function(p) { return [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].every(function(ch) { return getChapterProgress(p, ch).answered > 0; }); } },

        // === QUIZ GROUP BADGES ===
        { id: 'quiz1ready', name: 'Quiz 1 Ready', icon: '✏️', description: 'Answer all Ch 1-4 questions', category: 'Quizzes',
          check: function(p) { return [1,2,3,4].every(function(ch) { return getChapterProgress(p, ch).answered >= getChapterQuestionCount(ch); }); } },
        { id: 'quiz2ready', name: 'Quiz 2 Ready', icon: '✏️', description: 'Answer all Ch 5-7 questions', category: 'Quizzes',
          check: function(p) { return [5,6,7].every(function(ch) { return getChapterProgress(p, ch).answered >= getChapterQuestionCount(ch); }); } },
        { id: 'quiz3ready', name: 'Quiz 3 Ready', icon: '✏️', description: 'Answer all Ch 8-10 questions', category: 'Quizzes',
          check: function(p) { return [8,9,10].every(function(ch) { return getChapterProgress(p, ch).answered >= getChapterQuestionCount(ch); }); } },
        { id: 'quiz4ready', name: 'Quiz 4 Ready', icon: '✏️', description: 'Answer all Ch 11-14 questions', category: 'Quizzes',
          check: function(p) { return [11,12,13,14].every(function(ch) { return getChapterProgress(p, ch).answered >= getChapterQuestionCount(ch); }); } },
        { id: 'finalready', name: 'Final Ready', icon: '🎓', description: 'Answer all Ch 15 questions', category: 'Quizzes',
          check: function(p) { return getChapterProgress(p, 15).answered >= getChapterQuestionCount(15); } },

        // === QUIZ MASTERY BADGES (90%+ accuracy) ===
        { id: 'quiz1master', name: 'Quiz 1 Master', icon: '🥇', description: '90%+ on Ch 1-4 (min 10 Q)', category: 'Quizzes',
          check: function(p) { var s = getQuizGroupStats(p, [1,2,3,4]); return s.total >= 10 && s.correct/s.total >= 0.90; } },
        { id: 'quiz2master', name: 'Quiz 2 Master', icon: '🥇', description: '90%+ on Ch 5-7 (min 10 Q)', category: 'Quizzes',
          check: function(p) { var s = getQuizGroupStats(p, [5,6,7]); return s.total >= 10 && s.correct/s.total >= 0.90; } },
        { id: 'quiz3master', name: 'Quiz 3 Master', icon: '🥇', description: '90%+ on Ch 8-10 (min 10 Q)', category: 'Quizzes',
          check: function(p) { var s = getQuizGroupStats(p, [8,9,10]); return s.total >= 10 && s.correct/s.total >= 0.90; } },
        { id: 'quiz4master', name: 'Quiz 4 Master', icon: '🥇', description: '90%+ on Ch 11-14 (min 10 Q)', category: 'Quizzes',
          check: function(p) { var s = getQuizGroupStats(p, [11,12,13,14]); return s.total >= 10 && s.correct/s.total >= 0.90; } },
        { id: 'allquizmaster', name: 'Quiz King', icon: '👑', description: 'Master all 4 quizzes', category: 'Quizzes',
          check: function(p) {
            return [[1,2,3,4],[5,6,7],[8,9,10],[11,12,13,14]].every(function(chs) {
              var s = getQuizGroupStats(p, chs); return s.total >= 10 && s.correct/s.total >= 0.90;
            });
          } },

        // === CHAPTER MASTERY BADGES ===
        { id: 'chmaster1', name: 'Chapter Expert', icon: '⭐', description: 'Master 1 chapter (90%+, min 5 Q)', category: 'Chapters',
          check: function(p) { return countMasteredChapters(p) >= 1; } },
        { id: 'chmaster5', name: 'Multi-Chapter Pro', icon: '🌟', description: 'Master 5 chapters', category: 'Chapters',
          check: function(p) { return countMasteredChapters(p) >= 5; } },
        { id: 'chmaster10', name: 'Knowledge Expert', icon: '💫', description: 'Master 10 chapters', category: 'Chapters',
          check: function(p) { return countMasteredChapters(p) >= 10; } },
        { id: 'chmasterall', name: 'ServSafe Master', icon: '🏅', description: 'Master all 15 chapters', category: 'Chapters',
          check: function(p) { return countMasteredChapters(p) >= 15; } }
      ];

      function countMasteredCategories(progress) {
        var count = 0;
        var stats = progress.categoryStats || {};
        for (var cat in stats) {
          if (stats[cat].total >= 5 && (stats[cat].correct / stats[cat].total) >= 0.90) {
            count++;
          }
        }
        return count;
      }

      // Get question count for a specific chapter
      function getChapterQuestionCount(chapter) {
        return questionsDB.filter(function(q) { return q.chapter === chapter; }).length;
      }

      // Get progress stats for a specific chapter
      function getChapterProgress(progress, chapter) {
        var chapterStats = progress.chapterStats || {};
        return chapterStats[chapter] || { correct: 0, answered: 0 };
      }

      // Get combined stats for a quiz group (array of chapters)
      function getQuizGroupStats(progress, chapters) {
        var total = 0, correct = 0;
        chapters.forEach(function(ch) {
          var stats = getChapterProgress(progress, ch);
          total += stats.answered;
          correct += stats.correct;
        });
        return { total: total, correct: correct };
      }

      // Count chapters with 90%+ mastery
      function countMasteredChapters(progress) {
        var count = 0;
        var chapterStats = progress.chapterStats || {};
        for (var ch = 1; ch <= 15; ch++) {
          var stats = chapterStats[ch];
          if (stats && stats.answered >= 5 && (stats.correct / stats.answered) >= 0.90) {
            count++;
          }
        }
        return count;
      }

      function loadBadges() {
        try {
          var saved = localStorage.getItem(BADGES_KEY);
          if (saved) return JSON.parse(saved);
        } catch (e) {}
        return { earned: [], newlyEarned: [] };
      }

      function saveBadges(badges) {
        try {
          localStorage.setItem(BADGES_KEY, JSON.stringify(badges));
        } catch (e) {}
      }

      function checkForNewBadges(progress, currentBadges) {
        var newBadges = [];
        var now = new Date();
        var hour = now.getHours();
        var day = now.getDay();

        // Add time-based flags to progress for checking
        var extendedProgress = Object.assign({}, progress, {
          studiedEarly: progress.studiedEarly || (hour < 7),
          studiedLate: progress.studiedLate || (hour >= 22),
          studiedWeekend: progress.studiedWeekend || (day === 0 || day === 6)
        });

        badgeDefinitions.forEach(function(badge) {
          if (currentBadges.earned.indexOf(badge.id) === -1) {
            if (badge.check(extendedProgress)) {
              newBadges.push(badge.id);
            }
          }
        });

        return { newBadges: newBadges, extendedProgress: extendedProgress };
      }

      function getBadgeById(id) {
        return badgeDefinitions.find(function(b) { return b.id === id; });
      }

      // ============ COMPONENTS ============

      // Chef Character - Now with 17 images!
      function ChefCharacter(props) {
        const state = props.state;
        const size = props.size || 'normal';
        const images = {
          // Core states
          idle: 'assets/chef-idle.jpg',
          celebrate: 'assets/chef-celebrate.jpg',
          encourage: 'assets/chef-encourage.jpg',
          sick: 'assets/chef-sick.jpg',
          // Expression states
          greeting: 'assets/chef-greeting.jpg',
          thinking: 'assets/chef-thinking.jpg',
          reading: 'assets/chef-reading.jpg',
          trophy: 'assets/chef-trophy.jpg',
          // Category-specific images
          thermometer: 'assets/chef-thermometer.jpg',
          handwash: 'assets/chef-handwash.jpg',
          fridge: 'assets/chef-fridge.jpg',
          timer: 'assets/chef-timer.jpg',
          dangerzone: 'assets/chef-dangerzone.jpg',
          crosscontam: 'assets/chef-crosscontam.jpg',
          sanitize: 'assets/chef-sanitize.jpg',
          spoiled: 'assets/chef-spoiled.jpg',
          clipboard: 'assets/chef-clipboard.jpg'
        };
        const animations = {
          idle: 'chef-idle',
          celebrate: 'chef-celebrate',
          encourage: 'chef-encourage',
          sick: 'chef-sick',
          greeting: 'chef-idle',
          thinking: 'chef-idle',
          reading: 'chef-idle',
          trophy: 'chef-celebrate',
          thermometer: 'chef-idle',
          handwash: 'chef-idle',
          fridge: 'chef-idle',
          timer: 'chef-idle',
          dangerzone: 'chef-sick',
          crosscontam: 'chef-idle',
          sanitize: 'chef-idle',
          spoiled: 'chef-sick',
          clipboard: 'chef-idle'
        };
        const sizeClass = size === 'small' ? 'w-32' : 'w-full max-w-xs';

        const sparkles = [];
        if (state === 'celebrate') {
          for (let i = 0; i < 6; i++) {
            sparkles.push(
              createElement('div', {
                key: i,
                className: 'absolute text-2xl sparkle',
                style: {
                  left: (15 + Math.random() * 70) + '%',
                  top: (10 + Math.random() * 60) + '%',
                  animationDelay: (i * 0.15) + 's'
                }
              }, '⭐')
            );
          }
        }

        return createElement('div', { className: 'relative' },
          createElement('img', {
            src: images[state],
            alt: 'Chef Whiskers',
            className: sizeClass + ' mx-auto ' + animations[state] + ' rounded-2xl'
          }),
          state === 'celebrate' && createElement('div', { className: 'absolute inset-0 pointer-events-none' }, sparkles)
        );
      }

      // Hero Chef for Home Screen - with fancy animations!
      function HeroChef(props) {
        const [particles, setParticles] = useState([]);

        // Generate floating particles on mount
        useEffect(function() {
          var newParticles = [];
          // Floating food/cooking icons - randomized positions and staggered vertical starts
          var foodEmojis = ['🍳', '🥄', '🧂', '🌿', '🔥', '🧈', '🍅', '🧄', '🥕', '🌶️', '🥗', '🍴'];
          for (var j = 0; j < 8; j++) {
            var randomEmoji = foodEmojis[Math.floor(Math.random() * foodEmojis.length)];
            newParticles.push({
              id: 'float-' + j,
              type: 'float',
              emoji: randomEmoji,
              left: (-10 + Math.random() * 110) + '%',
              bottom: (10 + Math.random() * 50) + 'px',
              delay: (Math.random() * 5) + 's',
              duration: (4 + Math.random() * 3) + 's'
            });
          }
          setParticles(newParticles);
        }, []);

        return createElement('div', { className: 'chef-hero-container' },
          // Floating food icons behind chef
          particles.filter(function(p) { return p.type === 'float'; }).map(function(p) {
            return createElement('span', {
              key: p.id,
              className: 'float-icon',
              style: {
                left: p.left,
                bottom: p.bottom,
                animationDelay: p.delay,
                animationDuration: p.duration
              }
            }, p.emoji);
          }),
          // Shadow underneath chef
          createElement('div', { className: 'chef-hero-shadow' }),
          // Main chef image with glow effect
          createElement('div', { className: 'chef-hero-glow' },
            createElement('img', {
              src: 'assets/chef-greeting.jpg',
              alt: 'Chef Whiskers',
              className: 'w-36 md:w-44 chef-hero rounded-2xl'
            })
          )
        );
      }

      // Category to Chef Image mapping
      function getCategoryImage(category) {
        const categoryImages = {
          'Cooking Temperatures': 'thermometer',
          'Temperature Control': 'dangerzone',
          'Time-Temperature Control': 'timer',
          'Food Storage': 'fridge',
          'Cooling': 'fridge',
          'Definitions': 'clipboard',
          'Sanitation': 'sanitize',
          'Foodborne Illness': 'spoiled',
          'FAT TOM': 'thermometer',
          'Chemical Contamination': 'dangerzone',
          'Food Safety': 'clipboard',
          'Personal Hygiene': 'handwash',
          'Seafood Toxins': 'spoiled',
          'TCS Foods': 'fridge',
          'Allergens': 'crosscontam',
          'Food Defense': 'clipboard'
        };
        return categoryImages[category] || 'thinking';
      }

      // Progress Ring
      function ProgressRing(props) {
        const percentage = props.percentage || 0;
        const size = props.size || 80;
        const strokeWidth = props.strokeWidth || 8;
        const radius = (size - strokeWidth) / 2;
        const circumference = radius * 2 * Math.PI;
        const offset = circumference - (percentage / 100) * circumference;

        return createElement('svg', { width: size, height: size, className: 'transform -rotate-90' },
          createElement('circle', {
            cx: size / 2,
            cy: size / 2,
            r: radius,
            stroke: '#E5E7EB',
            strokeWidth: strokeWidth,
            fill: 'none'
          }),
          createElement('circle', {
            cx: size / 2,
            cy: size / 2,
            r: radius,
            stroke: percentage >= 70 ? '#22C55E' : percentage >= 50 ? '#F59E0B' : '#EF4444',
            strokeWidth: strokeWidth,
            fill: 'none',
            strokeDasharray: circumference,
            strokeDashoffset: offset,
            strokeLinecap: 'round',
            className: 'progress-ring'
          })
        );
      }

      // Category Stats Card
      function CategoryStatsCard(props) {
        const cat = props.category;
        const stats = props.stats || { correct: 0, total: 0 };
        const percentage = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
        const icon = {
          'Cooking Temperatures': '🌡️',
          'Temperature Control': '❄️',
          'Time-Temperature Control': '⏱️',
          'Food Storage': '🗄️',
          'Cooling': '🧊',
          'Definitions': '📖',
          'Sanitation': '🧼',
          'Foodborne Illness': '🦠',
          'FAT TOM': '🧫',
          'Chemical Contamination': '⚗️',
          'Food Safety': '✅',
          'Personal Hygiene': '🧤',
          'Seafood Toxins': '🐟',
          'TCS Foods': '🥩',
          'Allergens': '⚠️',
          'Food Defense': '🛡️'
        }[cat] || '📋';

        return createElement('div', { className: 'card-bg rounded-xl p-3 border-2 border-themed flex items-center gap-3' },
          createElement('div', { className: 'relative' },
            createElement(ProgressRing, { percentage: percentage, size: 50, strokeWidth: 5 }),
            createElement('div', { className: 'absolute inset-0 flex items-center justify-center text-xs font-bold text-primary' }, percentage + '%')
          ),
          createElement('div', { className: 'flex-1 min-w-0' },
            createElement('div', { className: 'flex items-center gap-1' },
              createElement('span', null, icon),
              createElement('span', { className: 'font-semibold text-sm text-primary truncate' }, cat)
            ),
            createElement('div', { className: 'text-xs text-muted' }, stats.correct + '/' + stats.total + ' correct')
          )
        );
      }

      // ============ IDENTITY CHECK SCREEN ============
      function IdentityCheckScreen(props) {
        var displayName = props.displayName;
        return createElement('div', {
          className: 'min-h-screen flex items-center justify-center p-4',
          style: { backgroundColor: 'var(--bg-primary)' }
        },
          createElement('div', {
            className: 'max-w-sm w-full text-center p-8 rounded-2xl shadow-lg',
            style: { backgroundColor: 'var(--bg-card)', border: '1px solid var(--border-color)' }
          },
            createElement('img', {
              src: 'assets/chef-greeting.jpg',
              alt: 'Chef Whiskers',
              className: 'w-24 h-24 mx-auto mb-4 rounded-xl object-cover'
            }),
            createElement('h2', {
              className: 'text-xl font-bold mb-2',
              style: { fontFamily: 'Fredoka, sans-serif', color: 'var(--text-primary)' }
            }, 'Welcome back!'),
            createElement('p', {
              className: 'text-lg mb-6',
              style: { color: 'var(--text-secondary)' }
            }, 'Are you still ', createElement('strong', {
              style: { color: '#F97316' }
            }, displayName), '?'),
            createElement('div', { className: 'flex gap-3 justify-center' },
              createElement('button', {
                onClick: props.onYes,
                className: 'px-6 py-3 rounded-xl font-bold text-white transition-all',
                style: { background: 'linear-gradient(135deg, #F97316, #EA580C)' }
              }, 'Yes, that\'s me!'),
              createElement('button', {
                onClick: props.onNo,
                className: 'px-6 py-3 rounded-xl font-bold transition-all',
                style: { backgroundColor: 'var(--bg-secondary)', color: 'var(--text-primary)', border: '1px solid var(--border-color)' }
              }, 'No, switch user')
            )
          )
        );
      }

      // ============ AUTH SCREEN ============
      function AuthScreen(props) {
        var mode = props.mode || 'choose';
        var setMode = props.setMode;
        var onAuth = props.onAuth;

        var gamerNameState = useState('');
        var gamerName = gamerNameState[0];
        var setGamerName = gamerNameState[1];

        var firstNameState = useState('');
        var firstName = firstNameState[0];
        var setFirstName = firstNameState[1];

        var errorState = useState('');
        var error = errorState[0];
        var setError = errorState[1];

        var loadingState = useState(false);
        var loading = loadingState[0];
        var setLoading = loadingState[1];

        var nameAvailableState = useState(null);
        var nameAvailable = nameAvailableState[0];
        var setNameAvailable = nameAvailableState[1];

        var checkTimeoutState = useState(null);
        var checkTimeoutRef = checkTimeoutState[0];
        var setCheckTimeoutRef = checkTimeoutState[1];

        function checkNameAvailability(name) {
          if (checkTimeoutRef) clearTimeout(checkTimeoutRef);
          if (name.trim().length < 2) {
            setNameAvailable(null);
            return;
          }
          var timeout = setTimeout(function() {
            convexQuery("users:checkGamerName", { gamerName: name.trim() })
              .then(function(result) { setNameAvailable(result.available); })
              .catch(function() { setNameAvailable(null); });
          }, 500);
          setCheckTimeoutRef(timeout);
        }

        function handleGamerNameChange(e) {
          var val = e.target.value;
          setGamerName(val);
          setError('');
          if (mode === 'signup') checkNameAvailability(val);
        }

        function handleSignup() {
          if (!gamerName.trim() || !firstName.trim()) {
            setError('Please fill in both fields');
            return;
          }
          if (gamerName.trim().length < 2 || gamerName.trim().length > 20) {
            setError('Gamer name must be 2-20 characters');
            return;
          }
          setLoading(true);
          setError('');
          convexMutation("users:register", {
            gamerName: gamerName.trim(),
            firstName: firstName.trim()
          }).then(function(result) {
            onAuth({
              userId: result.userId,
              displayName: result.displayName,
              gamerName: gamerName.trim().toLowerCase(),
              firstName: firstName.trim().toLowerCase()
            });
          }).catch(function(err) {
            setError(err.message || 'Registration failed');
            setLoading(false);
          });
        }

        function handleLogin() {
          if (!gamerName.trim() || !firstName.trim()) {
            setError('Please fill in both fields');
            return;
          }
          setLoading(true);
          setError('');
          convexMutation("users:login", {
            gamerName: gamerName.trim(),
            firstName: firstName.trim()
          }).then(function(result) {
            onAuth({
              userId: result.userId,
              displayName: result.displayName,
              gamerName: gamerName.trim().toLowerCase(),
              firstName: firstName.trim().toLowerCase()
            });
          }).catch(function(err) {
            setError(err.message || 'Login failed');
            setLoading(false);
          });
        }

        function handleKeyPress(e, action) {
          if (e.key === 'Enter') action();
        }

        if (mode === 'choose') {
          return createElement('div', {
            className: 'min-h-screen flex items-center justify-center p-4',
            style: { backgroundColor: 'var(--bg-primary)' }
          },
            createElement('div', {
              className: 'max-w-md w-full text-center p-8 rounded-2xl shadow-lg',
              style: { backgroundColor: 'var(--bg-card)', border: '1px solid var(--border-color)' }
            },
              createElement('img', {
                src: 'assets/headshot_20260210.png',
                alt: 'Chef Rat',
                className: 'w-32 h-32 mx-auto mb-4 rounded-xl object-cover',
                style: { animation: 'gentleFloat 4s ease-in-out infinite' }
              }),
              createElement('h1', {
                className: 'text-3xl font-bold mb-2',
                style: { fontFamily: 'Fredoka, sans-serif', color: '#F97316' }
              }, 'Chef\'s Kitchen'),
              createElement('p', {
                className: 'text-sm mb-1',
                style: { color: 'var(--text-secondary)' }
              }, 'CUL 104 ServSafe Study Aid'),
              createElement('p', {
                className: 'text-xs mb-6',
                style: { color: 'var(--text-muted)' }
              }, 'Trident Technical College'),
              createElement('div', { className: 'space-y-3' },
                createElement('button', {
                  onClick: function() { setMode('signup'); },
                  className: 'w-full py-4 rounded-xl font-bold text-white text-lg transition-all hover:scale-105',
                  style: { background: 'linear-gradient(135deg, #F97316, #EA580C)' }
                }, 'New Chef? Create Account'),
                createElement('button', {
                  onClick: function() { setMode('login'); },
                  className: 'w-full py-4 rounded-xl font-bold text-lg transition-all hover:scale-105',
                  style: { backgroundColor: 'var(--bg-secondary)', color: 'var(--text-primary)', border: '2px solid #F97316' }
                }, 'Returning Chef? Sign In')
              )
            )
          );
        }

        // Signup or Login form
        var isSignup = mode === 'signup';
        return createElement('div', {
          className: 'min-h-screen flex items-center justify-center p-4',
          style: { backgroundColor: 'var(--bg-primary)' }
        },
          createElement('div', {
            className: 'max-w-md w-full p-8 rounded-2xl shadow-lg',
            style: { backgroundColor: 'var(--bg-card)', border: '1px solid var(--border-color)' }
          },
            createElement('button', {
              onClick: function() { setMode('choose'); setError(''); setNameAvailable(null); },
              className: 'text-sm mb-4 flex items-center gap-1',
              style: { color: 'var(--text-muted)' }
            }, '\u2190 Back'),
            createElement('h2', {
              className: 'text-2xl font-bold mb-6 text-center',
              style: { fontFamily: 'Fredoka, sans-serif', color: '#F97316' }
            }, isSignup ? 'Create Your Account' : 'Welcome Back, Chef!'),

            // Gamer Name field
            createElement('div', { className: 'mb-4' },
              createElement('label', {
                className: 'block text-sm font-medium mb-1',
                style: { color: 'var(--text-secondary)' }
              }, 'Gamer Name'),
              createElement('input', {
                type: 'text',
                value: gamerName,
                onChange: handleGamerNameChange,
                onKeyPress: function(e) { handleKeyPress(e, isSignup ? handleSignup : handleLogin); },
                placeholder: 'e.g. ChefBob123',
                maxLength: 20,
                className: 'w-full px-4 py-3 rounded-xl text-lg',
                style: {
                  backgroundColor: 'var(--bg-secondary)',
                  color: 'var(--text-primary)',
                  border: '2px solid ' + (isSignup && nameAvailable === true ? '#22C55E' : isSignup && nameAvailable === false ? '#EF4444' : 'var(--border-color)'),
                  outline: 'none'
                }
              }),
              isSignup && nameAvailable === true && createElement('p', {
                className: 'text-xs mt-1', style: { color: '#22C55E' }
              }, 'Name is available!'),
              isSignup && nameAvailable === false && createElement('p', {
                className: 'text-xs mt-1', style: { color: '#EF4444' }
              }, 'Name is already taken')
            ),

            // First Name field
            createElement('div', { className: 'mb-6' },
              createElement('label', {
                className: 'block text-sm font-medium mb-1',
                style: { color: 'var(--text-secondary)' }
              }, 'First Name'),
              createElement('input', {
                type: 'text',
                value: firstName,
                onChange: function(e) { setFirstName(e.target.value); setError(''); },
                onKeyPress: function(e) { handleKeyPress(e, isSignup ? handleSignup : handleLogin); },
                placeholder: 'Your real first name',
                maxLength: 30,
                className: 'w-full px-4 py-3 rounded-xl text-lg',
                style: {
                  backgroundColor: 'var(--bg-secondary)',
                  color: 'var(--text-primary)',
                  border: '2px solid var(--border-color)',
                  outline: 'none'
                }
              })
            ),

            // Error message
            error && createElement('p', {
              className: 'text-sm mb-4 text-center p-2 rounded-lg',
              style: { backgroundColor: '#FEE2E2', color: '#DC2626' }
            }, error),

            // Submit button
            createElement('button', {
              onClick: isSignup ? handleSignup : handleLogin,
              disabled: loading,
              className: 'w-full py-4 rounded-xl font-bold text-white text-lg transition-all',
              style: {
                background: loading ? '#9CA3AF' : 'linear-gradient(135deg, #F97316, #EA580C)',
                cursor: loading ? 'not-allowed' : 'pointer'
              }
            }, loading ? 'Please wait...' : (isSignup ? 'Create Account' : 'Sign In')),

            !isSignup && createElement('p', {
              className: 'text-xs text-center mt-4',
              style: { color: 'var(--text-muted)' }
            }, 'Enter the same gamer name and first name you used to sign up. Case doesn\'t matter!')
          )
        );
      }

      // ============ ACCOUNT MENU ============
      function AccountMenu(props) {
        var user = props.user;
        var theme = props.theme;
        var onCycleTheme = props.onCycleTheme;
        var onResetProgress = props.onResetProgress;
        var onLogout = props.onLogout;
        var personalDevice = props.personalDevice;
        var onTogglePersonalDevice = props.onTogglePersonalDevice;

        var openState = useState(false);
        var open = openState[0];
        var setOpen = openState[1];

        // Close menu when clicking outside
        useEffect(function() {
          if (!open) return;
          function handleClick(e) {
            if (!e.target.closest('.account-menu-container')) setOpen(false);
          }
          document.addEventListener('click', handleClick);
          return function() { document.removeEventListener('click', handleClick); };
        }, [open]);

        var themeLabel = theme === 'system' ? 'System' : theme === 'light' ? 'Light' : 'Dark';
        var themeIcon = theme === 'system' ? '\uD83D\uDDA5\uFE0F' : theme === 'light' ? '\u2600\uFE0F' : '\uD83C\uDF19';
        var initial = (user.displayName || '?')[0].toUpperCase();

        return createElement('div', {
          className: 'account-menu-container',
          style: { position: 'relative', zIndex: 100 }
        },
          // Chef rat avatar button
          createElement('button', {
            onClick: function(e) { e.stopPropagation(); setOpen(!open); },
            className: 'flex items-center justify-center rounded-full transition-all hover:scale-110',
            style: {
              width: '52px', height: '52px',
              cursor: 'pointer',
              border: '2px solid rgba(255,255,255,0.3)',
              padding: '0',
              overflow: 'hidden',
              background: 'transparent'
            },
            title: user.displayName
          },
            createElement('img', {
              src: 'assets/headshot_20260210.png',
              alt: 'Chef Rat Avatar',
              style: { width: '100%', height: '100%', objectFit: 'cover', borderRadius: '50%' }
            })
          ),

          // Dropdown menu
          open && createElement('div', {
            className: 'absolute right-0 mt-2 w-64 rounded-xl shadow-xl overflow-hidden',
            style: {
              backgroundColor: 'var(--bg-card)',
              border: '1px solid var(--border-color)',
              zIndex: 101
            }
          },
            // User header
            createElement('div', {
              className: 'px-4 py-3',
              style: { borderBottom: '1px solid var(--border-color)' }
            },
              createElement('p', {
                className: 'font-bold text-sm',
                style: { color: '#F97316' }
              }, user.displayName),
              createElement('p', {
                className: 'text-xs',
                style: { color: 'var(--text-muted)' }
              }, 'Signed in')
            ),

            // Theme toggle
            createElement('button', {
              onClick: function(e) { e.stopPropagation(); onCycleTheme(); },
              className: 'w-full text-left px-4 py-3 text-sm flex items-center gap-3 transition-colors',
              style: { color: 'var(--text-primary)', borderBottom: '1px solid var(--border-color)' }
            },
              createElement('span', null, themeIcon),
              createElement('span', null, 'Theme: ' + themeLabel)
            ),

            // Personal device toggle
            createElement('button', {
              onClick: function(e) { e.stopPropagation(); onTogglePersonalDevice(); },
              className: 'w-full text-left px-4 py-3 text-sm flex items-center gap-3 transition-colors',
              style: { color: 'var(--text-primary)', borderBottom: '1px solid var(--border-color)' }
            },
              createElement('span', null, personalDevice ? '\u2705' : '\u2B1C'),
              createElement('span', null, 'My personal device')
            ),

            // Reset progress
            createElement('button', {
              onClick: function(e) { e.stopPropagation(); setOpen(false); onResetProgress(); },
              className: 'w-full text-left px-4 py-3 text-sm flex items-center gap-3 transition-colors',
              style: { color: 'var(--text-primary)', borderBottom: '1px solid var(--border-color)' }
            },
              createElement('span', null, '\uD83D\uDD04'),
              createElement('span', null, 'Reset Progress')
            ),

            // Sign out
            createElement('button', {
              onClick: function(e) { e.stopPropagation(); setOpen(false); onLogout(); },
              className: 'w-full text-left px-4 py-3 text-sm flex items-center gap-3 transition-colors',
              style: { color: '#EF4444' }
            },
              createElement('span', null, '\uD83D\uDEAA'),
              createElement('span', null, 'Sign Out')
            )
          )
        );
      }

      // ============ CLASS STATS CARD ============
      function ClassStatsCard(props) {
        var classStats = props.classStats;
        var userProgress = props.userProgress;

        var expandedState = useState(false);
        var expanded = expandedState[0];
        var setExpanded = expandedState[1];

        if (!classStats || classStats.studentCount === 0) return null;

        var userAcc = userProgress.totalAnswered > 0
          ? Math.round((userProgress.totalCorrect / userProgress.totalAnswered) * 100)
          : 0;
        var classAcc = Math.round(classStats.avgAccuracy * 100);
        var aboveAvg = userAcc >= classAcc;

        return createElement('div', {
          className: 'p-4 rounded-xl mb-4',
          style: {
            backgroundColor: 'var(--bg-card)',
            border: '1px solid var(--border-color)',
            boxShadow: '0 2px 8px var(--shadow-color)'
          }
        },
          createElement('div', {
            className: 'flex items-center justify-between mb-3 cursor-pointer',
            onClick: function() { setExpanded(!expanded); }
          },
            createElement('h3', {
              className: 'font-bold text-sm',
              style: { fontFamily: 'Fredoka, sans-serif', color: 'var(--text-primary)' }
            }, '\uD83C\uDFEB Class Overview'),
            createElement('span', {
              className: 'text-xs',
              style: { color: 'var(--text-muted)' }
            }, expanded ? '\u25B2' : '\u25BC')
          ),

          // Summary row
          createElement('div', { className: 'flex items-center gap-4 text-xs' },
            createElement('span', { style: { color: 'var(--text-muted)' } },
              classStats.studentCount + ' student' + (classStats.studentCount !== 1 ? 's' : '') + ' studying'
            ),
            createElement('span', { style: { color: 'var(--text-muted)' } },
              'Class avg: ' + classAcc + '%'
            ),
            createElement('span', {
              className: 'font-bold',
              style: { color: aboveAvg ? '#22C55E' : '#F97316' }
            }, 'You: ' + userAcc + '%' + (aboveAvg ? ' \u25B2' : ' \u25BC'))
          ),

          // Comparison bar
          createElement('div', {
            className: 'mt-2 h-2 rounded-full overflow-hidden flex',
            style: { backgroundColor: 'var(--border-color)' }
          },
            createElement('div', {
              style: {
                width: Math.min(userAcc, 100) + '%',
                background: aboveAvg ? 'linear-gradient(90deg, #22C55E, #16A34A)' : 'linear-gradient(90deg, #F97316, #EA580C)',
                borderRadius: '9999px',
                transition: 'width 0.5s ease'
              }
            })
          ),

          // Expanded per-category stats
          expanded && classStats.categoryAverages && createElement('div', { className: 'mt-3 space-y-2' },
            Object.keys(classStats.categoryAverages).sort().map(function(cat) {
              var catData = classStats.categoryAverages[cat];
              var catClassAcc = Math.round(catData.avgAccuracy * 100);
              var userCatStats = userProgress.categoryStats && userProgress.categoryStats[cat];
              var userCatAcc = userCatStats && userCatStats.total > 0
                ? Math.round((userCatStats.correct / userCatStats.total) * 100) : null;

              return createElement('div', { key: cat, className: 'flex items-center justify-between text-xs' },
                createElement('span', {
                  className: 'truncate',
                  style: { color: 'var(--text-secondary)', maxWidth: '50%' }
                }, cat),
                createElement('div', { className: 'flex gap-3' },
                  createElement('span', { style: { color: 'var(--text-muted)' } }, 'Class: ' + catClassAcc + '%'),
                  userCatAcc !== null && createElement('span', {
                    className: 'font-bold',
                    style: { color: userCatAcc >= catClassAcc ? '#22C55E' : '#F97316' }
                  }, 'You: ' + userCatAcc + '%')
                )
              );
            })
          )
        );
      }

      // ============ SCREENS ============

      // Home/Study Mode Selection Screen
      function HomeScreen(props) {
        const progress = props.progress;
        const badges = props.badges || { earned: [], newlyEarned: [] };
        const onSelectMode = props.onSelectMode;
        const onResetProgress = props.onResetProgress;
        const theme = props.theme;
        const onCycleTheme = props.onCycleTheme;
        const [showAllBadges, setShowAllBadges] = useState(false);
        const totalPercentage = progress.totalAnswered > 0
          ? Math.round((progress.totalCorrect / progress.totalAnswered) * 100)
          : 0;

        // Find weak categories (below 70%)
        const weakCategories = categories.filter(function(cat) {
          const stats = progress.categoryStats[cat];
          if (!stats || stats.total === 0) return false;
          return (stats.correct / stats.total) < 0.7;
        });

        // Theme icons and labels
        const themeIcon = theme === 'dark' ? '🌙' : theme === 'light' ? '☀️' : '🖥️';
        const themeLabel = theme === 'dark' ? 'Dark' : theme === 'light' ? 'Light' : 'Auto';

        return createElement('div', { className: 'min-h-screen' },
          // Header
          createElement('header', { className: 'bg-gradient-to-r from-red-700 via-red-600 to-orange-600 text-white p-6 shadow-lg' },
            createElement('div', { className: 'max-w-4xl mx-auto' },
              // Version in top right (theme toggle moved to Account Menu)
              createElement('div', { className: 'flex justify-end items-center gap-3 mb-2' },
                createElement('span', { className: 'text-xs text-white/60' }, 'v' + APP_VERSION)
              ),
              createElement('div', { className: 'text-center' },
                createElement('div', { className: 'text-5xl mb-2' }, '🍳'),
                createElement('h1', { className: 'brand text-3xl font-bold' }, "Chef's Kitchen"),
                createElement('p', { className: 'text-orange-200' }, 'CUL 104 • ServSafe Study Aid')
              )
            )
          ),

          // Main Content
          createElement('main', { className: 'max-w-4xl mx-auto p-6' },
            // Chef and overall stats
            createElement('div', { className: 'card-bg rounded-2xl shadow-xl p-6 mb-6 border-4 border-amber-200' },
              createElement('div', { className: 'flex flex-col md:flex-row items-center gap-6' },
                createElement('div', { className: 'flex-shrink-0' },
                  createElement(HeroChef, null)
                ),
                createElement('div', { className: 'flex-1 text-center md:text-left' },
                  createElement('h2', { className: 'text-2xl font-bold text-primary' },
                    props.user ? 'Welcome back, ' + props.user.displayName + '!' : 'Welcome back, Chef!'
                  ),
                  createElement('p', { className: 'text-secondary mt-1' },
                    progress.totalAnswered === 0
                      ? "Ready to start your food safety training?"
                      : "You've answered " + progress.totalAnswered + " questions with " + totalPercentage + "% accuracy."
                  ),
                  progress.totalAnswered > 0 && createElement('div', { className: 'mt-3 flex items-center justify-center md:justify-start gap-4' },
                    createElement('div', { className: 'relative' },
                      createElement(ProgressRing, { percentage: totalPercentage, size: 60, strokeWidth: 6 }),
                      createElement('div', { className: 'absolute inset-0 flex items-center justify-center text-sm font-bold' }, totalPercentage + '%')
                    ),
                    createElement('div', { className: 'text-left' },
                      createElement('div', { className: 'text-sm text-muted' }, 'Overall Score'),
                      createElement('div', { className: 'font-bold text-lg' }, progress.totalCorrect + '/' + progress.totalAnswered)
                    )
                  )
                )
              )
            ),

            // Hint Statistics (only show if they've answered questions)
            progress.totalAnswered > 0 && createElement('div', { className: 'hint-tracker rounded-2xl shadow-lg p-5 mb-6 border-2 border-yellow-300' },
              createElement('div', { className: 'flex items-center gap-3 mb-3' },
                createElement('span', { className: 'text-2xl' }, '💡'),
                createElement('h3', { className: 'font-bold text-primary' }, 'Hint Tracker')
              ),
              createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
                createElement('div', { className: 'text-center p-3 card-bg rounded-xl' },
                  createElement('div', { className: 'text-2xl font-bold text-yellow-600' },
                    progress.correctWithoutHint || 0
                  ),
                  createElement('div', { className: 'text-xs text-muted' }, 'Correct Without Hints')
                ),
                createElement('div', { className: 'text-center p-3 card-bg rounded-xl' },
                  createElement('div', { className: 'text-2xl font-bold text-amber-600' },
                    progress.hintsUsed || 0
                  ),
                  createElement('div', { className: 'text-xs text-muted' }, 'Hints Used')
                ),
                createElement('div', { className: 'text-center p-3 card-bg rounded-xl' },
                  createElement('div', { className: 'text-2xl font-bold text-orange-600' },
                    progress.currentNoHintStreak || 0
                  ),
                  createElement('div', { className: 'text-xs text-muted' }, 'Current Streak')
                ),
                createElement('div', { className: 'text-center p-3 card-bg rounded-xl' },
                  createElement('div', { className: 'text-2xl font-bold text-red-600' },
                    '🔥 ' + (progress.bestNoHintStreak || 0)
                  ),
                  createElement('div', { className: 'text-xs text-muted' }, 'Best Streak')
                )
              ),
              // Encouragement message based on performance
              createElement('div', { className: 'mt-3 text-center text-sm' },
                progress.totalAnswered > 0 && progress.hintsUsed === 0
                  ? createElement('span', { className: 'text-green-600 font-medium' }, '🌟 Amazing! No hints used yet - true chef confidence!')
                  : progress.correctWithoutHint > progress.hintsUsed
                    ? createElement('span', { className: 'text-amber-600' }, '👨‍🍳 Great self-reliance! Keep trusting your knowledge.')
                    : createElement('span', { className: 'text-secondary' }, '💪 Hints help you learn - try answering without them to test yourself!')
              )
            ),

            // Class Stats Card
            props.classStats && createElement(ClassStatsCard, {
              classStats: props.classStats,
              userProgress: progress
            }),

            // Badges Section
            createElement('div', { className: 'card-bg rounded-2xl shadow-lg p-5 mb-6 border-2 border-purple-200' },
              createElement('div', { className: 'flex items-center justify-between mb-4' },
                createElement('div', { className: 'flex items-center gap-3' },
                  createElement('span', { className: 'text-2xl' }, '🏆'),
                  createElement('h3', { className: 'font-bold text-primary' }, 'Achievements'),
                  createElement('span', { className: 'text-sm text-muted' },
                    badges.earned.length + '/' + badgeDefinitions.length + ' unlocked'
                  )
                ),
                createElement('button', {
                  onClick: function() { setShowAllBadges(!showAllBadges); },
                  className: 'text-sm text-purple-600 hover:text-purple-800 font-medium'
                }, showAllBadges ? 'Hide Catalog' : 'View All Badges')
              ),

              // Earned badges display - always show ALL earned badges
              badges.earned.length > 0 ?
                createElement('div', { className: 'flex flex-wrap gap-2 mb-3' },
                  badges.earned.map(function(badgeId) {
                    var badge = getBadgeById(badgeId);
                    if (!badge) return null;
                    return createElement('div', {
                      key: badgeId,
                      className: 'group relative flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-full border border-yellow-300',
                      title: badge.name + ': ' + badge.description
                    },
                      createElement('span', { className: 'text-lg' }, badge.icon),
                      createElement('span', { className: 'text-xs font-medium text-gray-700' }, badge.name)
                    );
                  })
                ) :
                createElement('p', { className: 'text-sm text-muted text-center py-2' },
                  '🎯 Answer questions to earn your first badge!'
                ),

              // Show all badges grid when expanded
              showAllBadges && createElement('div', { className: 'mt-4 border-t border-themed pt-4' },
                createElement('h4', { className: 'text-sm font-semibold text-muted mb-3' }, 'All Achievements'),
                ['Chapters', 'Quizzes', 'Streaks', 'Progress', 'No Hints', 'Accuracy', 'Mastery', 'Exam', 'Fun'].map(function(category) {
                  var categoryBadges = badgeDefinitions.filter(function(b) { return b.category === category; });
                  return createElement('div', { key: category, className: 'mb-4' },
                    createElement('h5', { className: 'text-xs font-medium text-muted uppercase tracking-wide mb-2' }, category),
                    createElement('div', { className: 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2' },
                      categoryBadges.map(function(badge) {
                        var isEarned = badges.earned.indexOf(badge.id) !== -1;
                        return createElement('div', {
                          key: badge.id,
                          className: 'flex items-center gap-2 p-2 rounded-lg border ' +
                            (isEarned ? 'bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-300' : 'bg-gray-50 border-gray-200 opacity-50')
                        },
                          createElement('span', { className: 'text-xl ' + (isEarned ? '' : 'grayscale') }, badge.icon),
                          createElement('div', { className: 'min-w-0' },
                            createElement('p', { className: 'text-xs font-medium truncate ' + (isEarned ? 'text-gray-800' : 'text-gray-500') }, badge.name),
                            createElement('p', { className: 'text-xs text-muted truncate' }, badge.description)
                          )
                        );
                      })
                    )
                  );
                })
              ),

              // Progress bar to next badge
              badges.earned.length < badgeDefinitions.length &&
                createElement('div', { className: 'mt-3 pt-3 border-t border-themed' },
                  createElement('div', { className: 'flex items-center justify-between text-xs text-muted mb-1' },
                    createElement('span', null, 'Badge Progress'),
                    createElement('span', null, Math.round((badges.earned.length / badgeDefinitions.length) * 100) + '%')
                  ),
                  createElement('div', { className: 'h-2 bg-gray-200 rounded-full overflow-hidden' },
                    createElement('div', {
                      className: 'h-full bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full transition-all',
                      style: { width: Math.round((badges.earned.length / badgeDefinitions.length) * 100) + '%' }
                    })
                  )
                )
            ),

            // Study Mode Selection
            createElement('h3', { className: 'text-xl font-bold text-primary mb-4' }, '📚 Choose Study Mode'),
            createElement('div', { className: 'grid md:grid-cols-2 gap-4 mb-6' },
              // Exam Focus - RECOMMENDED
              createElement('button', {
                onClick: function() { onSelectMode('examFocus'); },
                className: 'mode-card bg-gradient-to-br from-red-50 to-orange-50 rounded-xl p-5 border-2 border-red-300 text-left hover:border-red-500 hover:shadow-lg'
              },
                createElement('div', { className: 'flex items-center gap-3 mb-2' },
                  createElement('span', { className: 'text-3xl' }, '⭐'),
                  createElement('span', { className: 'font-bold text-lg text-gray-800' }, 'Exam Focus'),
                  createElement('span', { className: 'text-xs bg-red-500 text-white px-2 py-0.5 rounded-full ml-2' }, 'RECOMMENDED')
                ),
                createElement('p', { className: 'text-gray-600 text-sm' },
                  questionsDB.filter(function(q) { return q.examFocus; }).length + ' questions Chef Carmel emphasized for the test.'
                )
              ),

              // All Questions
              createElement('button', {
                onClick: function() { onSelectMode('all'); },
                className: 'mode-card card-bg rounded-xl p-5 border-2 border-amber-200 text-left hover:border-orange-400'
              },
                createElement('div', { className: 'flex items-center gap-3 mb-2' },
                  createElement('span', { className: 'text-3xl' }, '📚'),
                  createElement('span', { className: 'font-bold text-lg text-primary' }, 'Full Coverage')
                ),
                createElement('p', { className: 'text-secondary text-sm' }, 'All ' + questionsDB.length + ' questions including basic knowledge.')
              ),

              // Weak Areas
              createElement('button', {
                onClick: function() { onSelectMode('weak'); },
                disabled: weakCategories.length === 0,
                className: 'mode-card card-bg rounded-xl p-5 border-2 text-left ' +
                  (weakCategories.length > 0 ? 'border-red-200 hover:border-red-400' : 'border-themed opacity-50 cursor-not-allowed')
              },
                createElement('div', { className: 'flex items-center gap-3 mb-2' },
                  createElement('span', { className: 'text-3xl' }, '🔥'),
                  createElement('span', { className: 'font-bold text-lg text-primary' }, 'Weak Areas')
                ),
                createElement('p', { className: 'text-secondary text-sm' },
                  weakCategories.length > 0
                    ? 'Focus on ' + weakCategories.length + ' categories below 70%.'
                    : 'No weak areas yet! Keep practicing.'
                )
              ),

              // Basic Knowledge Only
              createElement('button', {
                onClick: function() { onSelectMode('basicOnly'); },
                className: 'mode-card card-bg rounded-xl p-5 border-2 border-themed text-left hover:border-amber-400'
              },
                createElement('div', { className: 'flex items-center gap-3 mb-2' },
                  createElement('span', { className: 'text-3xl' }, '📖'),
                  createElement('span', { className: 'font-bold text-lg text-primary' }, 'Basic Knowledge')
                ),
                createElement('p', { className: 'text-secondary text-sm' },
                  questionsDB.filter(function(q) { return !q.examFocus; }).length + ' foundational questions for deeper understanding.'
                )
              )
            ),

            // Chapter-Based Study Modes
            createElement('h3', { className: 'text-xl font-bold text-primary mb-4' }, '📗 Study by Chapter'),
            createElement('p', { className: 'text-sm text-muted mb-3' }, 'Focus on specific chapters or quiz groups'),

            // Quiz Groups (matches class quiz structure)
            createElement('div', { className: 'grid grid-cols-2 md:grid-cols-5 gap-3 mb-4' },
              [
                { id: '1-4', label: 'Quiz 1', chapters: 'Ch 1-4', count: questionsDB.filter(function(q) { return [1,2,3,4].indexOf(q.chapter) !== -1; }).length },
                { id: '5-7', label: 'Quiz 2', chapters: 'Ch 5-7', count: questionsDB.filter(function(q) { return [5,6,7].indexOf(q.chapter) !== -1; }).length },
                { id: '8-10', label: 'Quiz 3', chapters: 'Ch 8-10', count: questionsDB.filter(function(q) { return [8,9,10].indexOf(q.chapter) !== -1; }).length },
                { id: '11-14', label: 'Quiz 4', chapters: 'Ch 11-14', count: questionsDB.filter(function(q) { return [11,12,13,14].indexOf(q.chapter) !== -1; }).length },
                { id: '15', label: 'Final', chapters: 'Ch 15', count: questionsDB.filter(function(q) { return q.chapter === 15; }).length }
              ].map(function(quiz) {
                var isDisabled = quiz.count === 0;
                return createElement('button', {
                  key: quiz.id,
                  onClick: function() {
                    if (isDisabled) {
                      alert('No questions available for ' + quiz.label + '. The question database may need to be synced with chapter data.');
                    } else {
                      onSelectMode('quizGroup', quiz.id);
                    }
                  },
                  className: 'mode-card card-bg rounded-xl p-3 border-2 text-left transition-all ' +
                    (isDisabled ? 'border-gray-200 opacity-50 cursor-not-allowed' : 'border-blue-200 hover:border-blue-400 hover:shadow-md')
                },
                  createElement('div', { className: 'text-lg font-bold ' + (isDisabled ? 'text-gray-400' : 'text-primary') }, quiz.label),
                  createElement('div', { className: 'text-xs ' + (isDisabled ? 'text-gray-400' : 'text-blue-600') }, quiz.chapters),
                  createElement('div', { className: 'text-xs mt-1 ' + (isDisabled ? 'text-gray-400' : 'text-muted') },
                    isDisabled ? '⚠️ No data' : quiz.count + ' questions'
                  )
                );
              })
            ),

            // Chapter Range Selector (Ch 1 through X)
            createElement('div', { className: 'card-bg rounded-xl p-4 border-2 border-green-200 mb-4' },
              createElement('div', { className: 'flex items-center gap-3 mb-3' },
                createElement('span', { className: 'text-2xl' }, '📚'),
                createElement('span', { className: 'font-bold text-primary' }, 'Study Through Chapter...')
              ),
              createElement('div', { className: 'flex flex-wrap gap-2' },
                [4, 7, 9, 10, 12, 14, 15].map(function(ch) {
                  var count = questionsDB.filter(function(q) { return q.chapter >= 1 && q.chapter <= ch; }).length;
                  var isDisabled = count === 0;
                  return createElement('button', {
                    key: ch,
                    onClick: function() {
                      if (isDisabled) {
                        alert('No questions available for Chapters 1-' + ch + '. The question database may need to be synced with chapter data.');
                      } else {
                        onSelectMode('chapterRange', ch);
                      }
                    },
                    className: 'px-3 py-2 rounded-lg border-2 transition-colors ' +
                      (isDisabled ? 'border-gray-200 opacity-50 cursor-not-allowed' : 'border-green-300 hover:bg-green-50 hover:border-green-500')
                  },
                    createElement('div', { className: 'font-semibold text-sm ' + (isDisabled ? 'text-gray-400' : '') }, 'Ch 1-' + ch),
                    createElement('div', { className: 'text-xs ' + (isDisabled ? 'text-gray-400' : 'text-muted') },
                      isDisabled ? '⚠️' : count + ' Q'
                    )
                  );
                })
              )
            ),

            // Individual Chapter Selection
            createElement('div', { className: 'card-bg rounded-xl p-4 border-2 border-purple-200 mb-6' },
              createElement('div', { className: 'flex items-center gap-3 mb-3' },
                createElement('span', { className: 'text-2xl' }, '📖'),
                createElement('span', { className: 'font-bold text-primary' }, 'Single Chapter')
              ),
              createElement('div', { className: 'grid grid-cols-5 md:grid-cols-8 gap-2' },
                [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15].map(function(ch) {
                  var count = questionsDB.filter(function(q) { return q.chapter === ch; }).length;
                  var isDisabled = count === 0;
                  var chapterNames = {
                    1: 'Food Safety', 2: 'Pathogens', 3: 'Hygiene', 4: 'Purchasing',
                    5: 'Thermometers', 6: 'Receiving', 7: 'Storage', 8: 'Prep/Cooking',
                    9: 'Holding', 10: 'HACCP', 11: 'Facilities', 12: 'Cleaning',
                    13: 'Pests', 14: 'Inspections', 15: 'Training'
                  };
                  return createElement('button', {
                    key: ch,
                    onClick: function() {
                      if (isDisabled) {
                        alert('No questions available for Chapter ' + ch + ' (' + chapterNames[ch] + '). The question database may need to be synced with chapter data.');
                      } else {
                        onSelectMode('chapter', ch);
                      }
                    },
                    className: 'p-2 rounded-lg border-2 transition-colors text-center ' +
                      (isDisabled ? 'border-gray-200 opacity-50 cursor-not-allowed' : 'border-purple-200 hover:bg-purple-50 hover:border-purple-400'),
                    title: 'Chapter ' + ch + ': ' + chapterNames[ch]
                  },
                    createElement('div', { className: 'font-bold text-lg ' + (isDisabled ? 'text-gray-400' : 'text-primary') }, ch),
                    createElement('div', { className: 'text-xs truncate ' + (isDisabled ? 'text-gray-400' : 'text-muted') },
                      isDisabled ? '⚠️' : count + ' Q'
                    )
                  );
                })
              )
            ),

            // Category Selection
            createElement('h3', { className: 'text-xl font-bold text-primary mb-4' }, '📂 Study by Category'),
            createElement('div', { className: 'grid grid-cols-2 md:grid-cols-3 gap-3 mb-6' },
              categories.map(function(cat) {
                const stats = progress.categoryStats[cat] || { correct: 0, total: 0 };
                const count = questionsDB.filter(function(q) { return q.category === cat; }).length;
                const icon = {
                  'Food Safety Basics': '📖',
                  'Temperature Control': '🌡️',
                  'Sanitation & Hygiene': '🧼',
                  'Foodborne Illness': '🦠',
                  'Facilities & Operations': '🏢',
                  'Food Storage': '🗄️',
                  'Training': '👨‍🏫'
                }[cat] || '📋';

                return createElement('button', {
                  key: cat,
                  onClick: function() { onSelectMode('category', cat); },
                  className: 'mode-card card-bg rounded-xl p-4 border-2 border-themed text-left hover:border-amber-400'
                },
                  createElement('div', { className: 'text-2xl mb-1' }, icon),
                  createElement('div', { className: 'font-semibold text-sm text-primary truncate' }, cat),
                  createElement('div', { className: 'text-xs text-muted' }, count + ' questions'),
                  stats.total > 0 && createElement('div', { className: 'text-xs mt-1 ' + (stats.correct / stats.total >= 0.7 ? 'text-green-600' : 'text-orange-600') },
                    Math.round((stats.correct / stats.total) * 100) + '% mastery'
                  )
                );
              })
            ),

            // Category Progress Overview
            progress.totalAnswered > 0 && createElement('div', null,
              createElement('h3', { className: 'text-xl font-bold text-primary mb-4' }, '📊 Your Progress'),
              createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-3 mb-6' },
                categories.map(function(cat) {
                  return createElement(CategoryStatsCard, {
                    key: cat,
                    category: cat,
                    stats: progress.categoryStats[cat]
                  });
                })
              )
            ),

            // Footer
            createElement('footer', { className: 'mt-8 text-center' },
              createElement('p', { className: 'text-muted text-sm' }, '🏫 CUL 104 • Trident Technical College • Charleston, SC'),
              createElement('p', { className: 'text-muted text-xs mt-1 opacity-60' }, 'v' + APP_VERSION)
            )
          )
        );
      }

      // Quiz Screen
      function QuizScreen(props) {
        const questions = props.questions;
        const progress = props.progress;
        const onAnswer = props.onAnswer;
        const onBack = props.onBack;
        const modeName = props.modeName;

        const [currentIndex, setCurrentIndex] = useState(0);
        const [selectedAnswer, setSelectedAnswer] = useState(null);
        const [showResult, setShowResult] = useState(false);
        const [showHint, setShowHint] = useState(false);
        const [chefState, setChefState] = useState('thinking');
        const [sessionScore, setSessionScore] = useState(0);
        const [sessionAnswered, setSessionAnswered] = useState(0);

        const currentQuestion = questions[currentIndex];

        // Update chef image based on current question category when question changes
        useEffect(function() {
          if (!showResult && !showHint && currentQuestion) {
            setChefState(getCategoryImage(currentQuestion.category));
          }
        }, [currentIndex, currentQuestion]);

        function getSpeechText() {
          if (chefState === 'celebrate') return "Magnifique! You're cooking now! 🎉";
          if (chefState === 'sick') return "Oops! Let's learn from that one! 🥄";
          if (chefState === 'encourage') return "You've got this! Every chef makes mistakes. 💪";
          if (chefState === 'reading') return "Here's a helpful hint from class... 📚";
          if (chefState === 'trophy') return "Outstanding work, Chef! You've mastered this! 🏆";
          // Category-specific messages
          if (chefState === 'thermometer') return "Temperature is key to food safety! 🌡️";
          if (chefState === 'dangerzone') return "Watch out for the danger zone! ⚠️";
          if (chefState === 'timer') return "Time and temperature work together! ⏱️";
          if (chefState === 'fridge') return "Proper storage keeps food safe! 🧊";
          if (chefState === 'sanitize') return "Clean surfaces save lives! 🧼";
          if (chefState === 'spoiled') return "Know the signs of foodborne illness! 🦠";
          if (chefState === 'clipboard') return "Let's review the definitions! 📋";
          return "What's your answer, chef? 🍳";
        }

        function handleAnswer(index) {
          if (showResult) return;
          setSelectedAnswer(index);
          setShowResult(true);
          setSessionAnswered(function(p) { return p + 1; });

          var isCorrect = index === currentQuestion.correct;
          var usedHint = showHint;

          if (isCorrect) {
            setSessionScore(function(p) { return p + 1; });
            setChefState('celebrate');
          } else {
            // Show sick/spoiled image longer, then transition to encourage
            setChefState(currentQuestion.category === 'Foodborne Illness' ? 'spoiled' : 'sick');
            setTimeout(function() { setChefState('encourage'); }, 3500);
          }

          onAnswer(currentQuestion, isCorrect, usedHint);
        }

        function nextQuestion() {
          if (currentIndex < questions.length - 1) {
            setSelectedAnswer(null);
            setShowResult(false);
            setShowHint(false);
            // Next question's category image will be set by useEffect
            setCurrentIndex(function(p) { return p + 1; });
          } else {
            // Quiz complete - show trophy briefly then go back
            setChefState('trophy');
            setTimeout(function() { onBack(); }, 1500);
          }
        }

        if (!currentQuestion || questions.length === 0) {
          return createElement('div', { className: 'min-h-screen flex items-center justify-center p-6' },
            createElement('div', { className: 'card-bg rounded-2xl shadow-xl p-8 max-w-md text-center' },
              createElement('div', { className: 'text-6xl mb-4' }, '🍳'),
              createElement('h2', { className: 'text-2xl font-bold text-primary mb-2' }, 'No Questions Found'),
              createElement('p', { className: 'text-secondary mb-6' },
                'There are no questions available for "' + modeName + '". This might be because the questions haven\'t been synced with chapter data yet.'
              ),
              createElement('button', {
                onClick: onBack,
                className: 'px-6 py-3 bg-gradient-to-r from-red-600 to-orange-500 text-white font-bold rounded-xl hover:from-red-700 hover:to-orange-600 transition-all'
              }, '← Back to Home')
            )
          );
        }

        var isCorrect = selectedAnswer === currentQuestion.correct;
        var sessionAccuracy = sessionAnswered > 0 ? Math.round((sessionScore / sessionAnswered) * 100) : 0;

        // Build answer buttons
        var answerButtons = currentQuestion.options.map(function(option, index) {
          var btnClass = 'answer-btn w-full p-4 rounded-xl border-2 text-left flex items-center gap-3 ';
          if (showResult) {
            if (index === currentQuestion.correct) {
              btnClass += 'bg-green-100 border-green-500 text-green-800';
            } else if (index === selectedAnswer) {
              btnClass += 'bg-red-100 border-red-500 text-red-800';
            } else {
              btnClass += 'answer-disabled';
            }
          } else {
            btnClass += 'answer-card-default text-secondary cursor-pointer';
          }

          return createElement('button', {
            key: index,
            onClick: function() { handleAnswer(index); },
            disabled: showResult,
            className: btnClass
          },
            createElement('span', { className: 'w-8 h-8 rounded-full card-bg border-2 border-current flex items-center justify-center font-bold text-sm flex-shrink-0' },
              String.fromCharCode(65 + index)
            ),
            createElement('span', { className: 'flex-1' }, option),
            showResult && index === currentQuestion.correct && createElement('span', { className: 'text-xl' }, '✅'),
            showResult && index === selectedAnswer && index !== currentQuestion.correct && createElement('span', { className: 'text-xl' }, '❌')
          );
        });

        return createElement('div', { className: 'min-h-screen' },
          // Header
          createElement('header', { className: 'bg-gradient-to-r from-red-700 via-red-600 to-orange-600 text-white p-4 shadow-lg' },
            createElement('div', { className: 'max-w-5xl mx-auto flex items-center justify-between' },
              createElement('button', {
                onClick: onBack,
                className: 'flex items-center gap-2 hover:bg-white/10 px-3 py-1 rounded-lg transition-colors'
              },
                createElement('span', null, '←'),
                createElement('span', { className: 'hidden sm:inline' }, 'Back')
              ),
              createElement('div', { className: 'text-center' },
                createElement('h1', { className: 'brand text-xl font-bold' }, "Chef's Kitchen"),
                createElement('p', { className: 'text-orange-200 text-xs' }, modeName)
              ),
              createElement('div', { className: 'text-right' },
                createElement('div', { className: 'text-2xl font-bold' }, (currentIndex + 1) + '/' + questions.length),
                createElement('div', { className: 'text-orange-200 text-xs' }, sessionAccuracy + '% this session')
              )
            )
          ),

          // Main
          createElement('main', { className: 'max-w-5xl mx-auto p-4 md:p-6' },
            createElement('div', { className: 'grid md:grid-cols-3 gap-6' },

              // Left - Chef
              createElement('div', { className: 'md:col-span-1' },
                createElement('div', { className: 'card-bg rounded-2xl shadow-xl p-4 border-4 border-amber-200' },
                  createElement(ChefCharacter, { state: chefState }),
                  createElement('h3', { className: 'text-center font-bold text-lg text-primary mt-3' }, 'Chef Whiskers'),
                  createElement('div', { className: 'hint-section border-2 rounded-xl p-3 mt-3' },
                    createElement('p', { className: 'text-secondary text-center text-sm italic' }, getSpeechText())
                  ),
                  createElement('div', { className: 'mt-4 text-center' },
                    createElement('div', { className: 'text-sm text-muted' }, 'Session Score'),
                    createElement('div', { className: 'text-xl font-bold text-amber-700' }, sessionScore + '/' + sessionAnswered)
                  )
                )
              ),

              // Right - Quiz
              createElement('div', { className: 'md:col-span-2' },
                createElement('div', { className: 'card-bg rounded-2xl shadow-xl overflow-hidden border-4 border-amber-200' },
                  // Category header
                  createElement('div', { className: 'bg-gradient-to-r from-amber-500 to-orange-500 p-4' },
                    createElement('span', { className: 'bg-white/20 text-white px-3 py-1 rounded-full text-sm font-medium' }, currentQuestion.category)
                  ),

                  // Question
                  createElement('div', { className: 'p-6' },
                    createElement('h2', { className: 'text-xl font-bold text-primary mb-6' }, currentQuestion.question),
                    createElement('div', { className: 'space-y-3' }, answerButtons),

                    // Hint
                    !showResult && createElement('div', { className: 'mt-6' },
                      !showHint ?
                        createElement('button', {
                          onClick: function() { setShowHint(true); setChefState('reading'); },
                          className: 'text-orange-600 hover:text-orange-700 text-sm flex items-center gap-2'
                        }, createElement('span', null, '💡'), createElement('span', null, 'Need a hint?')
                        ) :
                        createElement('div', { className: 'hint-section border-2 rounded-xl p-4' },
                          createElement('p', { className: 'text-yellow-700 text-sm italic' }, '📝 ' + currentQuestion.hint)
                        )
                    ),

                    // Result
                    showResult && createElement('div', { className: 'mt-6 pt-6 border-t-2 border-amber-100' },
                      createElement('div', { className: 'p-4 rounded-xl ' + (isCorrect ? 'bg-green-50 border-2 border-green-200' : 'bg-orange-50 border-2 border-orange-200') },
                        createElement('p', { className: 'font-bold ' + (isCorrect ? 'text-green-800' : 'text-orange-800') },
                          isCorrect ? "✓ Correct!" : "✗ Not quite"
                        ),
                        createElement('p', { className: 'text-sm mt-1 ' + (isCorrect ? 'text-green-700' : 'text-orange-700') }, currentQuestion.explanation),
                        // Show encouragement for correct answers without hints
                        isCorrect && !showHint && createElement('p', { className: 'text-xs mt-2 text-green-600 font-medium bg-green-100 inline-block px-2 py-1 rounded-full' },
                          '🌟 No hint needed!'
                        )
                      ),
                      createElement('button', {
                        onClick: nextQuestion,
                        className: 'mt-4 w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg'
                      }, currentIndex < questions.length - 1 ? 'Next Question →' : 'Finish & Return Home')
                    )
                  )
                )
              )
            )
          )
        );
      }

      // ============ MAIN APP ============
      // Theme management
      const THEME_KEY = 'chefKitchenTheme';
      function getInitialTheme() {
        try {
          var saved = localStorage.getItem(THEME_KEY);
          if (saved) return saved;
        } catch (e) {}
        return 'system';
      }
      function applyTheme(theme) {
        var root = document.documentElement;
        if (theme === 'system') {
          root.removeAttribute('data-theme');
        } else {
          root.setAttribute('data-theme', theme);
        }
      }

      // Network Status Indicator Component
      function NetworkStatus(props) {
        var status = props.status;
        if (status === 'connected') {
          return createElement('div', {
            className: 'fixed top-0 left-0 right-0 z-50 bg-green-500 text-white text-center py-1 text-xs font-medium flex items-center justify-center gap-2',
            style: { fontSize: '11px' }
          },
            createElement('span', { className: 'inline-block w-2 h-2 bg-white rounded-full animate-pulse' }),
            'Live Cloud Data'
          );
        } else if (status === 'connecting') {
          return createElement('div', {
            className: 'fixed top-0 left-0 right-0 z-50 bg-yellow-500 text-white text-center py-1 text-xs font-medium flex items-center justify-center gap-2',
            style: { fontSize: '11px' }
          },
            createElement('span', { className: 'inline-block w-2 h-2 bg-white rounded-full animate-spin' }),
            'Connecting to cloud...'
          );
        } else {
          return createElement('div', {
            className: 'fixed top-0 left-0 right-0 z-50 bg-gray-500 text-white text-center py-1 text-xs font-medium flex items-center justify-center gap-2',
            style: { fontSize: '11px' }
          },
            createElement('span', { className: 'inline-block w-2 h-2 bg-orange-300 rounded-full' }),
            'Offline Mode - Using Local Data'
          );
        }
      }

      // Badge Notification Component with Confetti Explosion
      function BadgeNotification(props) {
        var badge = props.badge;
        var onClose = props.onClose;

        // No auto-dismiss - user must tap to continue

        // Generate confetti pieces
        var confettiColors = ['#f43f5e', '#ec4899', '#a855f7', '#6366f1', '#3b82f6', '#22c55e', '#eab308', '#f97316', '#ef4444'];
        var confettiShapes = ['■', '●', '▲', '★', '♦', '❤', '✦', '◆'];
        var confettiPieces = [];

        for (var i = 0; i < 150; i++) {
          var left = Math.random() * 100;
          var delay = Math.random() * 0.8;
          var duration = 2.5 + Math.random() * 2.5;
          var swayDuration = 0.5 + Math.random() * 0.5;
          var size = 10 + Math.random() * 15;
          var color = confettiColors[Math.floor(Math.random() * confettiColors.length)];
          var shape = confettiShapes[Math.floor(Math.random() * confettiShapes.length)];

          confettiPieces.push(
            createElement('div', {
              key: i,
              className: 'confetti-piece',
              style: {
                left: left + '%',
                color: color,
                fontSize: size + 'px',
                animationDuration: duration + 's, ' + swayDuration + 's',
                animationDelay: delay + 's, 0s'
              }
            }, shape)
          );
        }

        // Star burst elements around the badge
        var starBursts = [];
        for (var j = 0; j < 8; j++) {
          var angle = (j / 8) * 360;
          starBursts.push(
            createElement('div', {
              key: 'star-' + j,
              className: 'star-burst absolute text-yellow-400',
              style: {
                fontSize: '24px',
                transform: 'rotate(' + angle + 'deg) translateY(-80px)',
                animationDelay: (j * 0.1) + 's'
              }
            }, '✦')
          );
        }

        return createElement('div', {
          className: 'fixed inset-0 z-50 flex items-center justify-center p-4',
          style: { backgroundColor: 'rgba(0,0,0,0.8)' },
          onClick: onClose
        },
          // Confetti layer
          confettiPieces,

          // Main badge card
          createElement('div', {
            className: 'relative badge-pop-anim'
          },
            // Glow effect behind card
            createElement('div', {
              className: 'absolute inset-0 badge-glow-anim rounded-3xl',
              style: { transform: 'scale(1.1)' }
            }),

            // Star bursts
            createElement('div', {
              className: 'absolute inset-0 flex items-center justify-center pointer-events-none'
            }, starBursts),

            // Card content
            createElement('div', {
              className: 'relative bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 rounded-2xl p-1.5'
            },
              createElement('div', { className: 'bg-white rounded-xl p-8 text-center min-w-[280px]' },
                createElement('div', {
                  className: 'text-7xl mb-4',
                  style: { animation: 'celebrate 0.5s ease-in-out infinite' }
                }, badge.icon),
                createElement('div', { className: 'text-3xl mb-2' }, '🎉🎊🎉'),
                createElement('h3', { className: 'text-2xl font-bold text-gray-800 mb-2' }, 'Badge Unlocked!'),
                createElement('p', { className: 'text-3xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent mb-3' }, badge.name),
                createElement('p', { className: 'text-gray-600' }, badge.description),
                createElement('p', { className: 'text-xs text-gray-400 mt-4' }, 'Tap anywhere to continue')
              )
            )
          )
        );
      }

      function App() {
        const [screen, setScreen] = useState('home');
        const [progress, setProgress] = useState(loadProgress);
        const [badges, setBadges] = useState(loadBadges);
        const [newBadgeToShow, setNewBadgeToShow] = useState(null);
        const [quizQuestions, setQuizQuestions] = useState([]);
        const [modeName, setModeName] = useState('');
        const [theme, setTheme] = useState(getInitialTheme);
        const [networkStatus, setNetworkStatus] = useState(convexConnectionStatus);

        // User auth state
        const [user, setUser] = useState(loadUser);
        const [authMode, setAuthMode] = useState('choose');
        const [showIdentityCheck, setShowIdentityCheck] = useState(false);
        const [personalDevice, setPersonalDeviceState] = useState(isPersonalDevice);
        const [classStats, setClassStats] = useState(null);

        // Live test polling state
        const [activeTest, setActiveTest] = useState(null);
        const [testScreen, setTestScreen] = useState(null); // null | 'waiting' | 'active' | 'finished'
        const [testQuestions, setTestQuestions] = useState([]);
        const [testIndex, setTestIndex] = useState(0);
        const [testScore, setTestScore] = useState(0);
        const [testAnswered, setTestAnswered] = useState(0);
        const [testTimeLeft, setTestTimeLeft] = useState(0);
        const [testLeaderboard, setTestLeaderboard] = useState([]);
        const [testAnsweredIds, setTestAnsweredIds] = useState({});

        // Check if identity check is needed on mount
        useEffect(function() {
          if (user && needsIdentityCheck()) {
            setShowIdentityCheck(true);
          } else if (user) {
            updateLastActive();
          }
        }, []);

        // Fetch cloud progress on login
        useEffect(function() {
          if (!user || !CONVEX_URL) return;
          convexQuery("users:getProgress", { userId: user.userId })
            .then(function(cloudData) {
              if (cloudData) {
                var merged = mergeProgressFromCloud(progress, cloudData, badges);
                setProgress(merged.progress);
                saveProgress(merged.progress);
                setBadges(merged.badges);
                saveBadges(merged.badges);
              }
            })
            .catch(function(err) {
              console.log('Could not fetch cloud progress:', err.message);
            });
        }, [user ? user.userId : null]);

        // Fetch class stats when user is logged in
        useEffect(function() {
          if (!user || !CONVEX_URL) return;
          convexQuery("users:getClassStats")
            .then(function(stats) { setClassStats(stats); })
            .catch(function() {});
        }, [user ? user.userId : null]);

        // Poll for active tests every 3 seconds
        useEffect(function() {
          if (!user || !CONVEX_URL) return;
          var interval = setInterval(function() {
            if (testScreen === 'active') return; // Don't poll while actively testing
            convexQuery("tests:getActiveTest")
              .then(function(test) {
                if (test && test.status === 'waiting') {
                  setActiveTest(test);
                  setTestScreen('waiting');
                  // Prepare test questions from our local questionsDB
                  var tqs = [];
                  test.questionIds.forEach(function(qid) {
                    var q = questionsDB.find(function(qq) { return qq.id === qid; });
                    if (q) tqs.push(q);
                  });
                  // Shuffle them
                  tqs.sort(function() { return Math.random() - 0.5; });
                  setTestQuestions(tqs);
                  setTestIndex(0);
                  setTestScore(0);
                  setTestAnswered(0);
                  setTestAnsweredIds({});
                } else if (test && test.status === 'active') {
                  setActiveTest(test);
                  if (testScreen !== 'active' && testScreen !== 'finished') {
                    setTestScreen('active');
                    // Prepare questions if not already prepared
                    if (testQuestions.length === 0) {
                      var tqs2 = [];
                      test.questionIds.forEach(function(qid) {
                        var q = questionsDB.find(function(qq) { return qq.id === qid; });
                        if (q) tqs2.push(q);
                      });
                      tqs2.sort(function() { return Math.random() - 0.5; });
                      setTestQuestions(tqs2);
                    }
                  }
                } else if (!test && testScreen === 'waiting') {
                  // Test was cancelled
                  setTestScreen(null);
                  setActiveTest(null);
                }
              })
              .catch(function() {});
          }, 3000);
          return function() { clearInterval(interval); };
        }, [user ? user.userId : null, testScreen]);

        // Test countdown timer
        useEffect(function() {
          if (testScreen !== 'active' || !activeTest || !activeTest.endedAt) return;
          var interval = setInterval(function() {
            var remaining = Math.max(0, activeTest.endedAt - Date.now());
            setTestTimeLeft(remaining);
            if (remaining <= 0) {
              setTestScreen('finished');
              clearInterval(interval);
              // Fetch final leaderboard
              if (activeTest) {
                convexQuery("tests:getTestLeaderboard", { testId: activeTest.testId })
                  .then(function(lb) { setTestLeaderboard(lb); })
                  .catch(function() {});
              }
            }
          }, 1000);
          return function() { clearInterval(interval); };
        }, [testScreen, activeTest ? activeTest.testId : null]);

        // Listen for Convex connection status changes
        useEffect(function() {
          var unsubscribe = onConvexStatusChange(function(status) {
            setNetworkStatus(status);
          });
          return unsubscribe;
        }, []);

        // Show badge notifications from queue
        useEffect(function() {
          if (!newBadgeToShow && badges.newlyEarned && badges.newlyEarned.length > 0) {
            var nextBadge = getBadgeById(badges.newlyEarned[0]);
            if (nextBadge) setNewBadgeToShow(nextBadge);
          }
        }, [badges.newlyEarned, newBadgeToShow]);

        function dismissBadgeNotification() {
          setBadges(function(prev) {
            var remaining = prev.newlyEarned.slice(1);
            var updated = { earned: prev.earned, newlyEarned: remaining };
            saveBadges(updated);
            return updated;
          });
          setNewBadgeToShow(null);
        }

        // Apply theme on mount and when it changes
        useEffect(function() {
          applyTheme(theme);
          try {
            localStorage.setItem(THEME_KEY, theme);
          } catch (e) {}
        }, [theme]);

        function cycleTheme() {
          setTheme(function(current) {
            if (current === 'system') return 'light';
            if (current === 'light') return 'dark';
            return 'system';
          });
        }

        // ============ AUTH HANDLERS ============
        function handleAuth(userData) {
          saveUser(userData);
          setUser(userData);
          updateLastActive();
          setAuthMode('choose');
        }

        function handleLogout() {
          clearUser();
          setUser(null);
          setAuthMode('choose');
          setClassStats(null);
        }

        function handleIdentityYes() {
          setShowIdentityCheck(false);
          updateLastActive();
        }

        function handleIdentityNo() {
          setShowIdentityCheck(false);
          clearUser();
          setUser(null);
          setAuthMode('choose');
        }

        function handleTogglePersonalDevice() {
          var newVal = !personalDevice;
          setPersonalDeviceState(newVal);
          setPersonalDevice(newVal);
        }

        // ============ TEST HANDLERS ============
        function handleTestAnswer(question, selectedAnswer) {
          if (!activeTest || !user) return;
          var correct = selectedAnswer === question.correct;
          var newScore = testScore + (correct ? 1 : 0);
          var newAnswered = testAnswered + 1;
          setTestScore(newScore);
          setTestAnswered(newAnswered);

          var newAnsweredIds = Object.assign({}, testAnsweredIds);
          newAnsweredIds[question.id] = { selectedAnswer: selectedAnswer, correct: correct };
          setTestAnsweredIds(newAnsweredIds);

          // Submit to cloud immediately
          convexMutation("tests:submitAnswer", {
            testId: activeTest.testId,
            userId: user.userId,
            questionId: question.id,
            selectedAnswer: selectedAnswer,
            correct: correct
          }).catch(function(err) {
            console.log('Test answer sync failed:', err.message);
          });

          // Auto-advance after brief delay
          setTimeout(function() {
            if (testIndex < testQuestions.length - 1) {
              setTestIndex(testIndex + 1);
            } else {
              setTestScreen('finished');
              convexQuery("tests:getTestLeaderboard", { testId: activeTest.testId })
                .then(function(lb) { setTestLeaderboard(lb); })
                .catch(function() {});
            }
          }, 800);
        }

        function handleExitTest() {
          setTestScreen(null);
          setActiveTest(null);
          setTestQuestions([]);
          setTestIndex(0);
          setTestScore(0);
          setTestAnswered(0);
          setTestLeaderboard([]);
          setTestAnsweredIds({});
        }

        function handleSelectMode(mode, category) {
          var filtered = questionsDB;
          var name = 'Full Coverage';

          if (mode === 'examFocus') {
            filtered = questionsDB.filter(function(q) {
              return q.examFocus === true;
            });
            name = '\u2B50 Exam Focus';
          } else if (mode === 'basicOnly') {
            filtered = questionsDB.filter(function(q) {
              return q.examFocus === false;
            });
            name = '\uD83D\uDCD6 Basic Knowledge';
          } else if (mode === 'weak') {
            var weakCats = categories.filter(function(cat) {
              var stats = progress.categoryStats[cat];
              if (!stats || stats.total === 0) return false;
              return (stats.correct / stats.total) < 0.7;
            });
            filtered = questionsDB.filter(function(q) {
              return weakCats.indexOf(q.category) !== -1;
            });
            name = '\uD83D\uDD25 Weak Areas';
          } else if (mode === 'category' && category) {
            filtered = questionsDB.filter(function(q) {
              return q.category === category;
            });
            name = category;
          } else if (mode === 'chapter' && category) {
            filtered = questionsDB.filter(function(q) {
              return q.chapter === category;
            });
            name = '\uD83D\uDCD7 Chapter ' + category;
          } else if (mode === 'quizGroup' && category) {
            var ranges = {
              '1-4': [1, 2, 3, 4],
              '5-7': [5, 6, 7],
              '8-10': [8, 9, 10],
              '11-14': [11, 12, 13, 14],
              '15': [15]
            };
            var chapterList = ranges[category] || [];
            filtered = questionsDB.filter(function(q) {
              return chapterList.indexOf(q.chapter) !== -1;
            });
            name = '\uD83D\uDCDD Quiz ' + (category === '15' ? '(Ch 15)' : '(Ch ' + category + ')');
          } else if (mode === 'chapterRange' && category) {
            filtered = questionsDB.filter(function(q) {
              return q.chapter >= 1 && q.chapter <= category;
            });
            name = '\uD83D\uDCDA Chapters 1-' + category;
          }

          var shuffled = filtered.slice().sort(function() { return Math.random() - 0.5; });
          setQuizQuestions(shuffled);
          setModeName(name);
          setScreen('quiz');
        }

        function handleAnswer(question, isCorrect, usedHint) {
          var now = new Date();
          var hour = now.getHours();
          var day = now.getDay();

          setProgress(function(prev) {
            var newProgress = {
              totalAnswered: prev.totalAnswered + 1,
              totalCorrect: prev.totalCorrect + (isCorrect ? 1 : 0),
              categoryStats: { ...prev.categoryStats },
              chapterStats: { ...(prev.chapterStats || {}) },
              questionHistory: { ...prev.questionHistory },
              hintsUsed: prev.hintsUsed + (usedHint ? 1 : 0),
              correctWithoutHint: prev.correctWithoutHint + (isCorrect && !usedHint ? 1 : 0),
              currentNoHintStreak: (isCorrect && !usedHint) ? prev.currentNoHintStreak + 1 : 0,
              bestNoHintStreak: prev.bestNoHintStreak,
              currentStreak: isCorrect ? (prev.currentStreak || 0) + 1 : 0,
              bestStreak: prev.bestStreak || 0,
              examFocusCorrect: (prev.examFocusCorrect || 0) + (isCorrect && question.examFocus ? 1 : 0),
              studiedEarly: prev.studiedEarly || (hour < 7),
              studiedLate: prev.studiedLate || (hour >= 22),
              studiedWeekend: prev.studiedWeekend || (day === 0 || day === 6)
            };

            if (newProgress.currentNoHintStreak > newProgress.bestNoHintStreak) {
              newProgress.bestNoHintStreak = newProgress.currentNoHintStreak;
            }
            if (newProgress.currentStreak > newProgress.bestStreak) {
              newProgress.bestStreak = newProgress.currentStreak;
            }

            if (!newProgress.categoryStats[question.category]) {
              newProgress.categoryStats[question.category] = { correct: 0, total: 0 };
            }
            newProgress.categoryStats[question.category].total += 1;
            if (isCorrect) {
              newProgress.categoryStats[question.category].correct += 1;
            }

            var chapter = question.chapter || 1;
            if (!newProgress.chapterStats[chapter]) {
              newProgress.chapterStats[chapter] = { correct: 0, answered: 0 };
            }
            newProgress.chapterStats[chapter].answered += 1;
            if (isCorrect) {
              newProgress.chapterStats[chapter].correct += 1;
            }

            saveProgress(newProgress);
            updateLastActive();

            // Check for new badges
            var badgeResult = checkForNewBadges(newProgress, badges);
            if (badgeResult.newBadges.length > 0) {
              setBadges(function(prevBadges) {
                var updated = {
                  earned: prevBadges.earned.concat(badgeResult.newBadges),
                  newlyEarned: prevBadges.newlyEarned.concat(badgeResult.newBadges)
                };
                saveBadges(updated);
                // Sync badges to cloud too
                if (user) {
                  syncProgressToCloud(user.userId, newProgress, updated.earned);
                }
                return updated;
              });
            } else if (user) {
              // Sync progress to cloud (debounced)
              syncProgressToCloud(user.userId, newProgress, badges.earned);
            }

            return newProgress;
          });
        }

        function handleResetProgress() {
          if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
            var emptyProgress = {
              totalAnswered: 0,
              totalCorrect: 0,
              categoryStats: {},
              chapterStats: {},
              questionHistory: {},
              hintsUsed: 0,
              correctWithoutHint: 0,
              currentNoHintStreak: 0,
              bestNoHintStreak: 0,
              currentStreak: 0,
              bestStreak: 0,
              examFocusCorrect: 0,
              studiedEarly: false,
              studiedLate: false,
              studiedWeekend: false
            };
            setProgress(emptyProgress);
            saveProgress(emptyProgress);

            // Also ask about resetting badges
            var resetBadges = badges.earned.length > 0 && confirm('Also reset your ' + badges.earned.length + ' earned badges?');
            if (resetBadges) {
              var emptyBadges = { earned: [], newlyEarned: [] };
              setBadges(emptyBadges);
              saveBadges(emptyBadges);
            }

            // Archive and reset on cloud
            if (user && CONVEX_URL) {
              convexMutation("users:resetProgress", { userId: user.userId })
                .then(function() { console.log('Progress archived and reset on cloud'); })
                .catch(function(err) { console.log('Cloud reset failed:', err.message); });
            }
          }
        }

        function handleBack() {
          setScreen('home');
        }

        // ============ RENDER ============

        // Identity check screen (idle timeout on shared computers)
        if (user && showIdentityCheck) {
          return createElement(IdentityCheckScreen, {
            displayName: user.displayName,
            onYes: handleIdentityYes,
            onNo: handleIdentityNo
          });
        }

        // Auth screen (no user logged in)
        if (!user) {
          return createElement('div', null,
            createElement(NetworkStatus, { status: networkStatus }),
            createElement(AuthScreen, {
              mode: authMode,
              setMode: setAuthMode,
              onAuth: handleAuth
            })
          );
        }

        // Live test screen (takes over the entire app)
        if (testScreen === 'waiting' && activeTest) {
          return createElement('div', {
            className: 'min-h-screen flex items-center justify-center p-4',
            style: { backgroundColor: 'var(--bg-primary)' }
          },
            createElement(NetworkStatus, { status: networkStatus }),
            createElement('div', {
              className: 'max-w-md w-full text-center p-8 rounded-2xl shadow-lg',
              style: { backgroundColor: 'var(--bg-card)', border: '1px solid var(--border-color)' }
            },
              createElement('div', {
                className: 'text-4xl mb-4',
                style: { animation: 'gentlePulse 2s ease-in-out infinite' }
              }, '\uD83D\uDCDD'),
              createElement('h2', {
                className: 'text-2xl font-bold mb-2',
                style: { fontFamily: 'Fredoka, sans-serif', color: '#F97316' }
              }, 'Prepare for Test'),
              createElement('p', {
                className: 'text-lg font-medium mb-2',
                style: { color: 'var(--text-primary)' }
              }, activeTest.name),
              createElement('p', {
                className: 'text-sm mb-1',
                style: { color: 'var(--text-secondary)' }
              }, testQuestions.length + ' questions \u2022 ' + activeTest.timerMinutes + ' minutes'),
              createElement('p', {
                className: 'text-sm mt-4',
                style: { color: 'var(--text-muted)' }
              }, 'Waiting for professor to start'),
              createElement('div', {
                className: 'flex justify-center gap-1 mt-2'
              },
                [0,1,2].map(function(i) {
                  return createElement('div', {
                    key: i,
                    className: 'w-2 h-2 rounded-full',
                    style: {
                      backgroundColor: '#F97316',
                      animation: 'gentlePulse 1.5s ease-in-out infinite',
                      animationDelay: (i * 0.3) + 's'
                    }
                  });
                })
              )
            )
          );
        }

        if (testScreen === 'active' && activeTest && testQuestions.length > 0) {
          var currentTestQ = testQuestions[testIndex];
          var timeLeftSec = Math.ceil(testTimeLeft / 1000);
          var timeMin = Math.floor(timeLeftSec / 60);
          var timeSec = timeLeftSec % 60;
          var currentAnswerState = testAnsweredIds[currentTestQ.id];
          var isTestQAnswered = !!currentAnswerState;

          return createElement('div', {
            className: 'min-h-screen',
            style: { backgroundColor: 'var(--bg-primary)' }
          },
            createElement(NetworkStatus, { status: networkStatus }),
            // Timer bar
            createElement('div', {
              className: 'fixed top-6 left-0 right-0 z-40 flex items-center justify-center gap-4 px-4 py-2',
              style: {
                backgroundColor: timeLeftSec < 60 ? '#DC2626' : '#F97316',
                color: 'white'
              }
            },
              createElement('span', { className: 'font-bold text-lg' },
                '\u23F0 ' + timeMin + ':' + (timeSec < 10 ? '0' : '') + timeSec
              ),
              createElement('span', { className: 'text-sm' },
                'Q ' + (testIndex + 1) + '/' + testQuestions.length
              ),
              createElement('span', { className: 'text-sm font-bold' },
                'Score: ' + testScore + '/' + testAnswered
              )
            ),
            // Question area
            createElement('div', {
              className: 'max-w-2xl mx-auto pt-20 p-4'
            },
              createElement('div', {
                className: 'p-6 rounded-xl mb-4',
                style: { backgroundColor: 'var(--bg-card)', border: '1px solid var(--border-color)' }
              },
                createElement('p', {
                  className: 'text-xs font-medium mb-2 px-2 py-1 rounded-full inline-block',
                  style: { backgroundColor: '#FFF7ED', color: '#EA580C' }
                }, currentTestQ.category),
                createElement('h3', {
                  className: 'text-lg font-bold mb-4',
                  style: { color: 'var(--text-primary)' }
                }, currentTestQ.question),
                createElement('div', { className: 'space-y-2' },
                  currentTestQ.options.map(function(opt, idx) {
                    var letter = ['A', 'B', 'C', 'D'][idx];
                    var isSelected = isTestQAnswered && currentAnswerState.selectedAnswer === idx;
                    var isCorrectAnswer = idx === currentTestQ.correct;
                    var btnStyle = {};
                    if (isTestQAnswered) {
                      if (isCorrectAnswer) {
                        btnStyle = { backgroundColor: '#DCFCE7', borderColor: '#22C55E', color: '#166534' };
                      } else if (isSelected && !currentAnswerState.correct) {
                        btnStyle = { backgroundColor: '#FEE2E2', borderColor: '#EF4444', color: '#991B1B' };
                      } else {
                        btnStyle = { backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)', color: 'var(--text-muted)', opacity: 0.5 };
                      }
                    } else {
                      btnStyle = { backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)' };
                    }
                    return createElement('button', {
                      key: idx,
                      onClick: function() { if (!isTestQAnswered) handleTestAnswer(currentTestQ, idx); },
                      disabled: isTestQAnswered,
                      className: 'w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all',
                      style: Object.assign({ border: '2px solid', cursor: isTestQAnswered ? 'default' : 'pointer' }, btnStyle)
                    },
                      createElement('span', {
                        className: 'w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0',
                        style: { backgroundColor: isSelected ? (currentAnswerState.correct ? '#22C55E' : '#EF4444') : '#F97316', color: 'white' }
                      }, letter),
                      createElement('span', { className: 'text-sm' }, opt)
                    );
                  })
                )
              )
            )
          );
        }

        if (testScreen === 'finished') {
          return createElement('div', {
            className: 'min-h-screen flex items-center justify-center p-4',
            style: { backgroundColor: 'var(--bg-primary)' }
          },
            createElement(NetworkStatus, { status: networkStatus }),
            createElement('div', {
              className: 'max-w-md w-full text-center p-8 rounded-2xl shadow-lg',
              style: { backgroundColor: 'var(--bg-card)', border: '1px solid var(--border-color)' }
            },
              createElement('div', { className: 'text-4xl mb-4' }, '\uD83C\uDFC6'),
              createElement('h2', {
                className: 'text-2xl font-bold mb-2',
                style: { fontFamily: 'Fredoka, sans-serif', color: '#F97316' }
              }, 'Test Complete!'),
              createElement('p', {
                className: 'text-3xl font-bold mb-1',
                style: { color: testScore > 0 && testAnswered > 0 && (testScore/testAnswered) >= 0.7 ? '#22C55E' : '#F97316' }
              }, testScore + '/' + testAnswered),
              createElement('p', {
                className: 'text-sm mb-6',
                style: { color: 'var(--text-muted)' }
              }, testAnswered > 0 ? Math.round((testScore / testAnswered) * 100) + '% accuracy' : ''),

              // Mini leaderboard
              testLeaderboard.length > 0 && createElement('div', { className: 'mb-6 text-left' },
                createElement('h3', {
                  className: 'font-bold text-sm mb-2',
                  style: { color: 'var(--text-primary)' }
                }, 'Leaderboard'),
                testLeaderboard.slice(0, 5).map(function(entry, idx) {
                  var medals = ['\uD83E\uDD47', '\uD83E\uDD48', '\uD83E\uDD49'];
                  var isMe = user && entry.userId === user.userId;
                  return createElement('div', {
                    key: idx,
                    className: 'flex items-center justify-between py-1 px-2 rounded text-sm',
                    style: {
                      backgroundColor: isMe ? '#FFF7ED' : 'transparent',
                      fontWeight: isMe ? 'bold' : 'normal',
                      color: 'var(--text-primary)'
                    }
                  },
                    createElement('span', null, (idx < 3 ? medals[idx] : (idx + 1) + '.') + ' ' + entry.displayName),
                    createElement('span', null, entry.score + '/' + entry.totalAnswered)
                  );
                })
              ),

              createElement('button', {
                onClick: handleExitTest,
                className: 'px-6 py-3 rounded-xl font-bold text-white transition-all',
                style: { background: 'linear-gradient(135deg, #F97316, #EA580C)' }
              }, 'Return to Study')
            )
          );
        }

        // Account menu (shown in top-right corner of both screens)
        var accountMenuEl = createElement('div', {
          style: { position: 'fixed', top: '32px', right: '16px', zIndex: 100 }
        },
          createElement(AccountMenu, {
            user: user,
            theme: theme,
            onCycleTheme: cycleTheme,
            onResetProgress: handleResetProgress,
            onLogout: handleLogout,
            personalDevice: personalDevice,
            onTogglePersonalDevice: handleTogglePersonalDevice
          })
        );

        if (screen === 'quiz') {
          return createElement('div', null,
            accountMenuEl,
            newBadgeToShow && createElement(BadgeNotification, {
              badge: newBadgeToShow,
              onClose: dismissBadgeNotification
            }),
            createElement(NetworkStatus, { status: networkStatus }),
            createElement('div', { style: { paddingTop: '24px' } },
              createElement(QuizScreen, {
                questions: quizQuestions,
                progress: progress,
                modeName: modeName,
                onAnswer: handleAnswer,
                onBack: handleBack
              })
            )
          );
        }

        return createElement('div', null,
          accountMenuEl,
          newBadgeToShow && createElement(BadgeNotification, {
            badge: newBadgeToShow,
            onClose: dismissBadgeNotification
          }),
          createElement(NetworkStatus, { status: networkStatus }),
          createElement('div', { style: { paddingTop: '24px' } },
            createElement(HomeScreen, {
              progress: progress,
              badges: badges,
              onSelectMode: handleSelectMode,
              onResetProgress: handleResetProgress,
              theme: theme,
              onCycleTheme: cycleTheme,
              user: user,
              classStats: classStats
            })
          )
        );
      }

      // Render
      ReactDOM.createRoot(document.getElementById('root')).render(createElement(App));
    });
  </script>
</body>
</html>
